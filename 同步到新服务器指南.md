# 同步到新服务器指南

## 📋 整理完成情况

### ✅ 已完成的清理工作

1. **配置文件清理**
   - `gen_video/config.yaml` - 已移除所有"韩立"、"凡人修仙传"等特定领域内容
   - 路径改为通用名称（`character_mid.png`、`character_1024`等）
   - 提示词改为通用描述或留空（由代码动态生成）

2. **文档清理**
   - `盈利策略与对外服务建议.md` - 已移除特定角色名称
   - `商业化方案分析报告.md` - 已移除特定领域描述
   - `测试场景使用说明.md` - 已更新为通用描述

3. **测试数据**
   - 创建了 `test_scenes_generic.json` - 通用测试场景（移除特定角色）

## 📦 需要同步的内容

### 核心代码和配置
- ✅ `gen_video/` - 核心代码目录（已清理）
- ✅ `gen_video/config.yaml` - 配置文件（已清理）
- ✅ `gen_video/character_profiles.yaml` - 角色模板（需要检查）
- ✅ `ComfyUI/` - ComfyUI相关代码
- ✅ `InstantID/` - InstantID相关代码
- ✅ `CosyVoice/` - 配音相关代码
- ✅ `RIFE/` - 插帧相关代码

### 模型文件（大文件，可能需要单独传输）
- `gen_video/models/` - 模型文件目录
  - LoRA模型
  - SDXL模型
  - InstantID模型
  - Real-ESRGAN模型
  - 其他模型文件
  - **注意**：同步前建议先运行 `cleanup_models.sh` 清理不需要的模型，节省存储空间

### 示例数据（可选）
- `renjie/` - 特定领域示例数据（可移动到 `examples/` 或 `archive/`）
- `lingjie/` - 特定领域示例数据（可移动到 `examples/` 或 `archive/`）
- `gen_video/reference_image/` - 参考图像（特定领域的可移动到 `examples/`）

### 输出文件（通常不需要同步）
- `outputs/` - 生成结果（通常不需要同步）
- `processed/` - 处理后的数据（通常不需要同步）
- `temp/` - 临时文件（不需要同步）

## 🧹 同步前清理（重要）

### 清理不需要的模型文件

为了节省存储空间（特别是Cloudflare等按存储计费的平台），建议先清理不需要的模型：

```bash
# 运行清理脚本
bash cleanup_models.sh

# 或完整清理（包括可选模型）
bash cleanup_models.sh --remove-optional
```

**预计可节省：6-9GB**

详细说明请参考：`模型清理指南.md`

## 🚀 同步步骤

### 方法1：使用 rsync（推荐）

```bash
# 从当前服务器同步到新服务器
rsync -av --progress --partial \
  --no-perms --no-owner --no-group \
  --exclude='__pycache__' --exclude='*.pyc' --exclude='*.log' \
  --exclude='temp' --exclude='tmp' --exclude='.git' \
  --exclude='outputs' --exclude='processed' \
  --exclude='*.mp4' --exclude='*.avi' --exclude='*.mov' \
  /vepfs-dev/shawn/vid/fanren/ \
  user@new-server:/path/to/fanren/
```

### 方法2：使用 tar + scp（适合大文件）

```bash
# 1. 打包（排除不需要的文件）
cd /vepfs-dev/shawn/vid/fanren
tar -czf fanren_backup.tar.gz \
  --exclude='__pycache__' \
  --exclude='*.pyc' \
  --exclude='*.log' \
  --exclude='temp' \
  --exclude='tmp' \
  --exclude='.git' \
  --exclude='outputs' \
  --exclude='processed' \
  --exclude='*.mp4' \
  --exclude='*.avi' \
  .

# 2. 传输到新服务器
scp fanren_backup.tar.gz user@new-server:/path/to/

# 3. 在新服务器上解压
ssh user@new-server
cd /path/to/
tar -xzf fanren_backup.tar.gz
```

### 方法3：使用 git（如果已初始化git）

```bash
# 1. 提交所有更改
cd /vepfs-dev/shawn/vid/fanren
git add .
git commit -m "清理特定领域内容，准备同步到新服务器"

# 2. 推送到远程仓库
git push origin main

# 3. 在新服务器上克隆
git clone <repository-url> /path/to/fanren
```

## ⚠️ 注意事项

### 1. 大文件处理
- 模型文件可能很大（几十GB），建议：
  - 使用 `rsync` 的 `--partial` 选项支持断点续传
  - 或者先同步代码，模型文件单独传输
  - 或者在新服务器上重新下载模型

### 2. 路径配置
- 新服务器上的路径可能不同，需要更新：
  - `gen_video/config.yaml` 中的路径
  - 环境变量
  - 脚本中的硬编码路径

### 3. 环境配置
- 确保新服务器上已安装：
  - Python 3.8+
  - CUDA（如果使用GPU）
  - 所有依赖包（`requirements.txt`）
  - Conda环境（如果使用）

### 4. 权限问题
- 使用 `--no-perms --no-owner --no-group` 避免权限问题
- 在新服务器上可能需要重新设置权限

## 📝 同步后检查清单

- [ ] 检查配置文件路径是否正确
- [ ] 检查模型文件是否完整
- [ ] 测试图像生成功能
- [ ] 测试视频生成功能
- [ ] 测试配音功能
- [ ] 检查日志文件是否有错误
- [ ] 更新README中的路径说明

## 🔧 快速测试

```bash
# 在新服务器上测试
cd /path/to/fanren
python check_environment.py  # 检查环境
python test_scenes_quality.py  # 测试场景生成
```

---

**最后更新**：2024年

