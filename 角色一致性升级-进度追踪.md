# 角色一致性升级 - 进度追踪

> 最后更新: 2025-12-19 01:00

## 📊 总体进度

```
██████████████████████ 100% 基础完成 / M6 收尾中
```

| 阶段 | 状态 | 进度 |
|------|------|------|
| 1. 架构设计 | ✅ 完成 | 100% |
| 2. 模型下载 | ✅ 完成 | 100% |
| 3. 核心开发 | ✅ 完成 | 100% |
| 4. 角色档案准备 | ✅ 完成 | 100% |
| 5. 测试验证 | ✅ 完成 | 100% |
| 6. 参数调优 | ✅ 完成 | 100% |
| 7. 系统集成 | ✅ 完成 | 100% |
| 8. 批量测试 | ✅ 完成 | 100% |
| 9. Prompt 增强 | ✅ 完成 | 100% |
| 10. 质量评估模块 | ✅ 完成 | 100% |
| 11. 性能优化模块 | ✅ 完成 | 100% |
| 12. 视频身份保持 (M6) | ✅ 完成 | 100% |

---

## 📅 本周任务 (12/16 - 12/22)

### 已完成 ✅

- [x] 分析业界成熟产品架构（豆包/可灵/即梦/Runway）
- [x] 设计参考强度控制方案 (0-100)
- [x] 下载 PuLID-FLUX v0.9.1 模型
- [x] 下载 SAM2 Hiera Large 模型
- [x] 下载 EVA-CLIP 模型
- [x] 开发 `pulid_engine.py`
- [x] 开发 `decoupled_fusion_engine.py`
- [x] 开发 `execution_planner_v3.py`
- [x] 开发 `enhanced_image_generator.py`
- [x] 更新 `config.yaml`
- [x] 编写测试脚本
- [x] 编写技术文档
- [x] **准备韩立多角度参考图** (10张: front/side/three_quarter × 多表情)
- [x] 更新 CharacterProfile 类适配新目录结构
- [x] 角色档案系统测试通过
- [x] **质量评估模块完善** ✨
- [x] **性能优化模块** ✨

### 进行中 🔄

- [x] **视频身份保持 (M6)** - MVP 验证通过 (验证环境: HunyuanVideo 1.5 Distilled, 6 steps) ✨
  - ✅ **端到端流程跑通** (test_m6_end_to_end.py)
  - ✅ **技术难点攻克**:
    - ✅ 修复 HunyuanVideo `timestep_r` 兼容性问题（加载 pipeline 时自动兼容，避免 transformer.forward 参数不匹配）
    - 解决 GPU OOM 问题 (自动僵尸进程清理 + 智能显存Offload)
    - 优化推理时间: ~2.5分钟/视频 (Distilled + FlashAttention)
  - ✅ **身份验证通过**:
    - 平均相似度: **0.955** (远超 0.7 阈值)
    - 漂移率: 0.0%
    - 人脸检测率: 100%
  - ✅ 核心组件开发 (`VideoIdentityAnalyzer`, `VideoIdentityVerifier`, `ShotLanguageAdvisor`, `EnhancedVideoGeneratorM6`)
  - ✅ 验证阈值与采样参数配置化（`config.yaml` → `video.identity_verification`）
  - ✅ HunyuanVideo `negative_prompt` 链路修复（增强模式的稳定性 negative prompt 可生效）
  - ✅ M6 端到端脚本增强（CLI 参数 + 报告输出标准化，便于回归）
  - ✅ 新增批量场景测试脚本 `test_m6_scenarios.py`（多场景/多镜头/多运动强度，一键汇总报告）
  - ✅ 回归套件分层就绪（`low_risk / medium_risk / high_risk`）
    - low_risk（quick）: 6/6 通过（见 `gen_video/outputs/m6_low_risk_regression/summary_20251218_105509.md`）
    - medium_risk 走路/转身（quick）: 6/6 通过（见 `gen_video/outputs/m6_medium_risk_walk_turn/summary_20251218_110543.md`）
    - high_risk（非 quick, 120帧/25步）: **4/4 通过**（full summary：`gen_video/outputs/m6_high_risk_nonquick_full/summary_full_20251218_185101.md`）
  - ✅ 战斗/动态场景稳定性增强：重试时自动变 seed + 降低 motion 强度 + 增加步数（避免尾段崩脸）
  - ✅ 分层调参策略落地（按 min_similarity / drift_ratio / face_detect_ratio 分档调参，自动救回高风险场景）
  - ✅ “最终输出文件”一致性修复：通过验证的 attempt 自动覆盖到原始 output_path（避免 base.mp4 崩而 attempt.mp4 正常）
  - ✅ 尾段崩脸必抓：身份分析强制包含最后 N 帧（避免采样错过尾帧问题）
  - ✅ ID-Animator 下载脚本/引擎默认路径对齐（避免“文件存在但引擎找不到”）
  - ✅ hard case 救回：`high_turn_around_face_camera` 通过 **retry_on_discard + 更激进分层调参**（步数上限 45、轻微降低 guidance、允许丢弃级兜底继续重试）
  - ✅ 阈值统计报告增强：`THRESHOLD_TUNING_REPORT_FULL.md` 输出“失败样本清单 + 失败原因”（便于定点攻坚）
  - ✅ 全套回归全绿（low/medium：quick+半快；high：非quick）：`gen_video/outputs/m6_regression_full_20251218_185420/REGRESSION_REPORT.md`（28/28）
  - ✅ 阈值推荐写回配置：`gen_video/config.yaml`（sim=0.65 / drift=0.05 / face=0.75 / min_floor=0.10；discard=0.60）
  - ✅ **PuLID 引擎路径与 fallback 修复**（2025-12-19）：
    - 修复 `pulid_engine.py` 中 PuLID 子模块路径问题（`sys.path` 正确添加 `PuLID/` 目录，确保 `import flux` 和 `from pulid.pipeline_flux import PuLIDPipeline` 成功）
    - 修复 `load_pipeline()` 的 fallback 机制：原生模式失败时自动加载 diffusers pipeline，避免 "no fallback pipeline available" 错误
    - 验证通过：`import flux OK`，`pulid_loaded=True use_native=False pipeline=FluxPipeline`（diffusers fallback 正常工作）
  
  **MVP 核心理念：避免过度集成，先跑通再优化（已达成）**

### 待开始 ⬜

- [x] **严格阈值回归（非 quick）**：用写回后的阈值跑一轮 high_risk + 战斗/遮挡强化集，确认“更严格漂移限制(0.05)”不会误伤（**10/10 全绿**，总览：`gen_video/outputs/m6_strict_threshold_nonquick_20251218_222303/REGRESSION_REPORT.md`；其中 `battle_turn_backlight_wide` 首次丢弃后触发分层调参+重试并最终通过）
- [x] **场景集扩充 + 数据沉淀**：增加真实生产 prompt 模板（战斗/高速运动/强遮挡/光照极端等），并固定为 nightly regression 集
  - nightly 套件：`python3 gen_video/test_m6_scenarios.py --suite nightly --output-dir gen_video/outputs/m6_nightly_<timestamp>`
- [x] **回归自动化**：将“全套回归 + 汇总报告”固化成一条命令（含时间戳目录、自动归档、失败样本拎出）
  - 一键命令（自动激活 venv）：`gen_video/run_m6_regression_full_with_venv.sh`
  - 纯 Python（需先激活环境）：`python3 gen_video/tools/run_m6_regression_full.py`
  - 产物：`gen_video/outputs/m6_regression_full_<timestamp>/REGRESSION_REPORT.md`，失败样本会被拎到 `gen_video/outputs/m6_regression_full_<timestamp>/_failures/`
- [ ] **产线集成**：把 M6 的 verifier 报告（summary/json）对接上层系统，形成可观测性（指标面板/报警阈值）
  - 已提供同步 API 接口（供上层接入/打点）：`POST /api/v1/m6/videos/generate`（见 `gen_video/api/main_sync.py`，产物落盘到 `outputs/api/m6/`）

### 已完成 ✅（新增）

- [x] **显存优化**：解决 OOM 问题，实现去噪阶段显存管理
- [x] **AutoEncoder 修复**：修复 dtype 属性错误
- [x] **T5 Token 限制**：从 128 提高到 256，支持更详细的 prompt
- [x] **服饰一致性增强**：实现自动检测和权重调整
- [x] **系统集成**：将 enhanced_image_generator 集成到 image_generator.py
- [x] **配置开关**：添加 enhanced_mode.enabled 配置项
- [x] **参数调优测试**：完成不同参考强度的测试，发现并修复问题
- [x] **模式选择优化**：特写/近景不使用解耦模式，直接使用 PuLID
- [x] **人脸验证优化**：在最终图像上验证，而不是中间图像
- [x] **参考强度调优**：完成远景(50%)、中景(60%)、近景(65%)的参数调优
- [x] **相似度验证**：所有测试图片相似度 ≥ 0.7，平均 0.753，通过率 100%
- [x] **图片质量分析**：创建分析脚本，完成构图、清晰度、饱和度等质量指标分析
- [x] **身份引擎统一**：所有镜头类型统一使用 PuLID，确保处理方式一致
- [x] **批量生成测试**：完成5个场景的批量测试，所有场景生成成功
- [x] **Prompt 增强**：添加表情(emotion)和动作(action)支持，修复战斗场景问题
- [x] **质量评估模块** ✨：
  - 创建 `utils/image_quality_analyzer.py` 完整模块
  - 人脸相似度检测（使用 InsightFace/antelopev2）
  - 构图分析（远景/中景/近景自动判断）
  - 技术指标评估（清晰度/饱和度/亮度/对比度/噪点）
  - 三分法构图评分
  - 综合质量评分（0-100）
  - 问题检测和优化建议生成
  - JSON 报告导出功能
  - 集成到 `enhanced_image_generator.py` 的 `_verify_quality()` 方法
- [x] **显存管理器模块** ✨：
  - 创建 `utils/memory_manager.py` 统一显存管理模块
  - 模型注册和延迟加载功能
  - 显存实时监控（分配/保留/可用）
  - 智能卸载策略（按优先级和使用时间）
  - 批量生成上下文管理器
  - 显存使用警告和危险阈值
  - 自动缓存清理
  - 集成到 `enhanced_image_generator.py`

---

## 📈 下周计划 (12/23 - 12/29)

| 任务 | 预计工时 | 负责人 | 备注 |
|------|----------|--------|------|
| 严格阈值回归（非 quick） | 6h | - | 用写回阈值跑 high_risk + 真实战斗/遮挡若干条 |
| 场景集扩充（生产 prompt 模板） | 6h | - | 新增 10-20 条并分级（low/med/high） |
| 回归自动化/归档 | 4h | - | 一键跑全套回归 + 自动生成总览报告 |
| 性能优化（加载复用/分析器缓存） | 6h | - | 降低批量回归耗时与重复加载开销 |

---

## 🎯 里程碑追踪

| 里程碑 | 目标日期 | 状态 | 备注 |
|--------|----------|------|------|
| M1: 核心开发 | 12月16日 | ✅ 完成 | PuLID/解耦/V3 |
| M2: 测试验证 | 12月20日 | ✅ 完成 | 端到端测试通过 |
| M3: 参数调优 | 12月25日 | ✅ 完成 | 参考强度已优化，相似度 0.753 |
| M4: 系统集成 | 12月31日 | ✅ 完成 | 已集成到 image_generator |
| M5: 批量生成优化 | 1月1日 | ✅ 100% | 完成批量测试脚本，支持多场景自动生成 |
| M6: 视频身份保持 | 1月15日 | ✅ 100% | 回归全绿(28/28) + 阈值落盘 + hard case 可救回 + PuLID 引擎路径/fallback 修复完成 |

---

## 📁 新增文件清单

| 文件 | 大小 | 创建日期 | 说明 |
|------|------|----------|------|
| `pulid_engine.py` | 17KB | 12/16 | PuLID 引擎 |
| `decoupled_fusion_engine.py` | 21KB | 12/16 | 解耦融合 |
| `execution_planner_v3.py` | 17KB | 12/16 | 智能路由 |
| `enhanced_image_generator.py` | 39KB | 12/17 | 整合入口（含显存管理器集成） |
| `test_enhanced_generation.py` | 10KB | 12/16 | 测试脚本 |
| `download_pulid_sam2_yolo.sh` | 11KB | 12/16 | 下载脚本 |
| `setup_character_profiles.sh` | 5KB | 12/16 | 角色目录 |
| `test_reference_strength_tuning.py` | 8KB | 12/17 | 参数调优测试脚本 |
| `optimized_prompt.txt` | 3KB | 12/17 | 优化后的 prompt 示例 |
| `FLUX_TOKEN_LIMITS.md` | 5KB | 12/17 | Flux token 限制说明文档 |
| `analyze_test_images.py` | 6KB | 12/17 | 图片质量分析脚本 |
| `outputs/reference_strength_tuning/IMAGE_ANALYSIS_REPORT.md` | 8KB | 12/17 | 图片分析报告 |
| `test_batch_generation.py` | 7KB | 12/17 | 批量生成测试脚本 |
| `utils/image_quality_analyzer.py` | 33KB | 12/17 | **图像质量分析器模块** ✨ |
| `utils/memory_manager.py` | 16KB | 12/17 | **显存管理器模块** ✨ |
| `utils/video_identity_analyzer.py` | 18KB | 12/17 | **视频身份分析器 (M6)** ✨ |
| `utils/__init__.py` | 3KB | 12/17 | Utils 包初始化（含所有导出） |
| `test_image_quality_analyzer.py` | 10KB | 12/17 | 质量分析器测试脚本 |
| `id_animator_engine.py` | 18KB | 12/17 | **ID-Animator 引擎 (M6)** ✨ |
| `download_id_animator.sh` | 4KB | 12/17 | ID-Animator 下载脚本 |
| `docs/M6_视频身份保持研究.md` | 6KB | 12/17 | M6 研究文档 |
| `test_id_animator_full.py` | 10KB | 12/18 | **ID-Animator 完整测试脚本 (M6)** ✨ |
| `tools/regression_report.py` | 8KB | 12/18 | 回归总览报告生成器（汇总各子套件 summary_*.json） |

---

## 🔧 快速命令

```bash
# 同步到服务器
rsync -avz --exclude='models/' --exclude='.git/' \
    ./ ss:/vepfs-dev/shawn/vid/fanren/

# 运行测试（增强图片生成）
cd /vepfs-dev/shawn/vid/fanren/gen_video
source /vepfs-dev/shawn/venv/py312/bin/activate
python test_enhanced_generation.py

# 运行 M6 视频身份保持测试
python test_id_animator_full.py --quick    # 快速测试
python test_id_animator_full.py            # 完整测试

# 创建角色档案目录
./setup_character_profiles.sh
```

---

## 📝 备注

- 当前使用 PuLID-FLUX v0.9.1，环境融合效果更好
- **参考强度配置**（已优化）：
  - 远景 (wide): 50% → 相似度 0.746 ✅
  - 中景 (medium): 60% → 相似度 0.755 ✅
  - 近景 (close): 65% → 相似度 0.768 ✅
- **相似度表现**：平均 0.753，通过率 100%
- SAM2 用于精确分割，YOLO 用于快速检测，可混合使用
- 所有镜头类型统一使用 PuLID，确保处理方式一致

## 🔧 技术修复记录

### PuLID 引擎路径与 Fallback 修复（2025-12-19）

**问题描述**：
- 生成带人像图片时出现 `No module named 'flux'` 错误
- 原生模式失败后出现 `RuntimeError: Native generation failed and no fallback pipeline available`

**根本原因**：
1. `pulid_engine.py` 在加载原生模式时，`sys.path` 未正确添加 `PuLID/` 目录，导致无法 `import flux` 和 `from pulid.pipeline_flux import PuLIDPipeline`
2. `load_pipeline()` 在原生模式失败后，fallback 机制不完善，未确保 diffusers pipeline 被正确加载

**修复方案**：
1. **路径修复**：在 `_load_native_pipeline()` 和 `_load_diffusers_pipeline()` 中，正确添加 PuLID 目录到 `sys.path`：
   ```python
   pulid_path = Path(__file__).parent.parent / "PuLID"
   if pulid_path.exists() and str(pulid_path) not in sys.path:
       sys.path.insert(0, str(pulid_path))
   ```

2. **Fallback 机制增强**：在 `load_pipeline()` 中，确保原生模式失败时自动加载 diffusers pipeline：
   - 原生模式加载失败时，自动设置 `use_native=False` 并调用 `_load_diffusers_pipeline()`
   - 在生成过程中如果原生模式失败，也会尝试加载 diffusers pipeline 作为备用

**验证结果**：
- ✅ `import flux OK`: `/vepfs-dev/shawn/vid/fanren/PuLID/flux/__init__.py`
- ✅ `pulid_loaded=True use_native=False pipeline=FluxPipeline`: diffusers fallback 正常工作
- ✅ 角色一致性系统可正常使用 PuLID 引擎生成带人像图片

**相关文件**：
- `gen_video/pulid_engine.py` (修复路径和 fallback 机制)

## 🎯 下一步工作

### 1. 小说推文批量生成系统（优先级：高）✅
- ✅ **批量生成脚本**（2025-12-19）：
  - 创建 `tools/batch_novel_generator.py`，支持 JSON 场景文件批量处理
  - 支持断点续传、错误重试、进度追踪
  - 自动生成详细报告（JSON + Markdown）
- ✅ **场景模板库**（2025-12-19）：
  - 创建 `templates/novel_scene_templates.yaml`，包含战斗/修炼/对话/探索等常见场景
  - 提供标准化的 prompt 和参数配置
- 🔄 **优化生成流程**（进行中）：
  - 显存管理优化
  - 错误重试机制增强
  - 进度追踪完善
- ⬜ **生成报告系统**（待开始）：
  - 成功率统计
  - 质量分析
  - 失败原因分析

### 2. 严格阈值回归（优先级：高）
- 用写回阈值（sim=0.65 / drift=0.05 / face=0.75 / min_floor=0.10）跑非 quick 回归
- 重点关注：高风险转身/遮挡/快速运动，确保不会误杀

### 3. 回归体系化（优先级：高）
- 维护固定 nightly regression 场景集（分级 + 版本化）
- 强化报告：失败样本自动聚合、失败原因分桶、趋势对比（对比上次）

### 4. 性能与产线可观测性（优先级：中）
- 批量生成时的模型加载复用、分析器缓存、减少重复初始化
- 上层系统接入 summary/report，形成指标可观测与报警

### 5. 角色一致性系统稳定性（已完成 ✅）
- **PuLID 引擎路径修复**（2025-12-19）：
  - 修复 `pulid_engine.py` 中 PuLID 子模块路径问题，确保 `import flux` 和 `from pulid.pipeline_flux import PuLIDPipeline` 成功
  - 修复 `load_pipeline()` 的 fallback 机制：原生模式失败时自动加载 diffusers pipeline，避免 "no fallback pipeline available" 错误
  - 验证通过：`import flux OK`，`pulid_loaded=True use_native=False pipeline=FluxPipeline`（diffusers fallback 正常工作）
- **姿态控制优化**（2025-12-19）：
  - 创建 `PostureController` 模块，显式控制姿态（lying/sitting/standing 等）
  - 优化 LLM 场景分析，一次性返回所有信息（包括精确的姿态描述）
  - 修复 Execution Planner V3，确保姿态指令放在 prompt 最前面（最高优先级）

---

*每日更新进度，保持项目可追踪*
