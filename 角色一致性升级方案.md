# AI视频生成系统 - 角色一致性升级方案

> 📅 创建日期: 2025年12月16日  
> 📝 状态: 开发中  
> 🎯 目标: 解决"人脸一致性 vs 环境丰富度"矛盾

---

## 一、项目背景

### 1.1 当前痛点

在小说推文视频生成中，面临核心矛盾：

| 问题 | 表现 | 原因 |
|------|------|------|
| **身份-场景权衡** | 提高人脸一致性 → 环境细节丢失 | IP-Adapter scale 过高（0.9）压制环境 |
| | 丰富环境描述 → 人脸变形 | InstantID/IP-Adapter 权重过低 |
| **单一参考图** | 不同角度人脸变形 | 只用一张正面参考图 |
| **视频阶段漂移** | 图转视频后人脸变化 | 缺少视频阶段的身份保持 |

### 1.2 市场背景

- **市场规模**: AI视频生成千亿级别，微短剧用户基数庞大
- **竞争格局**: 豆包、可灵、即梦、Runway、Pika 等产品成熟
- **时间窗口**: 2025年12月仍有前景，但需要差异化竞争力

---

## 二、解决方案概述

### 2.1 核心策略

参考业界成熟产品（豆包、可灵、即梦、Runway），采用 **三层架构**：

```
┌─────────────────────────────────────────────────────────────────┐
│                    Execution Planner V3                          │
│                (智能路由 + 参考强度控制 0-100)                    │
├─────────────────────────────────────────────────────────────────┤
│         │                    │                    │              │
│         ▼                    ▼                    ▼              │
│  ┌─────────────┐    ┌──────────────┐    ┌─────────────────┐    │
│  │   PuLID     │    │ 解耦融合引擎  │    │ 角色档案系统    │    │
│  │   Engine    │    │ (SAM2+YOLO)  │    │ (多参考图)      │    │
│  └─────────────┘    └──────────────┘    └─────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 关键技术点

1. **参考强度控制 (0-100)**
   - 远景: 20-40%，环境优先
   - 中景: 50-70%，平衡
   - 特写: 75-90%，人脸优先

2. **解耦生成流水线**
   - 阶段1: 完整场景生成（无身份约束）
   - 阶段2: SAM2/YOLO 检测人物区域
   - 阶段3: PuLID 在区域内注入身份
   - 阶段4: 边缘自然融合

3. **多参考图系统**
   - 正面、侧面、3/4 角度参考图
   - 表情库（喜怒哀乐）
   - 根据场景自动选择

---

## 三、技术架构

### 3.1 模块设计

```
gen_video/
├── pulid_engine.py              # PuLID-FLUX 身份保持引擎
├── decoupled_fusion_engine.py   # 解耦融合引擎 (SAM2 + YOLO)
├── execution_planner_v3.py      # 智能路由系统 V3
├── enhanced_image_generator.py  # 整合入口模块
├── test_enhanced_generation.py  # 测试脚本
├── download_pulid_sam2_yolo.sh  # 模型下载脚本
├── setup_character_profiles.sh  # 角色档案目录创建
└── config.yaml                  # 配置文件 (已更新)
```

### 3.2 数据流

```
输入: Scene JSON
        │
        ▼
┌──────────────────────────────────────────────────────────────┐
│                   Execution Planner V3                        │
│  分析场景 → 计算参考强度 → 选择引擎 → 选择参考图 → 决定解耦   │
└──────────────────────────────────────────────────────────────┘
        │
        ▼ GenerationStrategy
        │
   ┌────┴────┐
   │         │
   ▼         ▼
解耦模式   标准模式
   │         │
   ▼         ▼
┌───────┐  ┌───────────┐
│ Flux  │  │  PuLID    │
│场景生成│  │ 直接生成  │
└───┬───┘  └─────┬─────┘
    │            │
    ▼            │
┌───────┐        │
│ SAM2  │        │
│ 检测  │        │
└───┬───┘        │
    │            │
    ▼            │
┌───────┐        │
│ PuLID │        │
│ 注入  │        │
└───┬───┘        │
    │            │
    ▼            ▼
┌──────────────────────┐
│    质量验证          │
│ (人脸相似度检查)     │
└──────────────────────┘
        │
        ▼
输出: 生成的图像
```

### 3.3 参考强度映射

| 镜头类型 | 基础强度 | 角度调整 | 表情调整 | 最终范围 |
|----------|----------|----------|----------|----------|
| `extreme_wide` | 20% | 俯拍-20% | - | 0-20% |
| `wide` | 30% | 俯拍-20% | - | 10-30% |
| `full` | 45% | - | 怒+10% | 45-55% |
| `medium` | 60% | - | 痛苦+15% | 60-75% |
| `close` | 80% | 仰拍+10% | 怒+10% | 80-100% |
| `extreme_close` | 90% | 仰拍+10% | - | 90-100% |

---

## 四、已完成工作

### 4.1 模型下载 ✅

| 模型 | 状态 | 路径 |
|------|------|------|
| PuLID-FLUX v0.9.1 | ✅ 已下载 | `models/pulid/` |
| SAM2 Hiera Large | ✅ 已下载 | `models/sam2/` |
| EVA-CLIP | ✅ 已下载 | `models/clip/` |
| AntelopeV2 | ✅ 已有 | `models/antelopev2/` |
| YOLO | ✅ 自动下载 | ultralytics 管理 |

### 4.2 代码开发 ✅

| 模块 | 状态 | 说明 |
|------|------|------|
| `pulid_engine.py` | ✅ 17KB | PuLID 引擎封装 |
| `decoupled_fusion_engine.py` | ✅ 21KB | 解耦融合实现 |
| `execution_planner_v3.py` | ✅ 17KB | 智能路由系统 |
| `enhanced_image_generator.py` | ✅ 18KB | 整合入口 |
| `config.yaml` | ✅ 更新 | 添加新配置 |

### 4.3 配置更新 ✅

在 `config.yaml` 中添加：
- PuLID 配置（模型路径、参数、参考强度映射）
- 解耦融合配置（SAM2路径、检测方法、融合参数）
- Execution Planner V3 配置（引擎选择策略）
- 角色档案系统配置（多参考图支持）

---

## 五、待完成工作

### 5.1 短期任务 (1-2 周)

| 任务 | 优先级 | 预计工时 | 说明 |
|------|--------|----------|------|
| 准备韩立多角度参考图 | P0 | 2小时 | 从现有素材中提取或生成 |
| 端到端测试 | P0 | 4小时 | 验证完整生成流程 |
| 参数调优 | P1 | 8小时 | 根据实际效果调整参考强度映射 |
| 与现有 image_generator.py 集成 | P1 | 4小时 | 作为可选增强模式 |

### 5.2 中期任务 (2-4 周)

| 任务 | 优先级 | 预计工时 | 说明 |
|------|--------|----------|------|
| 视频阶段身份保持 | P1 | 16小时 | 研究 ID-Animator 或 FaceID + AnimateDiff |
| 批量生成优化 | P2 | 8小时 | 多场景共享身份嵌入 |
| 质量评估自动化 | P2 | 8小时 | 自动检测并重试低质量结果 |
| StoryDiffusion 集成 | P2 | 16小时 | 多场景叙事一致性 |

### 5.3 长期任务 (1-3 月)

| 任务 | 优先级 | 预计工时 | 说明 |
|------|--------|----------|------|
| Custom LoRA 训练流水线 | P2 | 40小时 | 用户专属角色 LoRA |
| Web 界面集成 | P2 | 16小时 | 参考强度可视化控制 |
| 多角色支持 | P2 | 24小时 | 场景中多个一致性角色 |

---

## 六、进度计划

### 6.1 甘特图

```
2025年12月
Week 3 (16-22)  Week 4 (23-29)  Week 5 (30-5)
    │               │               │
    ▼               ▼               ▼
┌──────────────────────────────────────────────────────────────┐
│ ✅ 模型下载                                                   │
├────┤                                                          │
│ ✅ 核心模块开发                                               │
├────────┤                                                      │
│ 🔄 多角度参考图准备                                            │
│    ├───┤                                                      │
│ 🔄 端到端测试                                                  │
│    ├───────┤                                                  │
│    参数调优                                                   │
│        ├───────────┤                                          │
│    与现有系统集成                                              │
│            ├───────┤                                          │
│    视频阶段身份保持 (研究)                                     │
│                ├───────────────────┤                          │
└──────────────────────────────────────────────────────────────┘

✅ 已完成  🔄 进行中  ⬜ 待开始
```

### 6.2 里程碑

| 日期 | 里程碑 | 交付物 |
|------|--------|--------|
| 12月16日 | M1: 核心开发完成 | ✅ PuLID/解耦融合/V3 模块 |
| 12月20日 | M2: 测试验证 | 端到端测试通过 |
| 12月25日 | M3: 参数调优 | 最佳参数配置 |
| 12月31日 | M4: 系统集成 | 与现有流程集成 |
| 1月15日 | M5: 视频身份保持 | 图转视频阶段不变脸 |

---

## 七、配置参考

### 7.1 PuLID 配置 (`config.yaml`)

```yaml
image:
  pulid:
    enabled: true
    model_path: /path/to/models/pulid/PuLID-FLUX-v0.9.1.safetensors
    flux_path: /path/to/models/flux1-dev
    width: 768
    height: 1152
    num_inference_steps: 28
    guidance_scale: 3.5
    default_reference_strength: 60
    reference_strength_map:
      extreme_wide: 20
      wide: 30
      full: 45
      medium: 60
      close: 80
      extreme_close: 90
```

### 7.2 解耦融合配置

```yaml
  decoupled_fusion:
    enabled: true
    sam2_path: /path/to/models/sam2
    detection_method: auto
    feather_radius: 10
    mask_padding: 20
    verify_face_similarity: true
    similarity_threshold: 0.7
```

### 7.3 Execution Planner V3 配置

```yaml
  execution_planner:
    version: 3
    enabled: true
    engine_selection:
      close_shots: instantid
      medium_shots: pulid
      wide_shots: flux
    auto_decoupled: true
    decoupled_threshold:
      max_reference_strength: 50
      shot_types: ["extreme_wide", "wide", "full"]
```

---

## 八、使用指南

### 8.1 快速开始

```python
from enhanced_image_generator import EnhancedImageGenerator

# 初始化
gen = EnhancedImageGenerator("config.yaml")

# 定义场景
scene = {
    "camera": {"shot": "medium", "angle": "eye_level"},
    "character": {"present": True, "emotion": "neutral"},
    "environment": {"description": "ancient temple with misty mountains"}
}

# 生成
image = gen.generate_scene(scene, face_reference="reference.jpg")
image.save("output.png")
```

### 8.2 运行测试

```bash
cd /vepfs-dev/shawn/vid/fanren/gen_video
source /vepfs-dev/shawn/venv/py312/bin/activate

# 基础测试（不生成图像）
python test_enhanced_generation.py

# 完整测试（包括图像生成）
python test_enhanced_generation.py --full
```

### 8.3 创建角色档案

```bash
chmod +x setup_character_profiles.sh
./setup_character_profiles.sh /path/to/character_profiles
```

---

## 九、风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| PuLID 效果不如预期 | 中 | 保留 InstantID 作为备选 |
| SAM2 分割不精确 | 低 | 使用 YOLO 边界框 + 羽化边缘 |
| 显存不足 | 中 | CPU offload + 模型交替加载 |
| 参数调优耗时 | 低 | 准备多组预设配置 |

---

## 十、参考资料

- [PuLID GitHub](https://github.com/ToTheBeginning/PuLID)
- [SAM2 GitHub](https://github.com/facebookresearch/sam2)
- [豆包 Seedream 技术介绍](https://www.volcengine.com/docs/6791/1347953)
- [可灵 Element Library](https://klingai.com)
- [即梦 Dreamina](https://jimeng.jianying.com)

---

> 📝 文档维护: 请在每次重大更新后更新此文档  
> 📧 联系: [项目负责人]
