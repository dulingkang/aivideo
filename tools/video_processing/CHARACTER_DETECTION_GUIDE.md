# 人像检测和AI生成策略指南

## 关键发现

### 带人像的场景AI生成容易有问题
- ❌ **人脸不像**：AI生成的人脸质量不稳定
- ❌ **人物形象不准确**：角色外观可能不符合预期
- ❌ **风格不一致**：多个人物场景风格可能不统一

### 纯环境场景AI生成效果好
- ✅ **环境渲染质量高**：AI擅长渲染环境
- ✅ **不涉及人脸问题**：纯环境没有人物
- ✅ **适合AI生成**：效果好，稳定

## 智能决策策略

### 策略1: 包含人像的场景
**决策**: 优先使用检索场景（即使检索分数较低）

**理由**:
- 避免AI生成人脸不像的问题
- 保证人脸质量和一致性
- 原番视频中的人物更真实

**处理方式**:
- 检索分数 >= 0.7 → 直接使用
- 检索分数 0.3-0.7 → 仍然使用（避免AI生成人脸问题）
- 检索分数 < 0.3 → 警告，但建议尝试使用检索场景

### 策略2: 纯环境场景
**决策**: 适合AI生成

**理由**:
- 不涉及人脸问题
- AI生成环境效果很好
- 可以创建原番中没有的场景

**处理方式**:
- 检索分数高 → 使用检索场景
- 检索分数低 → AI生成

## 决策流程

```
narration文本
    ↓
检测是否包含人像
    ↓
包含人像？
    ├─ 是 → 优先使用检索场景（即使分数低）
    │       避免AI生成人脸不像的问题
    └─ 否 → 纯环境场景
            ├─ 检索分数高 → 使用检索
            └─ 检索分数低 → AI生成（效果好）
```

## 人像关键词检测

### 检测的关键词

**角色相关**:
- 角色名称：主角、韩立、修士、弟子、真人、道人
- 人称代词：我、他、她、我们、他们
- 角色描述：人物、角色、主人公

**动作相关**（明确涉及人）:
- 持续动作：站着、坐着、走着、看着、说着、拿着
- 身体部位：脸、面容、表情、眼神、手、手臂、身影

### 排除的关键词

**纯环境指示**:
- 只有环境、纯环境、无人物、仅环境、环境场景、空场景

## 使用示例

### 示例1: 包含人像的场景
```
Narration: "这是我宗的身份令牌"
检测: 包含"我" → 人像场景
决策: 优先使用检索场景（即使分数只有0.3）
原因: 避免AI生成人脸不像的问题
```

### 示例2: 纯环境场景
```
Narration: "洞府内的环境"
检测: 纯环境（无人物关键词）
决策: 如果检索分数低，使用AI生成
原因: 纯环境场景，AI生成效果好
```

### 示例3: 明确的人像场景
```
Narration: "韩立拿着令牌站在洞府内"
检测: 包含"韩立"、"拿着"、"站着" → 明确人像场景
决策: 强制使用检索场景
原因: 包含明确的人物和动作，避免AI生成人脸问题
```

## 配置选项

### 默认行为（推荐）
- `avoid_ai_for_characters=True`: 避免AI生成包含人像的场景
- 包含人像的场景优先使用检索结果

### 允许AI生成人像（不推荐）
```bash
--allow-ai-for-characters  # 允许AI生成包含人像的场景
```

**注意**: 不推荐使用，因为AI生成人脸容易不像。

## 统计输出

决策完成后，会显示统计信息：

```
决策统计:
  使用检索场景: 8 个 (80.0%)
    - 其中包含人像（强制检索）: 5 个
  需要AI生成: 2 个 (20.0%)
    - 纯环境场景（适合AI生成）: 2 个
```

## 最佳实践

1. **默认设置**: 使用 `avoid_ai_for_characters=True`（默认）
2. **检查决策结果**: 查看 `scene_decisions.json` 中的决策
3. **手动调整**: 如果某个场景决策不合适，可以手动修改
4. **优先检索**: 对于包含人像的场景，即使检索分数低也优先使用检索结果

