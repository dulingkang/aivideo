# Scene_007 å’Œ Scene_012 é—®é¢˜åˆ†ææŠ¥å‘Š

## é—®é¢˜æ¦‚è¿°

1. **scene_007.png**: å‡ºç°äº†å¦å…‹ï¼ˆä¸æ­£å¸¸ï¼‰
2. **scene_012.png**: å‡ºç°äº†10ä¸ªä¸€æ ·çš„äººï¼ˆä¸æ­£å¸¸ï¼‰

## è¯¦ç»†åˆ†æ

### Scene_007 é—®é¢˜åˆ†æ

#### æœŸæœ›çš„åœºæ™¯æè¿°
- **character_pose**: Head tilted,face partially visible,facing camera angle
- **composition**: Han Li strains to tilt his head,sees endless gray-green gravel
- **camera**: Wide pan
- **action**: Turning head

#### å®é™…ä½¿ç”¨çš„Prompt
```
(warm orange tones:1.2), (vast golden desert:1.3), (male:1.8), xianxia fantasy, (gravel:1.70), (strains, tilt, endless:1.8), (Straining to tilt head, facing camera, front view:1.8)
```

#### é—®é¢˜æ ¹æº

1. **æ™ºèƒ½ä¼˜åŒ–ç§»é™¤äº†å•äººçº¦æŸ**
   - æ—¥å¿—æ˜¾ç¤ºï¼š`âœ“ äººç‰©åœºæ™¯ï¼šåœ¨promptæœ€å‰é¢æ·»åŠ å•äººçº¦æŸï¼ˆæƒé‡2.0ï¼Œé˜²æ­¢å¤šä¸ªäººç‰©ï¼‰`
   - ä½†æ™ºèƒ½ä¼˜åŒ–åï¼š`ğŸ§  æ™ºèƒ½ä¼˜åŒ–: ä» 15 ä¸ªéƒ¨åˆ†ç²¾ç®€è‡³ 6 ä¸ªéƒ¨åˆ†`
   - **å•äººçº¦æŸåœ¨ä¼˜åŒ–è¿‡ç¨‹ä¸­è¢«ç§»é™¤äº†ï¼**

2. **ç¼ºå°‘æ˜ç¡®çš„æ’é™¤é¡¹**
   - Promptä¸­æ²¡æœ‰ `no vehicles, no tanks, no military equipment` ç­‰æ’é™¤é¡¹
   - "gravel"ï¼ˆæ²™ç ¾ï¼‰å¯èƒ½è¢«æ¨¡å‹è¯¯è§£ä¸ºå†›äº‹åœºæ™¯

3. **Promptä¼˜åŒ–å™¨çš„é—®é¢˜**
   - ä¼˜åŒ–å™¨åœ¨ç²¾ç®€promptæ—¶ï¼Œå¯èƒ½å°†å•äººçº¦æŸè§†ä¸º"ä½é‡è¦æ€§"å†…å®¹è€Œç§»é™¤
   - éœ€è¦ç¡®ä¿å•äººçº¦æŸåœ¨ä¼˜åŒ–æ—¶å…·æœ‰æœ€é«˜ä¼˜å…ˆçº§ï¼Œä¸èƒ½è¢«ç§»é™¤

### Scene_012 é—®é¢˜åˆ†æ

#### æœŸæœ›çš„åœºæ™¯æè¿°
- **composition**: Monstrous birds dive to thirty-plus zhang above ground,targeting Han Li
- **camera**: Low-angle birds
- **action**: åº”è¯¥æ˜¯éŸ©ç«‹é¢å¯¹æ€ªé¸Ÿçš„åœºæ™¯

#### å®é™…ä½¿ç”¨çš„Prompt
```
(warm orange tones:1.2), (vast golden desert:1.3), (male:1.8), xianxia fantasy, (Monstrous birds dive to thirty-plus zhang above ground,targeting Han Li:1.80), (consistent background:1.2)
```

#### é—®é¢˜æ ¹æº

1. **æ™ºèƒ½ä¼˜åŒ–ç§»é™¤äº†å•äººçº¦æŸ**
   - æ—¥å¿—æ˜¾ç¤ºï¼š`âœ“ äººç‰©åœºæ™¯ï¼šåœ¨promptæœ€å‰é¢æ·»åŠ å•äººçº¦æŸï¼ˆæƒé‡2.0ï¼Œé˜²æ­¢å¤šä¸ªäººç‰©ï¼‰`
   - ä½†æ™ºèƒ½ä¼˜åŒ–åï¼š`ğŸ§  æ™ºèƒ½ä¼˜åŒ–: ä» 12 ä¸ªéƒ¨åˆ†ç²¾ç®€è‡³ 5 ä¸ªéƒ¨åˆ†`
   - **å•äººçº¦æŸåœ¨ä¼˜åŒ–è¿‡ç¨‹ä¸­è¢«ç§»é™¤äº†ï¼**

2. **Promptä¸­æ²¡æœ‰å•äººçº¦æŸ**
   - æœ€ç»ˆpromptä¸­å®Œå…¨æ²¡æœ‰ `single person, only one character` ç­‰çº¦æŸ
   - å¯¼è‡´æ¨¡å‹ç”Ÿæˆäº†å¤šä¸ªäººç‰©

3. **åœºæ™¯æè¿°å¯èƒ½è¢«è¯¯è§£**
   - "Monstrous birds dive... targeting Han Li" å¯èƒ½è¢«ç†è§£ä¸º"å¤šä¸ªäººè¢«é¸Ÿæ”»å‡»"
   - éœ€è¦æ›´æ˜ç¡®åœ°å¼ºè°ƒ"åªæœ‰éŸ©ç«‹ä¸€ä¸ªäºº"

## æ ¸å¿ƒé—®é¢˜

### Promptä¼˜åŒ–å™¨çš„ç¼ºé™·

**é—®é¢˜**ï¼š`PromptOptimizer` åœ¨ç²¾ç®€promptæ—¶ï¼Œå°†å•äººçº¦æŸè§†ä¸ºå¯ç§»é™¤çš„å†…å®¹ã€‚

**è¯æ®**ï¼š
- scene_007: ä»15ä¸ªéƒ¨åˆ†ç²¾ç®€åˆ°6ä¸ªéƒ¨åˆ†ï¼Œå•äººçº¦æŸè¢«ç§»é™¤
- scene_012: ä»12ä¸ªéƒ¨åˆ†ç²¾ç®€åˆ°5ä¸ªéƒ¨åˆ†ï¼Œå•äººçº¦æŸè¢«ç§»é™¤

**å½±å“**ï¼š
- æ‰€æœ‰äººç‰©åœºæ™¯éƒ½å¯èƒ½å‡ºç°å¤šäººé—®é¢˜
- å…³é”®çº¦æŸåœ¨ä¼˜åŒ–æ—¶è¢«é”™è¯¯ç§»é™¤

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤Promptä¼˜åŒ–å™¨ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**ä½ç½®**ï¼š`gen_video/prompt/optimizer.py`

**ä¿®æ”¹**ï¼š
- åœ¨ä¼˜åŒ–æ—¶ï¼Œå°†å•äººçº¦æŸæ ‡è®°ä¸º"ä¸å¯ç§»é™¤"ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
- ç¡®ä¿å•äººçº¦æŸå§‹ç»ˆä¿ç•™åœ¨æœ€ç»ˆpromptä¸­
- æ·»åŠ ä¿æŠ¤æœºåˆ¶ï¼šå¦‚æœæ£€æµ‹åˆ°äººç‰©åœºæ™¯ï¼Œå¼ºåˆ¶ä¿ç•™å•äººçº¦æŸ

**ä»£ç ä¿®æ”¹å»ºè®®**ï¼š
```python
# åœ¨ä¼˜åŒ–å™¨ä¸­æ·»åŠ ä¿æŠ¤åˆ—è¡¨
PROTECTED_KEYWORDS = [
    "single person", "only one character", "lone figure",
    "å•äºº", "åªæœ‰ä¸€ä¸ªè§’è‰²", "ç‹¬è¡Œ"
]

def optimize(self, parts, max_tokens=70):
    # å…ˆè¯†åˆ«å¹¶ä¿æŠ¤å•äººçº¦æŸ
    protected_parts = []
    for part in parts:
        if any(kw in part.lower() for kw in PROTECTED_KEYWORDS):
            protected_parts.append(part)
    
    # ä¼˜åŒ–å…¶ä»–éƒ¨åˆ†
    optimized = self._optimize_other_parts(parts, protected_parts, max_tokens)
    
    # ç¡®ä¿å•äººçº¦æŸåœ¨æœ€å‰é¢
    return protected_parts + optimized
```

### 2. å¢å¼ºNegative Promptï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

**ä½ç½®**ï¼š`gen_video/image_generator.py`

**ä¿®æ”¹**ï¼š
- å¯¹äºæ‰€æœ‰äººç‰©åœºæ™¯ï¼Œåœ¨negative promptä¸­æ·»åŠ ï¼š
  - `multiple people, crowd, group, many characters, duplicate characters`
  - `vehicles, tanks, military equipment, modern technology`ï¼ˆé’ˆå¯¹scene_007ï¼‰

### 3. ä¿®å¤Scene_007çš„Promptï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

**é—®é¢˜**ï¼š`gravel` å¯èƒ½è¢«è¯¯è§£

**ä¿®å¤**ï¼š
- å°† `(gravel:1.70)` æ”¹ä¸ºæ›´æ˜ç¡®çš„æè¿°ï¼š`(gray-green sand ground:1.70)`
- æ·»åŠ æ’é™¤é¡¹ï¼š`no vehicles, no tanks, no military equipment`

### 4. ä¿®å¤Scene_012çš„Promptï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

**é—®é¢˜**ï¼šåœºæ™¯æè¿°å¯èƒ½æš—ç¤ºå¤šäºº

**ä¿®å¤**ï¼š
- æ˜ç¡®å¼ºè°ƒï¼š`(Han Li alone, single person, only one character:2.5)`
- åœ¨compositionä¸­å¼ºè°ƒï¼š`Han Li (single person) sees monstrous birds diving...`

## ä¿®å¤å®Œæˆ âœ…

### å·²å®Œæˆçš„ä¿®å¤

1. **ä¿®å¤Promptä¼˜åŒ–å™¨** âœ…
   - åœ¨ `_infer_part_type` æ–¹æ³•ä¸­æ·»åŠ äº† "constraint" ç±»å‹æ£€æµ‹
   - å•äººçº¦æŸç°åœ¨ä¼šè¢«è¯†åˆ«ä¸º "constraint" ç±»å‹
   - åœ¨ `_analyze_importance` ä¸­ï¼Œconstraint ç±»å‹çš„é‡è¦æ€§è®¾ç½®ä¸º 20.0ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
   - åœ¨ `_select_parts` ä¸­ï¼Œconstraint ç±»å‹è¢«æ·»åŠ åˆ° `must_keep_types` åˆ—è¡¨
   - ç¡®ä¿çº¦æŸæ¡ä»¶å§‹ç»ˆåœ¨æœ€å‰é¢ï¼Œä¸ä¼šè¢«ä¼˜åŒ–æ‰

2. **ä¿®æ”¹ä½ç½®**
   - æ–‡ä»¶ï¼š`gen_video/prompt/optimizer.py`
   - ä¿®æ”¹äº†ä¸‰ä¸ªæ–¹æ³•ï¼š
     - `_infer_part_type()`: æ·»åŠ çº¦æŸç±»å‹æ£€æµ‹
     - `_analyze_importance()`: è®¾ç½®çº¦æŸç±»å‹æœ€é«˜é‡è¦æ€§
     - `_select_parts()`: ç¡®ä¿çº¦æŸæ¡ä»¶è¢«ä¿ç•™

### ä¸‹ä¸€æ­¥æ“ä½œ

1. **é‡æ–°ç”Ÿæˆscene_007å’Œscene_012**
   ```bash
   cd /vepfs-dev/shawn/vid/fanren/gen_video
   source /vepfs-dev/shawn/venv/py312/bin/activate
   # é‡æ–°è¿è¡Œå›¾åƒç”Ÿæˆï¼Œåªç”Ÿæˆè¿™ä¸¤ä¸ªåœºæ™¯
   ```

2. **éªŒè¯ä¿®å¤æ•ˆæœ**
   - æ£€æŸ¥ scene_007 æ˜¯å¦è¿˜æœ‰å¦å…‹
   - æ£€æŸ¥ scene_012 æ˜¯å¦åªæœ‰ä¸€ä¸ªäºº
   - æ£€æŸ¥å…¶ä»–äººç‰©åœºæ™¯æ˜¯å¦ä¹Ÿæ­£ç¡®ï¼ˆå•äººï¼‰

## éªŒè¯æ–¹æ³•

ç”Ÿæˆåæ£€æŸ¥ï¼š
1. scene_007æ˜¯å¦è¿˜æœ‰å¦å…‹
2. scene_012æ˜¯å¦åªæœ‰ä¸€ä¸ªäºº
3. å…¶ä»–äººç‰©åœºæ™¯æ˜¯å¦ä¹Ÿæ­£ç¡®ï¼ˆå•äººï¼‰

## æ€»ç»“

**æ ¹æœ¬åŸå› **ï¼šPromptä¼˜åŒ–å™¨åœ¨ç²¾ç®€promptæ—¶ï¼Œé”™è¯¯åœ°ç§»é™¤äº†å…³é”®çš„å•äººçº¦æŸï¼Œå¯¼è‡´ï¼š
- scene_007: å¯èƒ½å› ä¸ºç¼ºå°‘çº¦æŸå’Œæ’é™¤é¡¹ï¼Œç”Ÿæˆäº†å¦å…‹
- scene_012: å› ä¸ºç¼ºå°‘å•äººçº¦æŸï¼Œç”Ÿæˆäº†10ä¸ªä¸€æ ·çš„äºº

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä¿®å¤ä¼˜åŒ–å™¨ï¼Œä¿æŠ¤å•äººçº¦æŸä¸è¢«ç§»é™¤
2. å¢å¼ºnegative prompt
3. æ”¹è¿›åœºæ™¯æè¿°ï¼Œæ›´æ˜ç¡®åœ°å¼ºè°ƒå•äºº

