# 当前工作状态总结

**日期**: 2025-12-22
**目标**: 修复视频生成质量与角色一致性问题

## 🚨 核心发现：LoRA 架构不兼容
经过排查，确认导致角色"不像"的根本原因是模型架构不匹配：
- **当前基础模型**: Flux.1-dev (Transformer 架构)
- **服务器现有 LoRA**: SDXL 格式 (U-Net 架构)
- **结果**: LoRA 加载完全失败，生成仅依赖 PuLID 的面部参考图，导致神似但形不似。

## ✅ 已完成的优化
1. **Prompt 逻辑修复**
   - 修复了 `v1_to_v22_converter.py`，移除了 redundant 的代词，解决了生成"双人"的 Bug。
2. **生成参数调优**
   - **IP-Adapter Scale**: 根据镜头动态调整 (Wide: 0.4, Medium: 0.6, Close: 0.85)。
   - **广角镜头优化**: 禁用解耦模式，将参考强度从 50% 提升至 60%，解决模糊问题。
3. **PuLID 引擎升级**
   - 修改权重映射曲线，提高整体身份注入强度。
4. **训练准备**
   - 在服务器发现高质量训练素材 (`character_profiles/hanli`)。
   - 创建自动化训练脚本 `train_flux_lora_hanli.sh`。

## 🚧 进行中 / 下一步
1. **训练 Flux LoRA (关键路径)**
   - **操作**: 在服务器运行 `train_flux_lora_hanli.sh`。
   - **预期**: 获得兼容 Flux 的 `hanli_flux` LoRA。
2. **集成新 LoRA**
   - 训练完成后，修改 `config.yaml` 或代码指向新的 LoRA 路径。
3. **最终全流程测试**
   - 使用新 LoRA + 优化后的 PuLID 参数进行验证。

## 📉 参数调整记录
| 镜头类型 (Shot) | IP-Adapter Scale | Reference Strength | 备注 |
|---|---|---|---|
| Wide | 0.40 | 60% | 环境优先，强调清晰度 |
| Medium | 0.60 | 70% | 平衡模式 |
| Close Up | 0.85 | 100% | 强身份锁定 |
