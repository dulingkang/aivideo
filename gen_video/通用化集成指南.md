# 通用化集成指南

## 已完成的工作

### 1. 创建了通用场景意图分析器
- **文件**: `scene_intent_analyzer.py`
- **功能**: 智能分析场景描述，提取实体、动作、视角等，不依赖特定角色或物体名称

### 2. 在ImageGenerator中初始化了分析器
- 已在`__init__`方法中添加：`self.intent_analyzer = SceneIntentAnalyzer()`

## 下一步：集成到build_prompt方法

### 方案1：渐进式替换（推荐）
在`build_prompt`方法开始处添加意图分析，逐步替换特殊处理：

```python
def build_prompt(self, scene: Dict[str, Any], ...):
    # 1. 首先进行意图分析
    intent = self.intent_analyzer.analyze(scene)
    
    # 2. 使用意图分析结果指导Prompt构建
    # 移除所有硬编码的特殊处理，改用intent结果
    
    # 3. 根据intent['primary_entity']判断是否需要角色
    # 根据intent['emphasis']添加强调项
    # 根据intent['viewpoint']添加视角描述
    # 根据intent['exclusions']添加排除项
```

### 方案2：创建新的通用方法
创建一个新的`build_prompt_universal`方法，完全基于意图分析：

```python
def build_prompt_universal(self, scene: Dict[str, Any], ...):
    """通用Prompt构建方法，完全基于意图分析"""
    intent = self.intent_analyzer.analyze(scene)
    # 基于intent构建Prompt，无任何特殊处理
```

## 需要移除的特殊处理

### 1. 卷轴特殊处理（1916-2034行）
**当前代码**:
```python
# 检查是否包含卷轴等关键物体
has_scroll = False
if "scroll" in prompt_text or "卷轴" in prompt_text:
    has_scroll = True
    priority_parts.insert(0, "(golden scroll, scroll unfurling...:2.0)")
```

**替换为**:
```python
# 使用意图分析结果
if intent['primary_entity'] and intent['primary_entity']['type'] == 'object':
    entity_text = " ".join(intent['primary_entity']['keywords'])
    priority_parts.append(f"({entity_text}:{intent['primary_entity']['weight']})")
```

### 2. 韩立特殊处理（2382-2391行）
**当前代码**:
```python
if primary_character == "hanli":
    character_core = self._build_character_prompt_compact("hanli", ...)
```

**替换为**:
```python
# 使用通用角色识别
if intent['primary_entity'] and intent['primary_entity']['type'] == 'character':
    # 使用通用角色描述逻辑，不依赖特定角色名称
```

### 3. lying_still特殊处理（2469-2474行）
**当前代码**:
```python
if action == "lying_still" or "lying" in character_pose.lower():
    priority_parts.append(f"({character_pose}:1.6)")
```

**替换为**:
```python
# 使用意图分析的动作类型
if intent['action_type'] == 'static':
    # 根据动作类型调整权重，不依赖特定动作名称
```

### 4. 默认韩立处理（2448-2455行）
**当前代码**:
```python
# 如果没有识别到角色，默认使用韩立
character_core = self._build_character_prompt_compact("hanli", ...)
```

**替换为**:
```python
# 如果没有识别到角色，不添加角色描述
if not intent['primary_entity'] or intent['primary_entity']['type'] != 'character':
    # 跳过角色描述
```

## 通用规则系统

### 实体识别规则
- **角色**: 检测"character"、"person"、"角色"、"人物"等关键词
- **物体**: 检测"object"、"item"、"scroll"、"物体"等关键词
- **环境**: 检测"sky"、"ground"、"desert"、"天空"、"地面"等关键词

### 动作识别规则
- **静态**: "still"、"motionless"、"静止"、"不动"
- **动态**: "move"、"walk"、"run"、"移动"、"奔跑"
- **物体运动**: "unfurl"、"open"、"rotate"、"展开"、"打开"

### 视角识别规则
- **正面**: "facing camera"、"front view"、"正面"、"面向镜头"
- **背面**: "back view"、"from behind"、"背影"、"背后"
- **特写**: "close-up"、"extreme close-up"、"特写"、"近景"
- **远景**: "wide shot"、"distant"、"远景"、"远距离"

### 权重分配规则
- **主要实体**: 根据类型自动分配权重（物体1.8，角色1.5，环境1.2）
- **强调项**: 固定权重1.8
- **视角**: 根据类型分配权重（正面1.8，其他1.2-1.5）
- **动作描述**: 固定权重1.3
- **构图描述**: 固定权重1.4

## 使用示例

### 场景1：卷轴展开（无人物）
```json
{
  "description": "金色卷轴在天空缓缓展开",
  "visual": {
    "composition": "Golden scroll unfurling in sky"
  }
}
```

**意图分析结果**:
- primary_entity: {type: "object", name: "scroll", weight: 1.8}
- action_type: "object_motion"
- emphasis: ["scroll", "unfurling"]
- exclusions: ["person", "character"]

**生成的Prompt**:
```
xianxia fantasy, (scroll unfurling:1.8), (Golden scroll unfurling in sky:1.4), (wide shot:1.2)
```

### 场景2：角色正面（有角色）
```json
{
  "description": "韩立面向镜头，表情严肃",
  "visual": {
    "character_pose": "Facing camera, front view, serious expression"
  }
}
```

**意图分析结果**:
- primary_entity: {type: "character", weight: 1.5}
- viewpoint: {type: "front", weight: 1.8}
- emphasis: []

**生成的Prompt**:
```
xianxia fantasy, (Facing camera, front view, serious expression:1.8), (facing camera, front view, face forward:1.6), (韩立面向镜头，表情严肃:1.3)
```

## 优势

1. **通用性**: 不依赖特定角色或物体名称
2. **智能性**: 基于语义理解用户意图
3. **准确性**: 准确表现用户需求
4. **可扩展性**: 易于添加新的实体类型和规则
5. **可维护性**: 代码更简洁，逻辑更清晰

## 测试建议

1. 测试各种场景类型（有角色、无角色、有物体、纯环境）
2. 测试各种视角（正面、背面、特写、远景）
3. 测试各种动作（静态、动态、物体运动）
4. 验证生成的Prompt是否准确反映用户意图

