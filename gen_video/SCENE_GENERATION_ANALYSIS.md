# 场景生成问题分析

## 一、失败场景统计

### 失败的场景（共10个）
- **场景2** (ID=1): hanli 躺在沙漠 - `KeyError 'unet'`
- **场景6** (ID=5): hanli 使用元婴虚化之法 - `KeyError 'unet'`
- **场景7** (ID=6): hanli 偏动头颅 - `KeyError 'unet'`
- **场景9** (ID=8): hanli 眼睛特写 - `KeyError 'unet'`
- **场景11** (ID=10): hanli 看到怪鸟 - `KeyError 'unet'`
- **场景12** (ID=11): hanli 看到怪鸟俯冲 - `KeyError 'unet'`
- **场景13** (ID=12): hanli 吸入沙砾 - `KeyError 'unet'`
- **场景15** (ID=14): hanli 胸膛鼓起 - `KeyError 'unet'`
- **场景19** (ID=18): hanli 表情变化 - `KeyError 'unet'`
- **场景20** (ID=19): hanli 看到火鸟 - `KeyError 'unet'`

**共同特征**：所有失败场景都是 **hanli 角色场景**，使用 **InstantID** 生成。

### 成功的场景（共10个）
- **场景1** (ID=0): 卷轴场景（已存在）
- **场景3** (ID=2): 天空三颗太阳（Flux，纯背景）
- **场景8** (ID=7): 太阳减少（Flux，纯背景）
- **场景10** (ID=9): 黑点出现（Flux，纯背景）
- **场景14** (ID=13): 沙砾旋转（Flux，纯背景）
- **场景16** (ID=15): 青光击中怪鸟（Flux，纯背景）
- **场景17** (ID=16): 怪鸟撕扯（Flux，纯背景）
- **场景18** (ID=17): 太阳变月亮（Flux，纯背景）
- **场景21** (ID=20): 骑士出现（Flux，纯背景）
- **场景22** (ID=999): 仙城剪影（Flux，纯背景）

**共同特征**：所有成功场景都是 **纯背景场景**，使用 **Flux.1** 生成。

## 二、问题根因分析

### 1. KeyError 'unet' 问题

**现象**：
- 所有 hanli 场景（InstantID）都失败
- 错误信息：`✗ 场景 X 生成失败: 'unet'`
- 没有看到修复代码的调试输出

**可能原因**：
1. **Pipeline 组件不完整**：`pipeline.components` 字典中缺少 `'unet'` 键
2. **Pipeline 状态异常**：在多次场景切换后，pipeline 组件可能被部分卸载或损坏
3. **设备映射冲突**：使用 `device_map` 时，某些组件可能被移动到 CPU，导致访问失败
4. **异常捕获不完整**：KeyError 可能被包装在其他异常中，没有被正确捕获

### 2. 场景内容问题

**需要检查的方面**：
1. **场景内容准确性**：生成的图像是否符合脚本描述
2. **角色一致性**：hanli 角色的外观是否一致
3. **风格统一性**：场景风格是否符合仙侠动漫风格
4. **镜头距离**：是否避免了过近的镜头
5. **动作表现**：关键动作（如"躺着"）是否正确表现

## 三、修复方案

### 1. 修复 KeyError 'unet' 问题

#### 方案A：增强错误检测和自动修复
- ✅ 已在 `_generate_image_instantid` 中添加详细的错误检测
- ✅ 添加了 pipeline 组件检查
- ✅ 添加了自动重新加载 pipeline 的逻辑
- ✅ 添加了完整的错误堆栈输出

#### 方案B：确保 Pipeline 组件完整性
- 在每次调用前检查 `pipeline.components` 是否包含所有必要键
- 如果缺少组件，自动重新加载 pipeline

#### 方案C：避免 Pipeline 状态污染
- 在场景切换时，确保 pipeline 状态正确
- 避免在多个场景间共享不完整的 pipeline 状态

### 2. 场景内容优化

#### 需要检查的已生成场景：
1. **场景1** (卷轴场景)：检查是否符合"金色卷轴展开"的描述
2. **场景3** (三颗太阳)：检查是否符合"三颗烈日和四轮月影"的描述
3. **场景8** (太阳减少)：检查是否符合"太阳从三颗减少到一颗"的描述
4. **场景10** (黑点出现)：检查是否符合"二十多个黑点出现"的描述
5. **场景14** (沙砾旋转)：检查是否符合"沙砾在嘴边旋转"的描述
6. **场景16** (青光击中)：检查是否符合"青光击中怪鸟"的描述
7. **场景17** (怪鸟撕扯)：检查是否符合"怪鸟撕扯同伴"的描述
8. **场景18** (太阳变月亮)：检查是否符合"太阳变七轮弯月"的描述
9. **场景21** (骑士出现)：检查是否符合"骑着怪兽的骑士"的描述
10. **场景22** (仙城剪影)：检查是否符合"仙城剪影，灵光飘落"的描述

#### 优化建议：
1. **Prompt 优化**：确保关键元素（如"三颗太阳"、"怪鸟"）在 prompt 中有足够的权重
2. **风格一致性**：确保所有场景都使用相同的风格描述
3. **镜头距离**：确保远景场景不会生成过近的镜头
4. **动作表现**：确保关键动作（如"躺着"、"旋转"）在 prompt 中有足够的权重

## 四、立即执行的修复

### 1. 修复 KeyError 'unet'
- ✅ 已添加详细的错误检测和日志
- ✅ 已添加 pipeline 组件检查
- ✅ 已添加自动重新加载逻辑

### 2. 重新生成失败的场景
- 修复后，需要重新生成所有失败的 hanli 场景（场景2、6、7、9、11、12、13、15、19、20）

### 3. 检查已生成场景的内容
- 需要人工检查已生成的10个场景，确认是否符合脚本描述
- 如果不符合，需要调整 prompt 或参数后重新生成

## 五、下一步行动

1. **重新运行生成**：使用修复后的代码重新生成所有场景
2. **检查生成结果**：人工检查所有生成的图像，确认场景内容是否正确
3. **优化 Prompt**：根据检查结果，优化 prompt 构建逻辑
4. **调整参数**：根据检查结果，调整 InstantID 和 Flux 的参数

