# AIäº§å“æ¶æ„åˆ†æä¸é‡æ„æ–¹æ¡ˆ

## ğŸ“Š å½“å‰ä»£ç åˆ†æ

### ç°çŠ¶
- **æ–‡ä»¶å¤§å°**: `image_generator.py` çº¦ **5600è¡Œ**
- **ç±»æ•°é‡**: 1ä¸ªä¸»ç±» `ImageGenerator`
- **æ–¹æ³•æ•°é‡**: 40+ ä¸ªæ–¹æ³•
- **èŒè´£**: å›¾åƒç”Ÿæˆã€Promptæ„å»ºã€Pipelineç®¡ç†ã€é…ç½®ç®¡ç†ã€è§’è‰²ç®¡ç†ã€åœºæ™¯åˆ†æç­‰

### é—®é¢˜
1. **å•ä¸€èŒè´£åŸåˆ™è¿å**: ä¸€ä¸ªç±»æ‰¿æ‹…äº†å¤ªå¤šèŒè´£
2. **å¯ç»´æŠ¤æ€§å·®**: ä»£ç è¿‡é•¿ï¼Œéš¾ä»¥å®šä½å’Œä¿®æ”¹
3. **å¯æµ‹è¯•æ€§å·®**: æ–¹æ³•è€¦åˆåº¦é«˜ï¼Œéš¾ä»¥å•ç‹¬æµ‹è¯•
4. **å¯æ‰©å±•æ€§å·®**: æ·»åŠ æ–°åŠŸèƒ½éœ€è¦ä¿®æ”¹æ ¸å¿ƒç±»

---

## ğŸ—ï¸ ä¸»æµAIäº§å“æ¶æ„åˆ†æ

### 1. **Stable Diffusion WebUI (AUTOMATIC1111)**

**æ¶æ„ç‰¹ç‚¹**:
```
modules/
â”œâ”€â”€ processing.py          # æ ¸å¿ƒå¤„ç†é€»è¾‘
â”œâ”€â”€ sd_models.py          # æ¨¡å‹ç®¡ç†
â”œâ”€â”€ sd_samplers.py        # é‡‡æ ·å™¨ç®¡ç†
â”œâ”€â”€ prompt_parser.py      # Promptè§£æ
â”œâ”€â”€ shared.py             # å…±äº«çŠ¶æ€
â””â”€â”€ scripts/              # æ’ä»¶ç³»ç»Ÿ
    â”œâ”€â”€ script.py         # è„šæœ¬åŸºç±»
    â””â”€â”€ [å„ç§è„šæœ¬æ’ä»¶]
```

**è®¾è®¡æ¨¡å¼**:
- **æ¨¡å—åŒ–è®¾è®¡**: æŒ‰åŠŸèƒ½æ‹†åˆ†ç‹¬ç«‹æ¨¡å—
- **æ’ä»¶ç³»ç»Ÿ**: é€šè¿‡è„šæœ¬ç³»ç»Ÿæ‰©å±•åŠŸèƒ½
- **çŠ¶æ€ç®¡ç†**: ä½¿ç”¨ `shared.py` ç®¡ç†å…¨å±€çŠ¶æ€
- **é…ç½®åˆ†ç¦»**: é…ç½®ä¸é€»è¾‘åˆ†ç¦»

**å¯å€Ÿé‰´ç‚¹**:
âœ… æŒ‰åŠŸèƒ½æ¨¡å—æ‹†åˆ†
âœ… æ’ä»¶åŒ–æ‰©å±•æœºåˆ¶
âœ… çŠ¶æ€ç®¡ç†é›†ä¸­åŒ–

---

### 2. **ComfyUI**

**æ¶æ„ç‰¹ç‚¹**:
```
comfy/
â”œâ”€â”€ model_management.py  # æ¨¡å‹ç®¡ç†
â”œâ”€â”€ execution.py          # æ‰§è¡Œå¼•æ“
â”œâ”€â”€ nodes.py              # èŠ‚ç‚¹å®šä¹‰
â””â”€â”€ utils.py              # å·¥å…·å‡½æ•°

custom_nodes/             # è‡ªå®šä¹‰èŠ‚ç‚¹
â””â”€â”€ [å„ç§è‡ªå®šä¹‰èŠ‚ç‚¹]
```

**è®¾è®¡æ¨¡å¼**:
- **èŠ‚ç‚¹åŒ–æ¶æ„**: æ¯ä¸ªåŠŸèƒ½æ˜¯ä¸€ä¸ªèŠ‚ç‚¹
- **å›¾æ‰§è¡Œå¼•æ“**: é€šè¿‡èŠ‚ç‚¹å›¾æ‰§è¡Œä»»åŠ¡
- **æ¨¡å—åŒ–æ‰©å±•**: é€šè¿‡è‡ªå®šä¹‰èŠ‚ç‚¹æ‰©å±•
- **ä¾èµ–ç®¡ç†**: èŠ‚ç‚¹é—´é€šè¿‡æ•°æ®æµè¿æ¥

**å¯å€Ÿé‰´ç‚¹**:
âœ… èŠ‚ç‚¹åŒ–è®¾è®¡ï¼ˆPipeline = èŠ‚ç‚¹é“¾ï¼‰
âœ… æ‰§è¡Œå¼•æ“ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»
âœ… ä¾èµ–æ³¨å…¥æœºåˆ¶

---

### 3. **Hugging Face Diffusers**

**æ¶æ„ç‰¹ç‚¹**:
```
diffusers/
â”œâ”€â”€ pipelines/            # å„ç§Pipeline
â”‚   â”œâ”€â”€ stable_diffusion/
â”‚   â””â”€â”€ stable_diffusion_xl/
â”œâ”€â”€ models/               # æ¨¡å‹å®šä¹‰
â”œâ”€â”€ schedulers/           # è°ƒåº¦å™¨
â””â”€â”€ utils/                # å·¥å…·å‡½æ•°
```

**è®¾è®¡æ¨¡å¼**:
- **Pipelineæ¨¡å¼**: æ¯ä¸ªæ¨¡å‹ä¸€ä¸ªPipelineç±»
- **ç»„ä»¶åŒ–**: æ¨¡å‹ã€è°ƒåº¦å™¨ã€ç¼–ç å™¨ç­‰ç‹¬ç«‹ç»„ä»¶
- **é…ç½®é©±åŠ¨**: é€šè¿‡é…ç½®ç±»ç®¡ç†å‚æ•°
- **ç‰ˆæœ¬ç®¡ç†**: æ”¯æŒå¤šç‰ˆæœ¬æ¨¡å‹

**å¯å€Ÿé‰´ç‚¹**:
âœ… PipelineæŠ½è±¡
âœ… ç»„ä»¶åŒ–è®¾è®¡
âœ… é…ç½®ç±»ç®¡ç†

---

### 4. **RunwayML / Replicate**

**æ¶æ„ç‰¹ç‚¹**:
```
api/
â”œâ”€â”€ models/              # æ¨¡å‹æœåŠ¡
â”œâ”€â”€ predictions/         # é¢„æµ‹æœåŠ¡
â””â”€â”€ webhooks/            # å›è°ƒæœåŠ¡

core/
â”œâ”€â”€ engine.py            # æ‰§è¡Œå¼•æ“
â”œâ”€â”€ queue.py             # ä»»åŠ¡é˜Ÿåˆ—
â””â”€â”€ storage.py           # å­˜å‚¨ç®¡ç†
```

**è®¾è®¡æ¨¡å¼**:
- **æœåŠ¡åŒ–æ¶æ„**: APIæœåŠ¡ä¸æ ¸å¿ƒé€»è¾‘åˆ†ç¦»
- **å¼‚æ­¥å¤„ç†**: ä»»åŠ¡é˜Ÿåˆ— + åå°å¤„ç†
- **èµ„æºç®¡ç†**: ç»Ÿä¸€çš„èµ„æºç®¡ç†ï¼ˆGPUã€å­˜å‚¨ï¼‰
- **ç›‘æ§ä¸æ—¥å¿—**: å®Œå–„çš„ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ

**å¯å€Ÿé‰´ç‚¹**:
âœ… æœåŠ¡åŒ–æ‹†åˆ†
âœ… å¼‚æ­¥ä»»åŠ¡å¤„ç†
âœ… èµ„æºç®¡ç†æŠ½è±¡

---

## ğŸ¯ é‡æ„æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šæ¨¡å—åŒ–æ‹†åˆ†ï¼ˆæ¨èï¼‰

**ç›®æ ‡**: å°† `ImageGenerator` æ‹†åˆ†ä¸ºå¤šä¸ªèŒè´£æ¸…æ™°çš„æ¨¡å—

```
gen_video/
â”œâ”€â”€ image_generator.py          # ä¸»å…¥å£ï¼ˆç²¾ç®€åˆ°500è¡Œä»¥å†…ï¼‰
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ pipeline_manager.py     # Pipelineç®¡ç†ï¼ˆåŠ è½½ã€å¸è½½ã€åˆ‡æ¢ï¼‰
â”‚   â”œâ”€â”€ model_loader.py         # æ¨¡å‹åŠ è½½å™¨
â”‚   â””â”€â”€ device_manager.py       # è®¾å¤‡ç®¡ç†
â”œâ”€â”€ prompt/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ builder.py              # Promptæ„å»ºå™¨ï¼ˆä¸»é€»è¾‘ï¼‰
â”‚   â”œâ”€â”€ optimizer.py            # Promptä¼˜åŒ–å™¨
â”‚   â”œâ”€â”€ parser.py               # Promptè§£æå™¨
â”‚   â””â”€â”€ translator.py           # ä¸­è‹±æ–‡ç¿»è¯‘
â”œâ”€â”€ adapters/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ ip_adapter.py           # IP-Adapterç®¡ç†
â”‚   â”œâ”€â”€ lora_adapter.py         # LoRAç®¡ç†
â”‚   â””â”€â”€ instantid_adapter.py    # InstantIDç®¡ç†
â”œâ”€â”€ generators/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ base_generator.py       # ç”Ÿæˆå™¨åŸºç±»
â”‚   â”œâ”€â”€ sdxl_generator.py       # SDXLç”Ÿæˆå™¨
â”‚   â””â”€â”€ instantid_generator.py  # InstantIDç”Ÿæˆå™¨
â”œâ”€â”€ analyzers/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ scene_intent_analyzer.py  # åœºæ™¯æ„å›¾åˆ†æï¼ˆå·²æœ‰ï¼‰
â”‚   â”œâ”€â”€ scene_motion_analyzer.py  # åœºæ™¯è¿åŠ¨åˆ†æï¼ˆå·²æœ‰ï¼‰
â”‚   â””â”€â”€ image_analyzer.py        # å›¾åƒåˆ†æï¼ˆå·²æœ‰ï¼‰
â”œâ”€â”€ profiles/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ character_manager.py    # è§’è‰²ç®¡ç†
â”‚   â””â”€â”€ scene_manager.py       # åœºæ™¯ç®¡ç†
â””â”€â”€ utils/
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ config_loader.py        # é…ç½®åŠ è½½
    â”œâ”€â”€ token_estimator.py      # Tokenä¼°ç®—
    â””â”€â”€ image_utils.py          # å›¾åƒå·¥å…·å‡½æ•°
```

**ä¼˜åŠ¿**:
- âœ… èŒè´£æ¸…æ™°ï¼Œæ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
- âœ… æ˜“äºæµ‹è¯•å’Œç»´æŠ¤
- âœ… æ˜“äºæ‰©å±•æ–°åŠŸèƒ½
- âœ… ä»£ç å¤ç”¨æ€§é«˜

---

### æ–¹æ¡ˆäºŒï¼šPipelineæ¨¡å¼ï¼ˆç±»ä¼¼Diffusersï¼‰

**ç›®æ ‡**: é‡‡ç”¨PipelineæŠ½è±¡ï¼Œç»Ÿä¸€ä¸åŒæ¨¡å‹çš„æ¥å£

```
gen_video/
â”œâ”€â”€ pipelines/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ base_pipeline.py        # PipelineåŸºç±»
â”‚   â”œâ”€â”€ sdxl_pipeline.py        # SDXL Pipeline
â”‚   â””â”€â”€ instantid_pipeline.py   # InstantID Pipeline
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ prompt_processor.py     # Promptå¤„ç†ç»„ä»¶
â”‚   â”œâ”€â”€ adapter_manager.py      # Adapterç®¡ç†ç»„ä»¶
â”‚   â””â”€â”€ image_processor.py      # å›¾åƒå¤„ç†ç»„ä»¶
â””â”€â”€ image_generator.py          # ä¸»ç±»ï¼ˆä½¿ç”¨Pipelineï¼‰
```

**ä¼˜åŠ¿**:
- âœ… ç»Ÿä¸€æ¥å£ï¼Œæ˜“äºåˆ‡æ¢æ¨¡å‹
- âœ… ç»„ä»¶å¯å¤ç”¨
- âœ… ç¬¦åˆDiffusersçš„è®¾è®¡ç†å¿µ

---

### æ–¹æ¡ˆä¸‰ï¼šæœåŠ¡åŒ–æ¶æ„ï¼ˆé€‚åˆå¹³å°åŒ–ï¼‰

**ç›®æ ‡**: å°†åŠŸèƒ½æ‹†åˆ†ä¸ºç‹¬ç«‹æœåŠ¡

```
gen_video/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ prompt_service.py       # PromptæœåŠ¡
â”‚   â”œâ”€â”€ generation_service.py   # ç”ŸæˆæœåŠ¡
â”‚   â”œâ”€â”€ model_service.py        # æ¨¡å‹æœåŠ¡
â”‚   â””â”€â”€ analysis_service.py     # åˆ†ææœåŠ¡
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ endpoints.py            # APIç«¯ç‚¹ï¼ˆå·²æœ‰ï¼‰
â””â”€â”€ image_generator.py          # ä¸»ç±»ï¼ˆç»„åˆæœåŠ¡ï¼‰
```

**ä¼˜åŠ¿**:
- âœ… é€‚åˆå¹³å°åŒ–éƒ¨ç½²
- âœ… æœåŠ¡å¯ç‹¬ç«‹æ‰©å±•
- âœ… æ˜“äºåˆ†å¸ƒå¼éƒ¨ç½²

---

## ğŸš€ æ¨èå®æ–½æ–¹æ¡ˆ

### é˜¶æ®µä¸€ï¼šæ¨¡å—åŒ–æ‹†åˆ†ï¼ˆç«‹å³å®æ–½ï¼‰

**ä¼˜å…ˆçº§**: ğŸ”´ é«˜

1. **æå–Promptç›¸å…³åŠŸèƒ½** â†’ `prompt/` æ¨¡å—
   - `build_prompt()` â†’ `prompt/builder.py`
   - `_extract_core_keywords()` â†’ `prompt/parser.py`
   - `_smart_optimize_prompt()` â†’ `prompt/optimizer.py`

2. **æå–Pipelineç®¡ç†** â†’ `core/pipeline_manager.py`
   - `load_pipeline()` â†’ `core/pipeline_manager.py`
   - `_load_instantid_pipeline()` â†’ `core/pipeline_manager.py`
   - `_load_sdxl_pipeline()` â†’ `core/pipeline_manager.py`

3. **æå–ç”Ÿæˆå™¨** â†’ `generators/` æ¨¡å—
   - `_generate_image_instantid()` â†’ `generators/instantid_generator.py`
   - `_generate_image_sdxl()` â†’ `generators/sdxl_generator.py`

4. **æå–Adapterç®¡ç†** â†’ `adapters/` æ¨¡å—
   - `_load_ip_adapter()` â†’ `adapters/ip_adapter.py`
   - `_load_lora()` â†’ `adapters/lora_adapter.py`

### é˜¶æ®µäºŒï¼šæ¥å£æŠ½è±¡ï¼ˆä¸­æœŸï¼‰

**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­

1. **å®šä¹‰ç”Ÿæˆå™¨æ¥å£** â†’ `generators/base_generator.py`
2. **ç»Ÿä¸€é…ç½®ç®¡ç†** â†’ `utils/config_loader.py`
3. **ç»Ÿä¸€é”™è¯¯å¤„ç†** â†’ `utils/exceptions.py`

### é˜¶æ®µä¸‰ï¼šå¹³å°åŒ–æ”¹é€ ï¼ˆé•¿æœŸï¼‰

**ä¼˜å…ˆçº§**: ğŸŸ¢ ä½

1. **æœåŠ¡åŒ–æ‹†åˆ†** â†’ `services/` æ¨¡å—
2. **ä»»åŠ¡é˜Ÿåˆ—** â†’ é›†æˆCeleryï¼ˆå·²æœ‰APIæ¨¡å—ï¼‰
3. **ç›‘æ§ä¸æ—¥å¿—** â†’ å®Œå–„ç›‘æ§ç³»ç»Ÿ

---

## ğŸ“‹ é‡æ„æ£€æŸ¥æ¸…å•

### ä»£ç è´¨é‡
- [ ] æ¯ä¸ªæ¨¡å—ä¸è¶…è¿‡500è¡Œ
- [ ] æ¯ä¸ªç±»å•ä¸€èŒè´£
- [ ] æ–¹æ³•ä¸è¶…è¿‡50è¡Œ
- [ ] ä¾èµ–å…³ç³»æ¸…æ™°ï¼ˆé¿å…å¾ªç¯ä¾èµ–ï¼‰

### æµ‹è¯•è¦†ç›–
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒåŠŸèƒ½
- [ ] é›†æˆæµ‹è¯•è¦†ç›–Pipelineæµç¨‹
- [ ] Mockæµ‹è¯•è¦†ç›–å¤–éƒ¨ä¾èµ–

### æ–‡æ¡£å®Œå–„
- [ ] æ¨¡å—æ–‡æ¡£è¯´æ˜
- [ ] APIæ–‡æ¡£æ›´æ–°
- [ ] ä½¿ç”¨ç¤ºä¾‹æ›´æ–°

---

## ğŸ¨ è®¾è®¡åŸåˆ™

### 1. **å•ä¸€èŒè´£åŸåˆ™ (SRP)**
æ¯ä¸ªç±»/æ¨¡å—åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½

### 2. **å¼€é—­åŸåˆ™ (OCP)**
å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼ˆé€šè¿‡æ¥å£å’Œç»§æ‰¿ï¼‰

### 3. **ä¾èµ–å€’ç½®åŸåˆ™ (DIP)**
ä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°

### 4. **æ¥å£éš”ç¦»åŸåˆ™ (ISP)**
ä½¿ç”¨å¤šä¸ªä¸“é—¨çš„æ¥å£ï¼Œè€Œéå•ä¸€çš„æ€»æ¥å£

### 5. **ç»„åˆä¼˜äºç»§æ‰¿**
ä¼˜å…ˆä½¿ç”¨ç»„åˆè€Œéç»§æ‰¿

---

## ğŸ“š å‚è€ƒèµ„æº

1. **Stable Diffusion WebUI**: https://github.com/AUTOMATIC1111/stable-diffusion-webui
2. **ComfyUI**: https://github.com/comfyanonymous/ComfyUI
3. **Hugging Face Diffusers**: https://github.com/huggingface/diffusers
4. **Clean Architecture**: Robert C. Martin

---

## âœ… ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³å¼€å§‹**: æå– `prompt/` æ¨¡å—ï¼ˆå½±å“æœ€å¤§ï¼Œé£é™©æœ€å°ï¼‰
2. **é€æ­¥è¿ç§»**: æ¯æ¬¡é‡æ„ä¸€ä¸ªæ¨¡å—ï¼Œä¿æŒå‘åå…¼å®¹
3. **æŒç»­æµ‹è¯•**: æ¯æ¬¡é‡æ„åè¿è¡Œå®Œæ•´æµ‹è¯•
4. **æ–‡æ¡£æ›´æ–°**: åŒæ­¥æ›´æ–°æ–‡æ¡£å’Œä½¿ç”¨ç¤ºä¾‹









