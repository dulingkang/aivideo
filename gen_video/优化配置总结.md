# 优化配置总结

根据专业建议，已应用**组合B（InstantID + LoRA 平衡）**配置，解决图像畸变和视频不自然问题。

## ✅ 已应用的优化

### 1. 图像生成优化（组合B）

#### 分辨率优化
- **之前**: 1920x1080（1080P，容易身体拉伸）
- **现在**: 1536x864（更稳定，避免身体拉伸）
- **后续**: 可用 RealESRGAN 放大到 1080P

#### InstantID 参数优化
- **face_emb_scale**: `0.75` → `0.60`（组合B推荐：0.55-0.65）
- **face_kps_scale**: `0.70`（组合B推荐：0.65-0.70）

#### LoRA 参数优化
- **alpha**: `0.75` → `0.60`（组合B推荐：0.55-0.65）

#### IP-Adapter 处理
- **InstantID 的 IP-Adapter**: 保留（必需的，用于面部嵌入）
- **额外的 SDXL IP-Adapter**: 禁用（避免与 InstantID + LoRA 冲突）

### 2. 视频生成优化（雾气自然版）

#### 帧数优化（关键）
- **之前**: `num_frames: 24`（太少，导致雾气跳动）
- **现在**: `num_frames: 75`（= duration * fps = 5 * 15）
- **效果**: 极大改善雾气飘动的连续性

#### 运动参数优化
- **motion_bucket_id**: `2` → `1.5`（最自然的雾气飘动）
- **noise_aug_strength**: `0.0004` → `0.00025`（最自然的雾气，避免过度运动和抖动）

#### 解码参数优化
- **decode_chunk_size**: `10` → `8`（SVD-XT 最稳定范围，避免补帧抖动）

#### 推理步数优化
- **num_inference_steps**: `60` → `40`（对运动自然度无影响，但速度更快）

### 3. 负面提示词优化

#### 权重降低
- **之前**: `(duplicate person:1.5)`, `(same person twice:1.5)` 等
- **现在**: `(duplicate person:1.2)`, `(same person twice:1.2)` 等
- **原因**: 权重太高会导致身体断掉/形变

#### 增强多腿/多肢体排除
- 添加了全面的多腿、多手、多肢体负面提示词
- 权重设置为 1.2（避免过度抑制）

## 📊 参数对比表

### 图像生成参数

| 参数 | 之前 | 现在（组合B） | 说明 |
|------|------|--------------|------|
| 分辨率 | 1920x1080 | 1536x864 | 更稳定，避免身体拉伸 |
| face_emb_scale | 0.75 | 0.60 | 与 LoRA 平衡 |
| face_kps_scale | 0.70 | 0.70 | 保持平衡 |
| LoRA alpha | 0.75 | 0.60 | 与 InstantID 平衡 |
| IP-Adapter | 全开 | InstantID 必需，禁用额外的 | 避免冲突 |

### 视频生成参数

| 参数 | 之前 | 现在 | 说明 |
|------|------|------|------|
| num_frames | 24 | 75 | 必须 = duration * fps |
| fps | 15 | 15 | 保持 |
| motion_bucket_id | 2 | 1.5 | 最自然的雾气 |
| noise_aug_strength | 0.0004 | 0.00025 | 最自然的雾气 |
| decode_chunk_size | 10 | 8 | SVD-XT 最稳定 |
| num_inference_steps | 60 | 40 | 对运动无影响 |

## 🎯 优化效果

### 图像生成
- ✅ **减少畸变**: InstantID + LoRA 平衡，避免控制器冲突
- ✅ **减少瘦长脸**: 降低 face_kps_scale 和 controlnet_scale
- ✅ **减少人物过大**: 增强负面提示词
- ✅ **减少多腿问题**: 增强负面提示词，降低权重

### 视频生成
- ✅ **雾气更自然**: motion_bucket_id=1.5, noise_aug_strength=0.00025
- ✅ **运动更连贯**: num_frames=75（足够帧数）
- ✅ **减少抖动**: decode_chunk_size=8（最稳定范围）
- ✅ **避免被拉回**: 优化的运动参数

## 📝 配置说明

### 组合B（当前配置）
- **InstantID**: face_emb_scale=0.60, face_kps_scale=0.70
- **LoRA**: alpha=0.60
- **IP-Adapter**: InstantID 必需（保留），额外的禁用
- **分辨率**: 1536x864（稳定）

### 其他可选组合

#### 组合A（强人脸一致性）
- **InstantID**: face_emb_scale=0.6-0.7
- **LoRA**: 禁用
- **IP-Adapter**: InstantID 必需（保留），额外的禁用
- **特点**: 最稳定，几乎不会脸崩

#### 组合C（更艺术化）
- **LoRA**: 启用
- **IP-Adapter**: 启用
- **InstantID**: 禁用
- **特点**: 人脸一致性不如前两个

## 🚀 使用建议

1. **重新生成图像**: 使用新的配置重新生成 scene_009 和 scene_013
2. **检查效果**: 观察是否还有瘦长脸、人物过大、多腿等问题
3. **微调参数**: 如果仍有问题，可以进一步降低参数
4. **视频生成**: 使用新的视频参数，雾气应该更自然

## ⚠️ 注意事项

1. **InstantID 的 IP-Adapter**: 这是必需的，不能禁用（用于面部嵌入）
2. **额外的 IP-Adapter**: 已禁用，避免与 InstantID + LoRA 冲突
3. **分辨率**: 1536x864 更稳定，可用 RealESRGAN 放大到 1080P
4. **帧数**: num_frames 必须 = duration * fps，否则运动不连贯

