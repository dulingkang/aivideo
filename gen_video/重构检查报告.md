# gen_video é‡æ„æ£€æŸ¥æŠ¥å‘Š

**æ£€æŸ¥æ—¶é—´**: 2025-01-XX  
**æ£€æŸ¥èŒƒå›´**: gen_video ç›®å½•ä¸‹çš„é‡æ„å·¥ä½œ

---

## ğŸ“Š æ€»ä½“çŠ¶æ€

### é‡æ„å®Œæˆåº¦ï¼š**çº¦ 85-90%**

- âœ… **Promptæ¨¡å—é‡æ„**: åŸºæœ¬å®Œæˆï¼Œä½†ä»æœ‰é—ç•™ä»£ç 
- âš ï¸ **ä»£ç æ¸…ç†**: æœªå®Œå…¨å®Œæˆï¼Œå­˜åœ¨é‡å¤ä»£ç 
- âœ… **é›†æˆ**: å·²å®Œæˆï¼Œ`build_prompt` å·²å§”æ‰˜ç»™ `PromptBuilder`
- â³ **æµ‹è¯•éªŒè¯**: å¾…è¿›è¡Œ

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. Promptæ¨¡å—åˆ›å»ºï¼ˆ100%ï¼‰

åˆ›å»ºäº†å®Œæ•´çš„ `prompt/` æ¨¡å—ï¼š

- âœ… `prompt/__init__.py` (18è¡Œ) - æ¨¡å—å¯¼å‡º
- âœ… `prompt/token_estimator.py` (125è¡Œ) - Tokenä¼°ç®—å™¨
- âœ… `prompt/parser.py` (170è¡Œ) - Promptè§£æå™¨  
- âœ… `prompt/optimizer.py` (236è¡Œ) - Promptä¼˜åŒ–å™¨
- âœ… `prompt/builder.py` (1316è¡Œ) - Promptæ„å»ºå™¨

**æ€»è®¡**: çº¦ 1865 è¡Œä»£ç 

### 2. æ ¸å¿ƒåŠŸèƒ½è¿ç§»ï¼ˆ100%ï¼‰

ä»¥ä¸‹æ–¹æ³•å·²æˆåŠŸè¿ç§»åˆ° prompt æ¨¡å—ï¼š

#### âœ… TokenEstimator
- `_estimate_clip_tokens()` â†’ `TokenEstimator.estimate()`

#### âœ… PromptParser
- `_extract_first_keyword()` â†’ `PromptParser.extract_first_keyword()`
- `_extract_core_keywords()` â†’ `PromptParser.extract_core_keywords()`

#### âœ… PromptOptimizer
- `_analyze_prompt_importance()` â†’ `PromptOptimizer._analyze_importance()`
- `_smart_optimize_prompt()` â†’ `PromptOptimizer.optimize()`

#### âœ… PromptBuilder
- `build_prompt()` â†’ `PromptBuilder.build()` (ä¸»æ–¹æ³•ï¼Œ1316è¡Œ)
- `_convert_camera_to_prompt()` â†’ `PromptBuilder._convert_camera_to_prompt()`
- `_convert_motion_to_prompt()` â†’ `PromptBuilder._convert_motion_to_prompt()`
- `_build_character_prompt()` â†’ `PromptBuilder._build_character_prompt()`
- ä»¥åŠå…¶ä»–è¾…åŠ©æ–¹æ³•

### 3. ImageGenerator é›†æˆï¼ˆ100%ï¼‰

- âœ… å·²å¯¼å…¥ prompt æ¨¡å—ç»„ä»¶ï¼ˆline 21ï¼‰
- âœ… åœ¨ `__init__` ä¸­åˆå§‹åŒ–æ‰€æœ‰ç»„ä»¶ï¼ˆline 58-75ï¼‰
- âœ… æ³¨å…¥å¿…è¦çš„ä¾èµ–ï¼ˆ`_identify_characters_in_scene`, `_needs_character`ï¼‰
- âœ… `build_prompt` æ–¹æ³•å·²å§”æ‰˜ç»™ `PromptBuilder.build()` (line 1866-1872)
- âœ… ä¿æŒå‘åå…¼å®¹ï¼ˆæ¥å£ä¸å˜ï¼‰

### 4. è¯­æ³•æ£€æŸ¥ï¼ˆ100%ï¼‰

- âœ… æ‰€æœ‰æ¨¡å—é€šè¿‡ Python è¯­æ³•æ£€æŸ¥
- âœ… æ— ç¼–è¯‘é”™è¯¯

---

## âš ï¸ å‘ç°çš„é—®é¢˜

### 1. é—ç•™ä»£ç æœªæ¸…ç†ï¼ˆé‡è¦ï¼‰

`image_generator.py` ä¸­ä»ä¿ç•™äº†ä¸€äº›å·²è¿ç§»çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å¯èƒ½ä¸å†è¢«ä½¿ç”¨ï¼š

#### é—ç•™çš„æ–¹æ³•åˆ—è¡¨

ä»¥ä¸‹æ–¹æ³•å·²ç»è¿ç§»åˆ° prompt æ¨¡å—ï¼Œä½†åœ¨ `image_generator.py` ä¸­ä»ç„¶å­˜åœ¨ï¼š

1. **`_estimate_clip_tokens()`** (line 1194-1288)
   - çŠ¶æ€: âš ï¸ å·²è¿ç§»åˆ° `TokenEstimator.estimate()`
   - é—®é¢˜: ä»åœ¨ `_smart_optimize_prompt` ä¸­è¢«è°ƒç”¨
   
2. **`_extract_first_keyword()`** (line 1632-1707)
   - çŠ¶æ€: âš ï¸ å·²è¿ç§»åˆ° `PromptParser.extract_first_keyword()`
   - é—®é¢˜: ä»åœ¨ `_smart_optimize_prompt` ä¸­è¢«è°ƒç”¨

3. **`_extract_core_keywords()`** (line 1709-1790)
   - çŠ¶æ€: âš ï¸ å·²è¿ç§»åˆ° `PromptParser.extract_core_keywords()`
   - é—®é¢˜: å¯èƒ½ä¸å†è¢«ä½¿ç”¨

4. **`_convert_camera_to_prompt()`** (line 1011-1193)
   - çŠ¶æ€: âš ï¸ å·²è¿ç§»åˆ° `PromptBuilder._convert_camera_to_prompt()`
   - é—®é¢˜: å¯èƒ½ä¸å†è¢«ä½¿ç”¨

5. **`_convert_motion_to_prompt()`** (line 986-1010, line 1791-1850)
   - çŠ¶æ€: âš ï¸ å·²è¿ç§»åˆ° `PromptBuilder._convert_motion_to_prompt()`
   - é—®é¢˜: å­˜åœ¨é‡å¤å®šä¹‰ï¼ˆä¸¤ä¸ªåœ°æ–¹ï¼‰

6. **`_build_character_prompt()`** (line 3834-3872)
   - çŠ¶æ€: âš ï¸ å·²è¿ç§»åˆ° `PromptBuilder._build_character_prompt()`
   - é—®é¢˜: å¯èƒ½ä¸å†è¢«ä½¿ç”¨

7. **`_build_character_prompt_compact()`** (line 3873-3929)
   - çŠ¶æ€: âš ï¸ å·²è¿ç§»åˆ° `PromptBuilder._build_character_prompt_compact()`
   - é—®é¢˜: å¯èƒ½ä¸å†è¢«ä½¿ç”¨

8. **`_smart_optimize_prompt()`** (line 1401-1631)
   - çŠ¶æ€: âš ï¸ å·²è¿ç§»åˆ° `PromptOptimizer.optimize()`
   - é—®é¢˜: ä»åœ¨ `image_generator.py` ä¸­ï¼Œä¸”è°ƒç”¨äº†å…¶ä»–é—ç•™æ–¹æ³•

9. **`_analyze_prompt_importance()`** (line 1268-1351)
   - çŠ¶æ€: âš ï¸ å·²è¿ç§»åˆ° `PromptOptimizer._analyze_importance()`
   - é—®é¢˜: ä»åœ¨ `_smart_optimize_prompt` ä¸­è¢«è°ƒç”¨

10. **`_translate_chinese_to_english()`** (line 1352-1399)
    - çŠ¶æ€: âš ï¸ å·²è¿ç§»åˆ° `PromptBuilder._translate_chinese_to_english()`
    - é—®é¢˜: å¯èƒ½ä¸å†è¢«ä½¿ç”¨

### 2. æ–¹æ³•ä¾èµ–å…³ç³»é—®é¢˜

**`_smart_optimize_prompt`** æ–¹æ³•ä»åœ¨ `image_generator.py` ä¸­ï¼Œå¹¶ä¸”ä¾èµ–ä»¥ä¸‹å·²è¿ç§»çš„æ–¹æ³•ï¼š
- `self._analyze_prompt_importance()` (line 1437)
- `self._estimate_clip_tokens()` (line 1330, 1475, 1495, etc.)
- `self._extract_first_keyword()` (line 1565, 1609)

**å‘ç°**: `image_generator_universal.py` æ–‡ä»¶ï¼ˆä¸€ä¸ªç‹¬ç«‹çš„å‡½æ•°æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯æ—§å®ç°æˆ–æµ‹è¯•ä»£ç ï¼‰ä¹Ÿåœ¨ä½¿ç”¨è¿™äº›æ–¹æ³•ï¼š
- `_smart_optimize_prompt()` (line 113)
- `_estimate_clip_tokens()` (line 110, 114)

è¿™è¡¨æ˜ï¼š
- è¦ä¹ˆ `_smart_optimize_prompt` åº”è¯¥è¢«å®Œå…¨ç§»é™¤ï¼ˆå¦‚æœä¸å†ä½¿ç”¨ï¼‰
- è¦ä¹ˆåº”è¯¥æ›´æ–°ä¸ºè°ƒç”¨ prompt æ¨¡å—ä¸­çš„å¯¹åº”æ–¹æ³•
- éœ€è¦ç¡®è®¤ `image_generator_universal.py` çš„ç”¨é€”å’ŒçŠ¶æ€

### 3. ä»£ç é‡å¤

- **`_convert_motion_to_prompt()`** æ–¹æ³•åœ¨ `image_generator.py` ä¸­å®šä¹‰äº†ä¸¤æ¬¡ï¼ˆline 986 å’Œ line 1791ï¼‰
- è¿™å¯èƒ½å¯¼è‡´ç»´æŠ¤å›°éš¾å’Œæ½œåœ¨çš„ä¸ä¸€è‡´

---

## ğŸ“‹ å¾…å®Œæˆçš„å·¥ä½œ

### é«˜ä¼˜å…ˆçº§

1. **æ¸…ç†é—ç•™æ–¹æ³•**
   - [x] æ£€æŸ¥ `_smart_optimize_prompt` æ˜¯å¦è¿˜åœ¨è¢«ä½¿ç”¨
     - **å‘ç°**: è¢« `image_generator_universal.py` ä½¿ç”¨ï¼ˆline 113ï¼‰
     - **å‘ç°**: åœ¨ `image_generator.py` ä¸­å®šä¹‰ä½†å¯èƒ½ä¸å†è¢«ä¸»ç±»ä½¿ç”¨
   - [ ] ç¡®è®¤ `image_generator_universal.py` çš„ç”¨é€”å’ŒçŠ¶æ€
   - [ ] å¦‚æœä¸å†ä½¿ç”¨ï¼Œåˆ é™¤è¯¥æ–¹æ³•åŠå…¶ä¾èµ–çš„é—ç•™æ–¹æ³•
   - [ ] å¦‚æœä»åœ¨ä½¿ç”¨ï¼Œæ›´æ–°ä¸ºè°ƒç”¨ prompt æ¨¡å—ä¸­çš„å¯¹åº”æ–¹æ³•

2. **éªŒè¯æ–¹æ³•ä½¿ç”¨æƒ…å†µ**
   - [ ] æ£€æŸ¥æ¯ä¸ªé—ç•™æ–¹æ³•æ˜¯å¦è¿˜åœ¨è¢« `image_generator.py` ä¸­çš„å…¶ä»–æ–¹æ³•è°ƒç”¨
   - [ ] å¦‚æœä¸å†ä½¿ç”¨ï¼Œåˆ é™¤è¿™äº›æ–¹æ³•
   - [ ] å¦‚æœä»åœ¨ä½¿ç”¨ï¼Œæ›´æ–°è°ƒç”¨ä¸ºä½¿ç”¨ prompt æ¨¡å—

3. **åˆ é™¤é‡å¤å®šä¹‰**
   - [ ] åˆ é™¤ `_convert_motion_to_prompt()` çš„é‡å¤å®šä¹‰
   - [ ] ç¡®ä¿åªä¿ç•™ä¸€ä¸ªç‰ˆæœ¬ï¼ˆåœ¨ prompt æ¨¡å—ä¸­ï¼‰

### ä¸­ä¼˜å…ˆçº§

4. **å®Œå–„æµ‹è¯•**
   - [ ] è¿è¡Œå®Œæ•´çš„æµ‹è¯•å¥—ä»¶
   - [ ] éªŒè¯é‡æ„åçš„åŠŸèƒ½ä¸é‡æ„å‰ä¸€è‡´
   - [ ] æ€§èƒ½æµ‹è¯•ï¼ˆç¡®ä¿é‡æ„åæ€§èƒ½æœªä¸‹é™ï¼‰

5. **æ›´æ–°æ–‡æ¡£**
   - [ ] æ›´æ–°ä»£ç æ³¨é‡Šï¼Œè¯´æ˜å·²è¿ç§»çš„æ–¹æ³•ä½ç½®
   - [ ] æ›´æ–° README æˆ–ä½¿ç”¨æ–‡æ¡£

### ä½ä¼˜å…ˆçº§

6. **ä»£ç æ¸…ç†**
   - [ ] åˆ é™¤ä¸å†ä½¿ç”¨çš„å¯¼å…¥
   - [ ] æ¸…ç†å†—ä½™æ³¨é‡Š
   - [ ] ç»Ÿä¸€ä»£ç é£æ ¼

---

## ğŸ” è¯¦ç»†æ£€æŸ¥ç»“æœ

### æ–‡ä»¶è¡Œæ•°ç»Ÿè®¡

| æ–‡ä»¶ | è¡Œæ•° | çŠ¶æ€ |
|------|------|------|
| `image_generator.py` | 4116 | âš ï¸ ä»æœ‰é—ç•™ä»£ç  |
| `prompt/__init__.py` | 18 | âœ… |
| `prompt/token_estimator.py` | 125 | âœ… |
| `prompt/parser.py` | 170 | âœ… |
| `prompt/optimizer.py` | 236 | âœ… |
| `prompt/builder.py` | 1316 | âœ… |
| **æ€»è®¡** | **5981** | |

**é¢„æœŸ**: `image_generator.py` åº”è¯¥ä» 5602 è¡Œå‡å°‘åˆ°çº¦ 4000 è¡Œï¼ˆå·²å‡å°‘çº¦ 1500 è¡Œï¼Œç¬¦åˆé¢„æœŸï¼‰

### æ–¹æ³•è°ƒç”¨å…³ç³»

#### `build_prompt` æ–¹æ³•
- âœ… å·²æ­£ç¡®å§”æ‰˜ç»™ `PromptBuilder.build()` (line 1867)
- âœ… æ¥å£ä¿æŒä¸å˜ï¼Œå‘åå…¼å®¹

#### é—ç•™æ–¹æ³•çš„ä½¿ç”¨æƒ…å†µ

éœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥ä»¥ä¸‹æ–¹æ³•æ˜¯å¦ä»åœ¨è¢«ä½¿ç”¨ï¼š

1. `_smart_optimize_prompt` - éœ€è¦æ£€æŸ¥è°ƒç”¨ä½ç½®
2. `_analyze_prompt_importance` - åªåœ¨ `_smart_optimize_prompt` ä¸­è¢«è°ƒç”¨
3. `_estimate_clip_tokens` - åœ¨ `_smart_optimize_prompt` ä¸­è¢«å¤šæ¬¡è°ƒç”¨
4. `_extract_first_keyword` - åœ¨ `_smart_optimize_prompt` ä¸­è¢«è°ƒç”¨
5. å…¶ä»–æ–¹æ³• - éœ€è¦å…¨å±€æœç´¢ç¡®è®¤

---

## ğŸ“Š é‡æ„è¿›åº¦æ€»ç»“

### å·²å®Œæˆ âœ…
- [x] Promptæ¨¡å—ç»“æ„åˆ›å»º
- [x] æ ¸å¿ƒåŠŸèƒ½è¿ç§»ï¼ˆTokenEstimator, Parser, Optimizer, Builderï¼‰
- [x] ImageGenerator é›†æˆ
- [x] è¯­æ³•æ£€æŸ¥å’ŒéªŒè¯

### éƒ¨åˆ†å®Œæˆ â³
- [~] ä»£ç æ¸…ç†ï¼ˆå­˜åœ¨é—ç•™ä»£ç ï¼‰

### å¾…å®Œæˆ â³
- [ ] é—ç•™æ–¹æ³•æ¸…ç†
- [ ] æµ‹è¯•éªŒè¯
- [ ] æ–‡æ¡£æ›´æ–°

---

## ğŸ¯ å»ºè®®çš„ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

1. **æ£€æŸ¥æ–¹æ³•ä½¿ç”¨æƒ…å†µ**
   ```bash
   # æ£€æŸ¥ _smart_optimize_prompt æ˜¯å¦è¿˜åœ¨è¢«è°ƒç”¨
   grep -r "_smart_optimize_prompt" gen_video/ --exclude-dir=prompt
   ```

2. **å¦‚æœä¸å†ä½¿ç”¨ï¼Œåˆ é™¤é—ç•™æ–¹æ³•**
   - åˆ é™¤ `_smart_optimize_prompt` åŠå…¶æ‰€æœ‰ä¾èµ–çš„é—ç•™æ–¹æ³•
   - è¿™å°†å‡å°‘çº¦ 600-800 è¡Œä»£ç 

3. **å¦‚æœä»åœ¨ä½¿ç”¨ï¼Œæ›´æ–°ä¸ºè°ƒç”¨ prompt æ¨¡å—**
   - æ›´æ–° `_smart_optimize_prompt` ä¸ºè°ƒç”¨ `self.prompt_optimizer.optimize()`
   - æ›´æ–°å…¶ä»–é—ç•™æ–¹æ³•çš„è°ƒç”¨

### åç»­æ‰§è¡Œï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

4. **è¿è¡Œæµ‹è¯•**
   - ç¡®ä¿åŠŸèƒ½æ­£å¸¸
   - éªŒè¯æ€§èƒ½æœªä¸‹é™

5. **æ›´æ–°æ–‡æ¡£**
   - è®°å½•å·²å®Œæˆçš„é‡æ„
   - æ›´æ–°ä½¿ç”¨è¯´æ˜

---

## ğŸ“ ç»“è®º

### é‡æ„çŠ¶æ€è¯„ä¼°

**å®Œæˆåº¦**: çº¦ **85-90%**

**ä¸»è¦æˆå°±**:
- âœ… Promptæ¨¡å—å·²æˆåŠŸåˆ›å»ºå¹¶é›†æˆ
- âœ… æ ¸å¿ƒåŠŸèƒ½å·²è¿ç§»
- âœ… `build_prompt` æ–¹æ³•å·²æ­£ç¡®å§”æ‰˜
- âœ… ä»£ç ç»“æ„æ›´æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤

**ä¸»è¦é—®é¢˜**:
- âš ï¸ å­˜åœ¨é—ç•™ä»£ç ï¼ˆçº¦ 1000-1500 è¡Œï¼‰
- âš ï¸ æ–¹æ³•ä¾èµ–å…³ç³»æœªå®Œå…¨æ¸…ç†
- âš ï¸ ä»£ç é‡å¤ï¼ˆ`_convert_motion_to_prompt` å®šä¹‰ä¸¤æ¬¡ï¼‰

**å»ºè®®**:
1. ä¼˜å…ˆæ¸…ç†é—ç•™ä»£ç ï¼Œç‰¹åˆ«æ˜¯ `_smart_optimize_prompt` åŠå…¶ä¾èµ–
2. éªŒè¯æ–¹æ³•ä½¿ç”¨æƒ…å†µï¼Œåˆ é™¤ä¸å†ä½¿ç”¨çš„ä»£ç 
3. å®Œæˆæµ‹è¯•éªŒè¯ï¼Œç¡®ä¿åŠŸèƒ½æ­£å¸¸

**æ€»ä½“è¯„ä»·**: é‡æ„å·¥ä½œå·²ç»å–å¾—å¾ˆå¤§è¿›å±•ï¼Œæ ¸å¿ƒåŠŸèƒ½å·²è¿ç§»å®Œæˆï¼Œä½†ä»éœ€è¦æ¸…ç†é—ç•™ä»£ç æ‰èƒ½ç®—å®Œå…¨å®Œæˆã€‚

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-01-XX  
**ä¸‹æ¬¡æ£€æŸ¥**: æ¸…ç†é—ç•™ä»£ç å

