# 提高韩立人脸相似度调整方案

## 问题分析

参考图已正确加载（`hanli_reference.png` 和 `韩立_mid.png` 是同一张），但生成的人脸不像。

### 当前参数设置

1. **基础权重**：`face_emb_scale: 0.60`（较低）
2. **场景倍数**：
   - 中景：`0.60 * 1.2 = 0.72`
   - 近景：`0.60 * 1.15 = 0.69`
   - 远景：`max(0.60 * 0.80, 0.5) = 0.5`
3. **LoRA 影响**：如果使用 LoRA，会进一步降低：
   - `ip_adapter_scale * 0.6`（`lora_ip_scale_multiplier: 0.6`）
   - 例如中景：`0.72 * 0.6 = 0.432`（太低！）

## 调整方案

### 方案 1：提高基础权重（推荐）

**修改 `config.yaml`：**

```yaml
instantid:
  face_emb_scale: 0.75  # 从 0.60 提高到 0.75（提高 25%）
```

**效果：**
- 中景：`0.75 * 1.2 = 0.90`（很高）
- 近景：`0.75 * 1.15 = 0.86`
- 远景：`max(0.75 * 0.80, 0.5) = 0.60`

**如果使用 LoRA：**
- 中景：`0.90 * 0.6 = 0.54`（仍然较低）
- 建议同时提高 `lora_ip_scale_multiplier`

### 方案 2：提高 LoRA 兼容性（如果使用 LoRA）

**修改 `config.yaml`：**

```yaml
lora:
  enabled: true
  ip_adapter_scale_multiplier: 0.85  # 从 0.6 提高到 0.85
```

**效果：**
- 中景（使用 LoRA）：`0.72 * 0.85 = 0.612`（比之前的 0.432 好很多）

### 方案 3：组合调整（最佳效果）

**同时调整两个参数：**

```yaml
instantid:
  face_emb_scale: 0.75  # 从 0.60 提高到 0.75

lora:
  enabled: true
  ip_adapter_scale_multiplier: 0.85  # 从 0.6 提高到 0.85
```

**效果：**
- 中景（使用 LoRA）：`0.75 * 1.2 * 0.85 = 0.765`（很好的平衡）
- 近景（使用 LoRA）：`0.75 * 1.15 * 0.85 = 0.733`
- 远景（使用 LoRA）：`0.60 * 0.85 = 0.51`

### 方案 4：针对韩立角色禁用 LoRA（最强相似度）

如果只想要最高的人脸相似度，可以针对韩立场景禁用 LoRA：

**修改代码逻辑**（需要代码修改）：
- 在 `generate_image` 中，如果识别到 `hanli` 角色，设置 `use_lora=False`

**或者直接禁用 LoRA：**

```yaml
lora:
  enabled: false  # 完全禁用 LoRA，只使用 InstantID
```

**效果：**
- 中景：`0.75 * 1.2 = 0.90`（最高相似度）
- 近景：`0.75 * 1.15 = 0.86`
- 远景：`0.60`

## 推荐配置

### 推荐 1：平衡方案（保持 LoRA，提高权重）

```yaml
instantid:
  face_emb_scale: 0.75  # 提高基础权重

lora:
  enabled: true
  ip_adapter_scale_multiplier: 0.85  # 提高 LoRA 兼容性
```

### 推荐 2：最高相似度（禁用 LoRA）

```yaml
instantid:
  face_emb_scale: 0.80  # 进一步提高

lora:
  enabled: false  # 禁用 LoRA
```

## 其他可调整参数

### 1. 提高场景倍数（代码中）

如果需要，可以修改 `image_generator.py` 中的倍数：

```python
# 中景/半身像
ip_adapter_scale = self.face_emb_scale * 1.3  # 从 1.2 提高到 1.3

# 近景/特写
ip_adapter_scale = self.face_emb_scale * 1.25  # 从 1.15 提高到 1.25
```

### 2. 提高最小权重限制

修改代码中的最小权重：

```python
# 远景场景
min_ip_adapter_scale = 0.6  # 从 0.5 提高到 0.6
```

## 测试建议

1. **先尝试方案 1**（只提高 `face_emb_scale` 到 0.75）
2. **如果还不够，尝试方案 3**（同时提高两个参数）
3. **如果还是不够，尝试方案 4**（禁用 LoRA）

## 注意事项

1. **权重过高可能导致**：
   - 过度控制，生成结果僵硬
   - 身体比例问题（瘦长脸等）
   - 颜色过度饱和

2. **建议逐步调整**：
   - 每次只调整一个参数
   - 测试效果后再决定是否继续调整

3. **不同场景可能需要不同权重**：
   - 远景需要较低权重（避免过度控制）
   - 中景/近景可以较高权重（确保人脸相似）

