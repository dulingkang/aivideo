# 快速开始 - 声音克隆

## 步骤1: 录制参考音频

### 录制内容

使用 `录制脚本.txt` 中的文本，录制 30-60 秒的音频。

**推荐文本（60秒版本）**:

```
大家好，我是云卷仙音。今天我们要继续讲述凡人修仙传的故事。

在这个故事中，韩立经历了无数的挑战和机遇。他从一个普通的凡人，逐渐成长为强大的修士。

每一次的突破都充满了惊险和刺激。让我们一起跟随韩立的脚步，探索这个神秘的修仙世界。

在这个充满灵气的世界里，修行者们追求长生不老的梦想。韩立是一个普通的凡人，但他有着不屈的意志和坚定的信念。

通过不断的努力和机缘巧合，他逐渐成长为一名强大的修士。在灵界的旅程中，他遇到了许多挑战和机遇。

每一次的突破都让他的修为更上一层楼。这就是凡人修仙传的故事，一个关于坚持和成长的故事。
```

### 录制要求

- **时长**: 30-60秒（推荐）
- **格式**: WAV 或 MP3（可以后续转换）
- **环境**: 安静，无背景噪音
- **语速**: 自然、清晰
- **风格**: 平静、叙述型（符合"云卷仙音"风格）

### 录制工具

1. **Audacity** (推荐)
   - 下载: https://www.audacityteam.org/
   - 录制后导出为 WAV 格式

2. **系统录音工具**
   ```bash
   # Linux
   arecord -d 60 -f cd -t wav reference_raw.wav
   
   # 或使用 ffmpeg
   ffmpeg -f alsa -i default -t 60 -ar 44100 reference_raw.wav
   ```

3. **手机录音**
   - 使用手机录音软件
   - 导出到电脑后处理

## 步骤2: 处理参考音频

### 使用预处理脚本

```bash
source /vepfs-dev/shawn/venv/py312/bin/activate
cd /vepfs-dev/shawn/vid/fanren/gen_video

# 处理音频（转换为24kHz，单声道）
python prepare_reference_audio.py \
    --input /path/to/your/recording.wav \
    --output assets/voices/yunjuanxianyin_reference.wav
```

### 手动处理（使用 FFmpeg）

```bash
# 转换为 24kHz，单声道，16-bit WAV
ffmpeg -i input.wav \
    -ar 24000 \
    -ac 1 \
    -acodec pcm_s16le \
    assets/voices/yunjuanxianyin_reference.wav

# 去除噪音（可选）
ffmpeg -i input.wav \
    -af "highpass=f=200,lowpass=f=3000" \
    -ar 24000 -ac 1 -acodec pcm_s16le \
    assets/voices/yunjuanxianyin_reference.wav
```

### 验证音频

```bash
# 检查音频信息
ffprobe assets/voices/yunjuanxianyin_reference.wav

# 应该显示:
# - Sample rate: 24000 Hz
# - Channels: 1 (mono)
# - Format: pcm_s16le
```

## 步骤3: 配置系统

### 更新配置文件

编辑 `config.yaml`:

```yaml
tts:
  engine: "chattts"
  reference_audio: "assets/voices/yunjuanxianyin_reference.wav"
  temperature: 0.7
```

### 创建目录

```bash
mkdir -p assets/voices
```

## 步骤4: 安装 ChatTTS（如果未安装）

```bash
source /vepfs-dev/shawn/venv/py312/bin/activate

# 安装 ChatTTS
pip install chattts

# 如果空间不足，使用 --no-cache-dir
pip install --no-cache-dir chattts
```

## 步骤5: 测试声音克隆

### 创建测试脚本

创建 `test_voice_clone.py`:

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import ChatTTS
import soundfile as sf
import os

# 加载模型
print("加载 ChatTTS 模型...")
chat = ChatTTS.Chat()
chat.load(compile=False)

# 加载参考音频
ref_audio_path = "assets/voices/yunjuanxianyin_reference.wav"
if os.path.exists(ref_audio_path):
    ref_audio, sr = sf.read(ref_audio_path)
    print(f"✓ 加载参考音频: {ref_audio_path}")
    print(f"  采样率: {sr} Hz")
    print(f"  时长: {len(ref_audio) / sr:.2f} 秒")
else:
    print(f"✗ 参考音频不存在: {ref_audio_path}")
    ref_audio = None

# 测试文本
test_texts = [
    "当韩立再次睁开双眼，发现自己身处一片茫茫黄沙之中。",
    "他艰难地坐起身，拍了拍身上的沙尘，感受着身体的虚弱。",
    "韩立盘坐在沙地上，闭目内视，检查自身修为状况。",
]

# 生成语音
for i, text in enumerate(test_texts):
    print(f"\n生成语音 {i+1}: {text}")
    
    if ref_audio is not None:
        # 使用参考音频
        wavs = chat.infer(
            [text],
            use_decoder=True,
            ref_audio=ref_audio,
            temperature=0.7,
        )
    else:
        # 使用默认声音
        wavs = chat.infer(
            [text],
            use_decoder=True,
            temperature=0.7,
        )
    
    # 保存音频
    output_path = f"test_output_{i+1}.wav"
    sf.write(output_path, wavs[0], 24000)
    print(f"✓ 已保存: {output_path}")

print("\n✓ 测试完成！请播放 test_output_*.wav 文件检查效果。")
```

### 运行测试

```bash
source /vepfs-dev/shawn/venv/py312/bin/activate
python test_voice_clone.py
```

## 步骤6: 使用 TTS 生成器

### 使用命令行

```bash
source /vepfs-dev/shawn/venv/py312/bin/activate
cd /vepfs-dev/shawn/vid/fanren/gen_video

# 生成语音（自动使用参考音频）
python tts_generator.py \
    --text "当韩立再次睁开双眼，发现自己身处一片茫茫黄沙之中。" \
    --output outputs/test_audio.wav
```

### 使用 Python API

```python
from tts_generator import TTSGenerator

# 初始化生成器
generator = TTSGenerator("config.yaml")

# 生成语音（自动使用 config.yaml 中的参考音频）
generator.generate(
    "当韩立再次睁开双眼，发现自己身处一片茫茫黄沙之中。",
    "outputs/test_audio.wav"
)
```

## 步骤7: 在完整流水线中使用

### 运行完整流水线

```bash
source /vepfs-dev/shawn/venv/py312/bin/activate
cd /vepfs-dev/shawn/vid/fanren/gen_video

# 运行完整流水线（会自动使用参考音频）
python run_pipeline.py \
    --markdown ../灵界/2.md \
    --image-dir ../灵界/img2/jpgsrc \
    --output lingjie_ep2
```

## 常见问题

### 1. 参考音频未生效

**检查**:
- 参考音频路径是否正确
- 参考音频格式是否正确（24kHz, 单声道, WAV）
- 配置文件中的路径是否正确

### 2. 声音克隆效果不好

**改进**:
- 使用更长的参考音频（60秒+）
- 确保参考音频质量高（无噪音，清晰）
- 调整 temperature 参数（0.5-0.8）

### 3. 内存不足

**解决**:
- 使用更短的参考音频
- 减少 batch size
- 使用 CPU 模式（较慢）

## 下一步

1. ✅ 录制参考音频
2. ✅ 处理参考音频
3. ✅ 配置系统
4. ✅ 测试声音克隆
5. ✅ 在完整流水线中使用

## 参考

- [声音克隆指南](声音克隆指南.md) - 详细指南
- [录制脚本](录制脚本.txt) - 录制文本
- [预处理脚本](prepare_reference_audio.py) - 音频处理工具

