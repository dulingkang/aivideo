# CosyVoice2 官方用法对比

## 官方示例代码

```python
cosyvoice = CosyVoice2('iic/CosyVoice2-0.5B', load_jit=False, load_trt=False, fp16=False)

# zero_shot usage
prompt_speech_16k = load_wav('zero_shot_prompt.wav', 16000)
for i, j in enumerate(cosyvoice.inference_zero_shot(
    '收到好友从远方寄来的生日礼物，那份意外的惊喜与深深的祝福让我心中充满了甜蜜的快乐，笑容如花儿般绽放。', 
    '希望你以后能够做的比我还好呦。', 
    prompt_speech_16k, 
    stream=False
)):
    torchaudio.save('zero_shot_{}.wav'.format(i), j['tts_speech'], cosyvoice.sample_rate)

# cross_lingual usage
for i, j in enumerate(cosyvoice.inference_cross_lingual(
    '在他讲述那个荒诞故事的过程中，他突然[laughter]停下来，因为他自己也被逗笑了[laughter]。', 
    prompt_speech_16k, 
    stream=False
)):
    torchaudio.save('fine_grained_control_{}.wav'.format(i), j['tts_speech'], cosyvoice.sample_rate)

# instruct2 usage
for i, j in enumerate(cosyvoice.inference_instruct2(
    '收到好友从远方寄来的生日礼物，那份意外的惊喜与深深的祝福让我心中充满了甜蜜的快乐，笑容如花儿般绽放。', 
    '用四川话说这句话', 
    prompt_speech_16k, 
    stream=False
)):
    torchaudio.save('instruct_{}.wav'.format(i), j['tts_speech'], cosyvoice.sample_rate)
```

## API 定义（从源码）

### inference_zero_shot
```python
def inference_zero_shot(
    self, 
    tts_text, 
    prompt_text, 
    prompt_speech_16k, 
    zero_shot_spk_id='', 
    stream=False, 
    speed=1.0, 
    text_frontend=True  # 默认值
):
```

### inference_cross_lingual
```python
def inference_cross_lingual(
    self, 
    tts_text, 
    prompt_speech_16k, 
    zero_shot_spk_id='', 
    stream=False, 
    speed=1.0, 
    text_frontend=True  # 默认值
):
```

### inference_instruct2
```python
def inference_instruct2(
    self, 
    tts_text, 
    instruct_text, 
    prompt_speech_16k, 
    zero_shot_spk_id='', 
    stream=False, 
    speed=1.0, 
    text_frontend=True  # 默认值
):
```

## 工程中的用法

### zero_shot 模式
```python
# 工程代码 (tts_generator.py:426-431)
text_frontend = kwargs.get("text_frontend", True)  # 默认 True
for i, result in enumerate(self.cosyvoice.inference_zero_shot(
    text,
    prompt_text if prompt_text else "希望你以后能够做的比我还好呦。",
    prompt_speech_16k,
    stream=self.cosyvoice_stream,
    text_frontend=text_frontend
)):
```

**对比结果**：
- ✅ 参数顺序正确：`tts_text, prompt_text, prompt_speech_16k`
- ✅ 传递了 `stream` 参数
- ✅ 传递了 `text_frontend` 参数（虽然官方示例没显式传递，但 API 支持）
- ✅ 使用了正确的参数名

### cross_lingual 模式
```python
# 工程代码 (tts_generator.py:502-507)
text_frontend = kwargs.get("text_frontend", True)
for i, result in enumerate(self.cosyvoice.inference_cross_lingual(
    text,
    prompt_speech_16k,
    stream=self.cosyvoice_stream,
    text_frontend=text_frontend
)):
```

**对比结果**：
- ✅ 参数顺序正确：`tts_text, prompt_speech_16k`
- ✅ 传递了 `stream` 参数
- ✅ 传递了 `text_frontend` 参数
- ✅ 使用了正确的参数名

### instruct2 模式
```python
# 工程代码 (tts_generator.py:470-476)
text_frontend = kwargs.get("text_frontend", True)
for i, result in enumerate(self.cosyvoice.inference_instruct2(
    text,
    instruction,
    prompt_speech_16k,
    stream=self.cosyvoice_stream,
    text_frontend=text_frontend
)):
```

**对比结果**：
- ✅ 参数顺序正确：`tts_text, instruct_text, prompt_speech_16k`
- ✅ 传递了 `stream` 参数
- ✅ 传递了 `text_frontend` 参数
- ✅ 使用了正确的参数名

## 关键差异

### 1. text_frontend 参数
- **官方示例**：没有显式传递 `text_frontend`，使用默认值 `True`
- **工程代码**：显式传递 `text_frontend=True`（默认值）
- **README 说明**：如果要复现官网效果，需要 `text_frontend=False`
- **工程选择**：使用 `text_frontend=True` 是为了支持中文文本规范化

### 2. 音频加载方式
- **官方示例**：直接使用 `load_wav('zero_shot_prompt.wav', 16000)`，要求 WAV 格式
- **工程代码**：支持多种格式（MP3、FLAC 等），自动转换为 16kHz WAV
  - 优先使用 `torchaudio` 直接加载
  - 备用方案使用 `librosa` 转换

## 结论

✅ **工程中的用法是正确的**，与官方 API 完全兼容：

1. **参数顺序正确**：所有模式的参数顺序都与官方 API 定义一致
2. **参数类型正确**：所有参数的类型和格式都正确
3. **功能扩展合理**：
   - 支持多种音频格式（不仅仅是 WAV）
   - 使用 `text_frontend=True` 以支持中文文本规范化
   - 提供了更好的错误处理和日志输出

## 建议

如果遇到问题，可以尝试：

1. **使用官方示例的 prompt_text 和 prompt_speech 测试**：
   ```python
   # 使用官方示例的配置
   tts.synthesize_cosyvoice(
       '收到好友从远方寄来的生日礼物，那份意外的惊喜与深深的祝福让我心中充满了甜蜜的快乐，笑容如花儿般绽放。',
       'test_official.wav',
       prompt_text='希望你以后能够做的比我还好呦。',
       prompt_speech='CosyVoice/asset/zero_shot_prompt.wav',  # 如果有官方示例音频
       text_frontend=False  # 尝试使用 False 看是否能复现官网效果
   )
   ```

2. **检查 prompt_text 与 prompt_speech 的匹配**：
   - 确保 `prompt_text` 与参考音频的实际内容完全匹配
   - 使用 WhisperX 识别参考音频的实际内容

3. **如果仍然有问题**：
   - 检查音频质量（音量、清晰度）
   - 尝试使用 16kHz WAV 格式的参考音频
   - 检查模型是否正确加载

