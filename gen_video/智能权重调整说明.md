# 智能权重调整说明

## 概述

系统现在使用智能分析的方式，综合调整各个权重，以更好地表现图片。权重调整基于意图分析器的综合分析结果，考虑多个因素。

## 权重调整因素

### 1. 主要实体类型
- **物体场景**：提高物体权重（1.8+），降低角色权重（0.0）
- **角色场景**：根据视角明确程度调整角色权重
  - 明确要求正面：提高角色和视角权重（1.7+，1.8+）
  - 明确要求背面：适度降低角色权重（1.3+）
  - 未明确指定：使用基础权重（1.5）

### 2. 视角类型
- **特写/远景**：提高镜头权重（1.8+）
- **正面视角**：中等镜头权重（1.5）
- **背面视角**：降低角色权重

### 3. 动作类型
- **动态动作**：提高动作权重（1.5）
- **静态动作**：降低动作权重（1.0），提高构图权重（1.6）
- **物体运动**：提高构图权重（1.8）

### 4. 强调项数量
- **多个强调项（≥3）**：提高实体和构图权重（+0.2，上限2.0）
- **无强调项但有主要实体**：适度提高实体权重（+0.1，上限1.8）

### 5. 场景复杂度
- **复杂场景（文本长度>50）**：适度降低各权重（-0.1，下限1.0），避免冲突
- **简单场景（文本长度<20）**：适度提高关键权重（+0.2，上限1.8）

## 权重调整结果

意图分析器返回 `weight_adjustments` 字典，包含：

```python
{
    "character_weight": float,  # 角色描述权重
    "viewpoint_weight": float,  # 视角权重
    "camera_weight": float,    # 镜头类型权重
    "action_weight": float,    # 动作描述权重
    "composition_weight": float,  # 构图描述权重
    "entity_weight": float,   # 主要实体权重
}
```

## 应用方式

在 `build_prompt` 中，所有权重都基于 `weight_adjustments` 动态调整：

1. **主要实体权重**：使用 `entity_weight`
2. **视角权重**：使用 `viewpoint_weight`
3. **镜头权重**：使用 `camera_weight`
4. **动作权重**：使用 `action_weight`
5. **构图权重**：使用 `composition_weight`

## 优势

1. **智能性**：综合考虑多个因素，而不是单一规则
2. **通用性**：适用于所有场景类型，不依赖硬编码规则
3. **平衡性**：自动平衡各元素权重，避免冲突
4. **可扩展性**：通过改进意图分析器即可优化所有场景

## 示例

### 示例1：物体场景（卷轴展开）
- **主要实体**：物体（卷轴）
- **动作类型**：物体运动
- **权重调整**：
  - `entity_weight`: 1.8（物体需要高权重）
  - `character_weight`: 0.0（无角色）
  - `composition_weight`: 1.8（物体运动，构图重要）
  - `action_weight`: 1.2（默认）

### 示例2：角色正面场景
- **主要实体**：角色
- **视角类型**：正面（明确要求）
- **权重调整**：
  - `character_weight`: 1.7（角色重要）
  - `viewpoint_weight`: 1.8（正面视角明确）
  - `camera_weight`: 1.5（中等镜头）
  - `action_weight`: 1.2（默认）

### 示例3：复杂场景（多个强调项）
- **主要实体**：角色
- **强调项数量**：≥3
- **权重调整**：
  - `entity_weight`: 1.7（1.5 + 0.2）
  - `composition_weight`: 1.6（1.4 + 0.2）
  - 其他权重保持默认

## 预期效果

通过智能权重调整，系统能够：
1. **更准确地表现主要元素**：根据场景类型自动调整权重
2. **避免权重冲突**：复杂场景自动降低权重，避免冲突
3. **提高生成质量**：权重分配更合理，生成效果更好
4. **适应不同场景**：自动适应物体场景、角色场景、复杂场景等

