# 系统架构流程图 v2.1

## 完整流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                        输入: JSON Scene v2.1                     │
│  {                                                               │
│    "intent": "character_intro",                                  │
│    "character": {"id": "hanli", "pose": "lying", ...},         │
│    "camera": {"shot": "wide", ...},                             │
│    "prompt": {...}                                               │
│  }                                                               │
└────────────────────────────┬────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   阶段1: 规则引擎锁定 (v2.1核心)                 │
│                                                                  │
│  ┌──────────────────────┐      ┌──────────────────────────┐    │
│  │ ExecutionRulesV21    │      │ CharacterAnchorManager   │    │
│  │                      │      │                          │    │
│  │ 1. Intent → Shot     │      │ 1. 加载LoRA (Layer 0)   │    │
│  │    "character_intro" │      │    hanli_v1.safetensors  │    │
│  │    → MEDIUM          │      │                          │    │
│  │                      │      │ 2. 条件启用InstantID     │    │
│  │ 2. Shot → Pose验证   │      │    (Layer 1, 可选)      │    │
│  │    WIDE + lying      │      │                          │    │
│  │    → 自动修正为STAND │      │ 3. 性别负锁 (Layer 2)   │    │
│  │                      │      │    ["female", "woman"]   │    │
│  │ 3. Model路由         │      │                          │    │
│  │    MEDIUM + 有人物   │      └──────────────────────────┘    │
│  │    → Flux + PuLID    │                                      │
│  └──────────────────────┘                                      │
│                                                                  │
│  输出: 锁定的Shot/Pose/Model + 角色锚配置                        │
└────────────────────────────┬────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   阶段2: Prompt构建 (v2.1简化)                   │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Prompt Builder (只做模板填充，不做决策)                   │  │
│  │                                                           │  │
│  │ 输入:                                                     │  │
│  │   - shot_type: "medium" (已锁定)                         │  │
│  │   - pose_type: "stand" (已修正)                          │  │
│  │   - scene_description: [...]                             │  │
│  │   - character_description: [...]                         │  │
│  │                                                           │  │
│  │ 处理:                                                     │  │
│  │   1. 填充Shot描述模板                                     │  │
│  │   2. 填充Pose描述模板                                     │  │
│  │   3. 合并场景描述                                         │  │
│  │   4. 合并角色描述                                         │  │
│  │   5. 添加性别负锁                                         │  │
│  │                                                           │  │
│  │ 输出:                                                     │  │
│  │   "中景，上半身，人物中等大小, "                           │  │
│  │   "standing pose, upright posture, "                     │  │
│  │   "desert environment, ..."                              │  │
│  │   "Han Li, male cultivator, ..."                         │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   阶段3: 图像生成                                 │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ ImageGenerator                                           │  │
│  │                                                           │  │
│  │ 1. 模型选择 (硬规则):                                     │  │
│  │    MEDIUM + 有人物 → Flux                                │  │
│  │                                                           │  │
│  │ 2. 身份引擎 (硬规则):                                     │  │
│  │    Flux → PuLID                                          │  │
│  │                                                           │  │
│  │ 3. 加载角色锚:                                           │  │
│  │    - LoRA: hanli_v1.safetensors (weight=0.6)            │  │
│  │    - InstantID: 条件启用 (face_visible=True)            │  │
│  │                                                           │  │
│  │ 4. 生成图像:                                             │  │
│  │    - Prompt: [从Prompt Builder]                          │  │
│  │    - Negative: [基础] + [性别负锁]                       │  │
│  │    - LoRA: hanli_v1 (0.6)                               │  │
│  │    - PuLID: [参考图] (strength=0.75)                     │  │
│  │                                                           │  │
│  │ 输出: scene_001.png                                      │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   阶段4: 视频生成                                 │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ VideoGenerator (HunyuanVideo)                            │  │
│  │                                                           │  │
│  │ 输入:                                                     │  │
│  │   - 图像: scene_001.png                                  │  │
│  │   - Prompt: [从Prompt Builder]                           │  │
│  │   - 时长: 4.0秒 (scene.duration_sec)                     │  │
│  │                                                           │  │
│  │ 处理:                                                     │  │
│  │   - 分辨率: 512x768 (竖屏)                                │  │
│  │   - 帧数: 96帧 (4.0秒 × 24fps)                           │  │
│  │   - 步数: 25步 (蒸馏版)                                   │  │
│  │                                                           │  │
│  │ 输出: scene_001_video.mp4                                │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   阶段5: 音频生成                                 │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ TTSGenerator (CosyVoice)                                  │  │
│  │                                                           │  │
│  │ 输入:                                                     │  │
│  │   - 文本: "韩立保持不动，静静体会脚下炽热的沙地。"         │  │
│  │   - 声音: "yunjuan_xianyin"                              │  │
│  │   - 情感: "tense"                                         │  │
│  │                                                           │  │
│  │ 输出: scene_001_audio.wav                                │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                   阶段6: 视频合成                                 │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ VideoComposer                                             │  │
│  │                                                           │  │
│  │ 输入:                                                     │  │
│  │   - 视频: scene_001_video.mp4                            │  │
│  │   - 音频: scene_001_audio.wav                             │  │
│  │   - 字幕: "韩立保持不动，静静体会脚下炽热的沙地。"         │  │
│  │                                                           │  │
│  │ 处理:                                                     │  │
│  │   1. 视频片段拼接                                         │  │
│  │   2. 音频同步                                             │  │
│  │   3. 字幕生成                                             │  │
│  │   4. BGM混音 (可选)                                       │  │
│  │                                                           │  │
│  │ 输出: final_video.mp4                                     │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────┘
                              ↓
                        ┌──────────┐
                        │ 最终视频  │
                        └──────────┘
```

## v2.1关键改进点

### 1. 规则引擎锁定（阶段1）

**v2（旧）**:
```
LLM分析场景 → 动态判断Shot/Pose/Model → 不稳定
```

**v2.1（新）**:
```
硬映射表 → 锁定Shot/Pose/Model → 稳定
```

### 2. 角色锚系统（阶段1）

**v2（旧）**:
```
InstantID为主 → 失败则角色丢失
```

**v2.1（新）**:
```
LoRA为主 → InstantID为辅 → 角色永不丢失
```

### 3. Prompt构建（阶段2）

**v2（旧）**:
```
LLM分析 → 动态调整Shot/Pose → 违反硬规则
```

**v2.1（新）**:
```
模板填充 → 使用已锁定的Shot/Pose → 符合硬规则
```

### 4. 图像生成（阶段3）

**v2（旧）**:
```
稳定性评分 → 动态切换模型 → 不可预测
```

**v2.1（新）**:
```
硬路由表 → 固定模型选择 → 可预测
```

## 数据流关键节点

### 节点1: 规则引擎输出

```python
{
    "shot": {
        "type": "medium",
        "source": "intent_mapping",
        "allow_override": False
    },
    "pose": {
        "type": "stand",
        "validated_by": "shot_pose_rules",
        "auto_corrected": True  # 从"lying"修正为"stand"
    },
    "model": {
        "scene_model": "flux",
        "identity_engine": "pulid"
    },
    "character_anchor": {
        "lora_path": "hanli_v1.safetensors",
        "lora_weight": 0.6,
        "instantid_enabled": True,
        "instantid_strength": 0.75,
        "gender_negative_lock": ["female", "woman", "girl", ...]
    }
}
```

### 节点2: Prompt输出

```
"中景，上半身，人物中等大小, standing pose, upright posture, 
desert environment, dry ground with scattered leaves, 
Han Li, male cultivator, rough appearance, dust-covered clothes"
```

### 节点3: 图像生成参数

```python
{
    "model": "flux1-dev",
    "identity_engine": "pulid",
    "lora": {
        "path": "hanli_v1.safetensors",
        "weight": 0.6
    },
    "instantid": {
        "enabled": True,
        "strength": 0.75,
        "reference_image": "hanli_reference.png"
    },
    "negative_prompt": [
        "low quality", "blurry",
        "female", "woman", "girl",  # 性别负锁
        ...
    ]
}
```

## 错误处理流程

### 场景1: 不合法组合（wide + lying）

```
输入: shot="wide", pose="lying"
  ↓
规则引擎检测: wide禁止lying
  ↓
自动修正: pose="stand"
  ↓
继续流程（不失败）
```

### 场景2: InstantID失败

```
InstantID检测失败
  ↓
降级: 仅使用LoRA
  ↓
继续流程（角色不丢失）
```

### 场景3: 模型生成失败

```
Flux生成失败
  ↓
记录错误（不自动切换）
  ↓
返回错误（由上层处理）
```

## 性能优化点

1. **规则引擎**: 表驱动，<10ms
2. **Prompt构建**: 模板填充，<100ms
3. **图像生成**: 缓存LoRA加载
4. **视频生成**: 批量处理多个场景

