# CosyVoice2 é—®é¢˜è¯Šæ–­ - å½“å‰çŠ¶æ€å’Œä¸‹ä¸€æ­¥

## âœ… å·²ç¡®è®¤çš„ä¿¡æ¯

1. **æ¨¡å‹æ–‡ä»¶å®Œæ•´** âœ“
   - æ‰€æœ‰å¿…éœ€æ–‡ä»¶éƒ½å­˜åœ¨
   - æ–‡ä»¶å¤§å°æ­£å¸¸ï¼ˆllm.pt 1.9G, flow.pt 430M ç­‰ï¼‰
   - `spk2info.pt` ä¸å­˜åœ¨ä½†ä¸å½±å“ï¼ˆä»£ç ä¼šè‡ªåŠ¨åˆ›å»ºç©ºå­—å…¸ï¼‰

2. **å®˜æ–¹ç¤ºä¾‹ä¹Ÿä¸æ­£å¸¸** âš ï¸
   - è¯´æ˜é—®é¢˜ä¸åœ¨ prompt_text åŒ¹é…
   - é—®é¢˜å¯èƒ½åœ¨æ¨¡å‹åŠ è½½ã€æ¨ç†æˆ–éŸ³é¢‘ä¿å­˜

## ğŸ” éœ€è¦æ£€æŸ¥çš„å…³é”®ç‚¹

### 1. ç”Ÿæˆçš„éŸ³é¢‘æ–‡ä»¶å†…å®¹ï¼ˆæœ€é‡è¦ï¼‰

**æ£€æŸ¥æ–¹æ³•**ï¼ˆåœ¨ Python ç¯å¢ƒä¸­ï¼‰ï¼š
```python
import torchaudio
import torch

# æ£€æŸ¥ç”Ÿæˆçš„éŸ³é¢‘æ–‡ä»¶
audio_file = "test_official_example.wav"
waveform, sr = torchaudio.load(audio_file)

print(f"é‡‡æ ·ç‡: {sr} Hz")
print(f"å½¢çŠ¶: {waveform.shape}")
print(f"æ•°å€¼èŒƒå›´: [{waveform.min():.4f}, {waveform.max():.4f}]")

# è®¡ç®— RMS èƒ½é‡
waveform_mono = waveform.mean(dim=0) if waveform.shape[0] > 1 else waveform.squeeze(0)
rms = torch.sqrt(torch.mean(waveform_mono ** 2))
print(f"RMS èƒ½é‡: {rms:.4f}")

# å…³é”®åˆ¤æ–­
if rms < 0.001:
    print("âš  éŸ³é¢‘èƒ½é‡å¤ªä½ï¼æ¨¡å‹è¾“å‡ºå¼‚å¸¸")
elif rms < 0.01:
    print("âš  éŸ³é¢‘èƒ½é‡è¾ƒä½")
else:
    print("âœ“ éŸ³é¢‘èƒ½é‡æ­£å¸¸")
```

**å¦‚æœ RMS < 0.001**ï¼š
- æ¨¡å‹è¾“å‡ºå¼‚å¸¸
- å¯èƒ½æ˜¯æ¨¡å‹åŠ è½½é—®é¢˜
- å¯èƒ½æ˜¯æ¨ç†è¿‡ç¨‹é—®é¢˜

**å¦‚æœ RMS æ­£å¸¸ï¼ˆ> 0.01ï¼‰ä½†å¬ä¸æ¸…**ï¼š
- å¯èƒ½æ˜¯éŸ³é¢‘ä¿å­˜æ ¼å¼é—®é¢˜
- å¯èƒ½æ˜¯æ’­æ”¾å™¨é—®é¢˜
- å°è¯•ç”¨ä¸åŒæ’­æ”¾å™¨æ’­æ”¾

### 2. æ¨¡å‹åŠ è½½æ—¶çš„æ—¥å¿—

æ£€æŸ¥æ¨¡å‹åŠ è½½æ—¶æ˜¯å¦æœ‰è­¦å‘Šæˆ–é”™è¯¯ï¼š
- æ˜¯å¦æœ‰ CUDA ç›¸å…³è­¦å‘Š
- æ˜¯å¦æœ‰æ¨¡å‹æ–‡ä»¶åŠ è½½è­¦å‘Š
- æ˜¯å¦æœ‰é‡åŒ–ç›¸å…³è­¦å‘Š

### 3. æ¨ç†è¿‡ç¨‹çš„æ—¥å¿—

æ£€æŸ¥ç”ŸæˆéŸ³é¢‘æ—¶çš„æ—¥å¿—ï¼š
- æ˜¯å¦æœ‰æ¨ç†é”™è¯¯
- æ˜¯å¦æœ‰æ•°å€¼å¼‚å¸¸è­¦å‘Š
- RTFï¼ˆå®æ—¶å› å­ï¼‰æ˜¯å¦æ­£å¸¸

## ğŸ› ï¸ å»ºè®®çš„æ’æŸ¥æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ£€æŸ¥ç”Ÿæˆçš„éŸ³é¢‘æ–‡ä»¶ï¼ˆæœ€é‡è¦ï¼‰

åœ¨ Python ç¯å¢ƒä¸­è¿è¡Œï¼š
```python
# æ£€æŸ¥æ‰€æœ‰ç”Ÿæˆçš„æµ‹è¯•æ–‡ä»¶
import torchaudio
import torch

files = [
    "test_official_example.wav",
    "test_official_example_frontend_true.wav",
    "test_current_config.wav",
    "test_current_config_frontend_false.wav",
]

for f in files:
    try:
        w, sr = torchaudio.load(f)
        w_mono = w.mean(dim=0) if w.shape[0] > 1 else w.squeeze(0)
        rms = torch.sqrt(torch.mean(w_mono ** 2))
        print(f"{f}: RMS={rms:.6f}, èŒƒå›´=[{w_mono.min():.4f}, {w_mono.max():.4f}]")
    except:
        print(f"{f}: æ— æ³•åŠ è½½")
```

### æ­¥éª¤ 2ï¼šå¦‚æœ RMS å¾ˆä½ï¼Œå°è¯•æœ€ç®€å•çš„æµ‹è¯•

```python
from cosyvoice.cli.cosyvoice import CosyVoice2
from cosyvoice.utils.file_utils import load_wav
import torchaudio
import torch

# åŠ è½½æ¨¡å‹
cosyvoice = CosyVoice2(
    'CosyVoice/pretrained_models/CosyVoice2-0.5B',
    fp16=False  # ä½¿ç”¨ fp32
)

# ä½¿ç”¨å®˜æ–¹ç¤ºä¾‹
prompt = load_wav('CosyVoice/asset/zero_shot_prompt.wav', 16000)

# ç”Ÿæˆæœ€çŸ­æ–‡æœ¬
for result in cosyvoice.inference_zero_shot(
    'å¥½',  # åªä¸€ä¸ªå­—
    'å¸Œæœ›ä½ ä»¥åèƒ½å¤Ÿåšçš„æ¯”æˆ‘è¿˜å¥½å‘¦ã€‚',
    prompt,
    stream=False,
    text_frontend=False
):
    audio = result['tts_speech']
    print(f"éŸ³é¢‘å½¢çŠ¶: {audio.shape}")
    print(f"æ•°å€¼èŒƒå›´: [{audio.min():.4f}, {audio.max():.4f}]")
    rms = torch.sqrt(torch.mean(audio**2))
    print(f"RMS: {rms:.6f}")
    
    # ä¿å­˜
    if audio.dim() == 1:
        audio = audio.unsqueeze(0)
    torchaudio.save('minimal_test.wav', audio, cosyvoice.sample_rate)
    break
```

### æ­¥éª¤ 3ï¼šæ£€æŸ¥æ¨¡å‹åŠ è½½

```python
from cosyvoice.cli.cosyvoice import CosyVoice2

cosyvoice = CosyVoice2(
    'CosyVoice/pretrained_models/CosyVoice2-0.5B',
    fp16=False
)

print(f"é‡‡æ ·ç‡: {cosyvoice.sample_rate}")
print(f"æ¨¡å‹ç±»å‹: {type(cosyvoice.model)}")
print(f"å‰ç«¯ç±»å‹: {type(cosyvoice.frontend)}")

# æ£€æŸ¥æ¨¡å‹æ˜¯å¦åœ¨æ­£ç¡®çš„è®¾å¤‡ä¸Š
import torch
if torch.cuda.is_available():
    print(f"CUDA å¯ç”¨: {torch.cuda.is_available()}")
    print(f"æ¨¡å‹è®¾å¤‡: {next(cosyvoice.model.llm.parameters()).device}")
```

### æ­¥éª¤ 4ï¼šå¦‚æœ RMS æ­£å¸¸ä½†å¬ä¸æ¸…

1. **æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶æ ¼å¼**ï¼š
   ```bash
   ffprobe test_official_example.wav
   ```

2. **å°è¯•ä¸åŒæ’­æ”¾å™¨**ï¼š
   - VLC
   - Audacity
   - ç³»ç»Ÿé»˜è®¤æ’­æ”¾å™¨

3. **æ£€æŸ¥éŸ³é¢‘æ˜¯å¦æŸå**ï¼š
   ```python
   # å°è¯•é‡æ–°åŠ è½½å¹¶ä¿å­˜
   import torchaudio
   w, sr = torchaudio.load('test_official_example.wav')
   torchaudio.save('test_reloaded.wav', w, sr)
   ```

## ğŸ¯ æœ€å¯èƒ½çš„åŸå› ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

1. **æ¨¡å‹è¾“å‡ºå¼‚å¸¸ï¼ˆRMS < 0.001ï¼‰** - æœ€å¯èƒ½
   - æ¨¡å‹åŠ è½½ä¸å®Œæ•´
   - æ¨ç†è¿‡ç¨‹å‡ºé”™
   - CUDA/GPU é—®é¢˜

2. **éŸ³é¢‘ä¿å­˜æ ¼å¼é—®é¢˜** - å¦‚æœ RMS æ­£å¸¸
   - æ ¼å¼ä¸æ­£ç¡®
   - é‡‡æ ·ç‡é”™è¯¯

3. **æ’­æ”¾å™¨é—®é¢˜** - å¦‚æœæ–‡ä»¶æœ¬èº«æ­£å¸¸
   - æ’­æ”¾å™¨ä¸æ”¯æŒè¯¥æ ¼å¼
   - æ’­æ”¾å™¨è®¾ç½®é—®é¢˜

## ğŸ“‹ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³æ£€æŸ¥**ï¼šè¿è¡Œæ­¥éª¤ 1ï¼ŒæŸ¥çœ‹ç”Ÿæˆçš„éŸ³é¢‘æ–‡ä»¶çš„ RMS èƒ½é‡
2. **æ ¹æ®ç»“æœ**ï¼š
   - å¦‚æœ RMS < 0.001ï¼šæ£€æŸ¥æ¨¡å‹åŠ è½½å’Œæ¨ç†è¿‡ç¨‹
   - å¦‚æœ RMS æ­£å¸¸ï¼šæ£€æŸ¥éŸ³é¢‘ä¿å­˜æ ¼å¼å’Œæ’­æ”¾å™¨
3. **æŠ¥å‘Šç»“æœ**ï¼šå‘Šè¯‰æˆ‘æ£€æŸ¥ç»“æœï¼Œæˆ‘ä¼šè¿›ä¸€æ­¥åˆ†æ

