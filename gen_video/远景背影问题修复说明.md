# 远景背影问题修复说明

## 📊 问题描述

用户反馈：
1. **还是好多带人物的，都是远景和背影**
2. **第一张和最后一张效果比较差**：
   - 第一张显示的是一些兵器（应该是卷轴）
   - 最后一张显示的三个女人（应该是城市轮廓）
3. **分析报告**：总场景数22，不匹配项1，缺失项18，优化建议26

## ✅ 已实施的修复

### 1. 优化物体描述，避免生成错误物体（`image_generator.py`）

**优化内容**：
- **卷轴场景**：添加 `golden scroll` 和负面提示 `no weapons, no tools`，避免生成兵器
- **城市场景**：添加 `city silhouette` 和负面提示 `no people, no characters`，避免生成人物

**代码位置**：
```python
# image_generator.py, line 1940-1952
if "scroll" in entity_text.lower() or "卷轴" in entity_text.lower():
    priority_parts.append(f"({entity_text}, golden scroll, prominent, clearly visible, main element, no weapons, no tools:{entity_weight:.2f})")
elif "city" in entity_text.lower() or "城市" in entity_text.lower() or "immortal city" in entity_text.lower():
    priority_parts.append(f"({entity_text}, city silhouette, prominent, clearly visible, main element, no people, no characters:{entity_weight:.2f})")
```

### 2. 人物场景默认使用中景而非远景（`image_generator.py`）

**优化内容**：
- **默认中景**：对于人物场景，如果没有检测到镜头关键词，默认添加中景描述（权重2.0）
- **避免远景**：中景确保人物清晰可见且正面，避免远景导致人物太小和背影

**代码位置**：
```python
# image_generator.py, line 3615-3625
# 对于人物场景，默认使用中景而非远景，避免人物太小和背影
if include_character:
    priority_parts.insert(1, "(medium shot, character clearly visible, front view:2.0)")
    print(f"  ⚠ 未检测到任何镜头关键词，人物场景默认添加中景描述（高权重2.0），避免远景和背影")
```

### 3. 远景场景强制添加正面朝向（`image_generator.py`）

**优化内容**：
- **强制正面**：远景场景强制添加正面朝向提示（权重1.8），避免背影
- **排除背影**：通过正面朝向提示和负面提示，确保远景场景也显示正面

**代码位置**：
```python
# image_generator.py, line 2592-2598
if shot_type_for_prompt["is_wide"] or shot_type_for_prompt["is_full_body"]:
    # 远景场景：强制添加正面朝向和排除背影，避免人物太小和背影
    priority_parts.append("(single person, front view, facing camera:1.8)")
```

### 4. 中景场景强制添加正面朝向（`image_generator.py`）

**优化内容**：
- **强制正面**：中景场景强制添加正面朝向提示（权重1.8），避免背影
- **提高权重**：将正面朝向权重提高到1.8，确保正面朝向明显

**代码位置**：
```python
# image_generator.py, line 2599-2605
elif shot_type_for_prompt["is_medium"]:
    # 中景场景：强制添加正面朝向，避免背影
    priority_parts.append("(medium shot, front view, facing camera, natural body proportions:1.8)")
```

## 🎯 预期改进效果

实施上述修复后，预期：
1. **减少远景和背影**：人物场景默认使用中景，远景场景强制正面朝向
2. **第一张场景正确**：卷轴场景添加负面提示，避免生成兵器
3. **最后一张场景正确**：城市场景添加负面提示，避免生成人物

## 📋 参数说明

### 镜头类型权重
- **中景（默认）**：`2.0`（人物场景，确保人物清晰可见且正面）
- **远景（强制正面）**：`1.8`（正面朝向提示）

### 物体描述优化
- **卷轴**：添加 `golden scroll`，负面提示 `no weapons, no tools`
- **城市**：添加 `city silhouette`，负面提示 `no people, no characters`

## 📝 代码变更文件

1. `gen_video/image_generator.py`
   - `_build_prompt` 方法：优化物体描述，人物场景默认中景，远景/中景场景强制正面朝向

## ✅ 语法检查

所有代码已通过语法检查，可以正常运行。

