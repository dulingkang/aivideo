# 图像生成通用化重构方案

## 目标
将图像生成系统改造成通用的、智能的生成功能，移除所有硬编码的特殊处理，基于语义分析准确表现用户需求。

## 当前问题

### 1. 硬编码的特殊处理
- **角色特殊处理**：针对"韩立"的特殊逻辑（如InstantID使用）
- **物体特殊处理**：针对"卷轴"的特殊强调逻辑
- **动作特殊处理**：针对"lying_still"的特殊权重调整
- **场景特殊处理**：针对"无人物场景"的特殊简化逻辑

### 2. 关键词匹配而非语义理解
- 使用简单的关键词匹配（如"scroll"、"卷轴"）
- 无法理解用户真实意图
- 容易误判或遗漏

### 3. 固定规则而非智能分析
- 固定的权重分配（如"卷轴"权重2.0）
- 固定的优先级顺序
- 无法根据上下文调整

## 解决方案

### 1. 创建通用场景意图分析器
- **SceneIntentAnalyzer**：分析场景描述，提取实体、动作、视角等
- 不依赖特定角色或物体名称
- 基于语义模式识别

### 2. 重构Prompt构建逻辑
- 移除所有硬编码的特殊处理
- 基于意图分析结果动态构建Prompt
- 根据实体重要性自动分配权重

### 3. 建立通用规则系统
- 实体类型识别（角色、物体、环境）
- 动作类型识别（静态、动态、物体运动）
- 视角类型识别（正面、背面、侧面、特写、远景）
- 自动强调和排除

## 实施步骤

### 阶段1：集成意图分析器
1. 在ImageGenerator中初始化SceneIntentAnalyzer
2. 在build_prompt开始时调用analyze方法
3. 使用分析结果替代硬编码逻辑

### 阶段2：重构Prompt构建
1. 移除所有针对特定角色/物体的特殊处理
2. 使用意图分析结果构建Prompt
3. 动态分配权重和优先级

### 阶段3：优化和测试
1. 测试各种场景类型
2. 调整分析器规则
3. 确保通用性和准确性

## 代码修改点

### 需要移除的特殊处理
1. **卷轴特殊处理**（1916-2034行）
   - 移除所有"scroll"、"卷轴"的特殊检查
   - 改用通用物体识别

2. **韩立特殊处理**（2382-2391行）
   - 移除"hanli"的特殊判断
   - 改用通用角色识别

3. **lying_still特殊处理**（2469-2474行）
   - 移除"lying_still"的特殊权重
   - 改用通用动作识别

4. **默认韩立处理**（2448-2455行）
   - 移除"默认使用韩立"的逻辑
   - 改用通用角色识别

### 需要添加的通用逻辑
1. **意图分析集成**
   - 在build_prompt开始时分析场景意图
   - 使用分析结果指导Prompt构建

2. **动态权重分配**
   - 根据实体重要性自动分配权重
   - 根据视角类型调整权重

3. **通用强调和排除**
   - 基于意图分析结果强调关键元素
   - 基于意图分析结果排除不需要的元素

## 预期效果

1. **通用性**：不依赖特定角色或物体名称
2. **智能性**：基于语义理解用户意图
3. **准确性**：准确表现用户需求
4. **可扩展性**：易于添加新的实体类型和规则

