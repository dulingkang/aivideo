# 图像分析工具使用说明

## 功能说明

图像分析工具可以：
1. **分析生成的图像内容**：使用CLIP模型识别图像中的元素（角色、物体、视角等）
2. **对比Prompt和实际图像**：找出期望内容和实际内容的差异
3. **生成优化建议**：基于差异提供具体的优化建议

## 安装依赖

```bash
pip install transformers torch pillow
```

## 使用方法

### 方法1：命令行使用

```bash
# 分析所有场景的图像
python gen_video/analyze_images.py lingjie/1.json --image-dir gen_video/outputs/images/test_optimized --output analysis_results.json --report analysis_report.txt
```

### 方法2：Python代码使用

```python
from image_analyzer import ImageAnalyzer

# 初始化分析器
analyzer = ImageAnalyzer()

# 分析单个图像
result = analyzer.analyze_image(
    image_path="outputs/images/test_optimized/scene_001.png",
    prompt="xianxia fantasy, golden scroll unfurling...",
    scene=scene_data
)

# 查看结果
print("匹配项:", result["comparison"]["matches"])
print("不匹配项:", result["comparison"]["mismatches"])
print("优化建议:", result["suggestions"])
```

## 分析内容

### 1. Prompt分析
- 提取关键元素（角色、物体、环境）
- 识别视角（正面、背面、侧面）
- 识别镜头类型（特写、中景、远景）
- 识别动作类型（动态、中等、静态）

### 2. 图像分析
- 使用CLIP模型识别图像内容
- 检测角色朝向（正面/背面）
- 检测镜头类型
- 检测物体存在

### 3. 对比分析
- **匹配项**：Prompt和图像一致的内容
- **不匹配项**：Prompt和图像不一致的内容
- **缺失项**：Prompt中描述但图像中未检测到的内容
- **额外项**：图像中存在但Prompt中未描述的内容

### 4. 优化建议
基于对比分析生成具体的优化建议，包括：
- 视角问题修复建议
- 镜头距离调整建议
- 物体强调建议
- 动作描述优化建议

## 输出格式

### JSON格式（analysis_results.json）
```json
[
  {
    "scene_id": 0,
    "image_path": "outputs/images/test_optimized/scene_001.png",
    "prompt_analysis": {
      "elements": {
        "has_character": false,
        "has_object": true,
        "viewpoint": "unknown",
        "shot_type": "wide"
      }
    },
    "image_analysis": {
      "detected_elements": {
        "golden scroll": 0.85,
        "wide shot": 0.72
      }
    },
    "comparison": {
      "matches": ["物体存在：卷轴"],
      "mismatches": [],
      "missing": []
    },
    "suggestions": []
  }
]
```

### 文本报告（analysis_report.txt）
```
================================================================================
图像分析报告
================================================================================

场景 0: scene_001.png
--------------------------------------------------------------------------------
✓ 匹配项:
  - 物体存在：卷轴

场景 1: scene_002.png
--------------------------------------------------------------------------------
✗ 不匹配项:
  - 视角不匹配：期望正面，实际背面

💡 优化建议:
  ⚠ 视角问题：期望正面但生成了背面。建议在prompt中增加 '(facing camera, front view:1.8)' 并添加负面提示 'back view, from behind'
```

## 常见问题分析

### 1. 视角不匹配
**问题**：期望正面但生成了背面
**建议**：
- 在prompt中增加 `(facing camera, front view:1.8)`
- 添加负面提示 `back view, from behind`
- 检查character_pose字段是否正确

### 2. 镜头距离不匹配
**问题**：期望特写但生成了远景
**建议**：
- 在prompt最前面添加 `(extreme close-up:2.0)`
- 添加负面提示 `wide shot, distant view`
- 检查camera字段是否正确

### 3. 物体缺失
**问题**：Prompt中描述了物体但图像中未检测到
**建议**：
- 在prompt最前面添加物体描述，使用高权重（如2.0）
- 确保物体描述在77个token内
- 检查composition字段是否正确

### 4. 角色缺失
**问题**：Prompt中描述了角色但图像中未检测到
**建议**：
- 检查prompt中角色描述的权重和位置
- 确保角色描述在77个token内
- 检查是否有"no person"等排除项

## 优化流程

1. **生成图像**：使用当前prompt生成图像
2. **分析图像**：运行图像分析工具
3. **查看报告**：查看分析报告，找出问题
4. **优化Prompt**：根据建议优化prompt
5. **重新生成**：使用优化后的prompt重新生成
6. **再次分析**：验证优化效果

## 注意事项

1. **CLIP模型**：需要下载CLIP模型（首次运行会自动下载）
2. **GPU推荐**：CLIP模型在GPU上运行更快
3. **分析精度**：CLIP模型的识别精度有限，建议结合人工检查
4. **批量分析**：可以批量分析多个场景，生成汇总报告

