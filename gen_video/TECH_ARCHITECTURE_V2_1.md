# æŠ€æœ¯æ¶æ„æ–‡æ¡£ v2.1 - å·¥ä¸šçº§ç¨³å®šè§†é¢‘ç”Ÿæˆç³»ç»Ÿ

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ€»è§ˆ](#ç³»ç»Ÿæ€»è§ˆ)
2. [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
3. [æ•°æ®æµ](#æ•°æ®æµ)
4. [æ¨¡å—è¯¦è§£](#æ¨¡å—è¯¦è§£)
5. [v2.1æ ¸å¿ƒæ”¹è¿›](#v21æ ¸å¿ƒæ”¹è¿›)
6. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
7. [æ€§èƒ½ä¸ç¨³å®šæ€§](#æ€§èƒ½ä¸ç¨³å®šæ€§)

---

## ç³»ç»Ÿæ€»è§ˆ

### ç³»ç»Ÿç›®æ ‡

**ä»JSONåœºæ™¯æè¿° â†’ å®Œæ•´è§†é¢‘**ï¼ˆåŒ…å«å›¾åƒã€è§†é¢‘ã€é…éŸ³ã€å­—å¹•ã€BGMï¼‰

### æ ¸å¿ƒæµç¨‹

```
JSONåœºæ™¯æè¿° (v2.1)
    â†“
[è§„åˆ™å¼•æ“] â†’ é”å®šShot/Pose/Modelï¼ˆç¡¬è§„åˆ™ï¼Œä¸å¯è¦†ç›–ï¼‰
    â†“
[è§’è‰²é”šç³»ç»Ÿ] â†’ åŠ è½½LoRA + InstantIDï¼ˆè§’è‰²æ°¸ä¸ä¸¢å¤±ï¼‰
    â†“
[Promptæ„å»º] â†’ ç”Ÿæˆæœ€ç»ˆPromptï¼ˆæ¨¡æ¿å¡«å……ï¼Œä¸åšå†³ç­–ï¼‰
    â†“
[å›¾åƒç”Ÿæˆ] â†’ Flux/SDXL + PuLID/InstantID
    â†“
[è§†é¢‘ç”Ÿæˆ] â†’ HunyuanVideoï¼ˆå›¾ç”Ÿè§†é¢‘ï¼‰
    â†“
[éŸ³é¢‘ç”Ÿæˆ] â†’ TTSï¼ˆé…éŸ³ï¼‰
    â†“
[è§†é¢‘åˆæˆ] â†’ å›¾åƒ + è§†é¢‘ + éŸ³é¢‘ + å­—å¹• + BGM
    â†“
æœ€ç»ˆè§†é¢‘
```

---

## æ ¸å¿ƒæ¶æ„

### æ¶æ„åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨å±‚ (Application Layer)                 â”‚
â”‚  - generate_novel_video.py                                   â”‚
â”‚  - generate_video_from_json_complete.py                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic Layer)           â”‚
â”‚  - Execution Planner V3 (å¾…é‡æ„)                           â”‚
â”‚  - Prompt Engine V2 (å¾…é‡æ„)                                â”‚
â”‚  - Scene Analyzer (æœ¬åœ°è§„åˆ™å¼•æ“)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è§„åˆ™å¼•æ“å±‚ (Rule Engine Layer) v2.1        â”‚
â”‚  âœ… ExecutionRulesV21 - Shot/Pose/Modelç¡¬è§„åˆ™               â”‚
â”‚  âœ… CharacterAnchorManager - è§’è‰²é”šç³»ç»Ÿ                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç”Ÿæˆå¼•æ“å±‚ (Generation Engine Layer)       â”‚
â”‚  - ImageGenerator (Flux/SDXL)                               â”‚
â”‚  - VideoGenerator (HunyuanVideo)                            â”‚
â”‚  - TTSGenerator (CosyVoice)                                  â”‚
â”‚  - SubtitleGenerator                                         â”‚
â”‚  - VideoComposer                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ¨¡å‹ç®¡ç†å±‚ (Model Management Layer)         â”‚
â”‚  - ModelManager                                              â”‚
â”‚  - PuLID Engine                                              â”‚
â”‚  - InstantID Engine                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ•°æ®æµ

### å®Œæ•´æ•°æ®æµå›¾

```
1. è¾“å…¥é˜¶æ®µ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ JSON Scene v2.1 â”‚
   â”‚ - intent        â”‚
   â”‚ - character     â”‚
   â”‚ - camera        â”‚
   â”‚ - prompt        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“

2. è§„åˆ™å¼•æ“é˜¶æ®µ (v2.1æ–°å¢)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ExecutionRulesV21                   â”‚
   â”‚ â”œâ”€ SceneIntent â†’ Shot (ç¡¬æ˜ å°„)      â”‚
   â”‚ â”œâ”€ Shot â†’ Pose (éªŒè¯+ä¿®æ­£)          â”‚
   â”‚ â””â”€ Modelè·¯ç”± (ç¡¬è§„åˆ™)                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ CharacterAnchorManager              â”‚
   â”‚ â”œâ”€ åŠ è½½LoRA (Layer 0)               â”‚
   â”‚ â”œâ”€ æ¡ä»¶å¯ç”¨InstantID (Layer 1)      â”‚
   â”‚ â””â”€ æ€§åˆ«è´Ÿé” (Layer 2)                â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“

3. Promptæ„å»ºé˜¶æ®µ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Prompt Builder (v2.1ç®€åŒ–ç‰ˆ)         â”‚
   â”‚ - åªåšæ¨¡æ¿å¡«å……                       â”‚
   â”‚ - ä¸åšå†³ç­–                           â”‚
   â”‚ - æ·»åŠ æ€§åˆ«è´Ÿé”                       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“

4. å›¾åƒç”Ÿæˆé˜¶æ®µ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ ImageGenerator                       â”‚
   â”‚ â”œâ”€ æ¨¡å‹é€‰æ‹©: Flux/SDXL (ç¡¬è§„åˆ™)      â”‚
   â”‚ â”œâ”€ èº«ä»½å¼•æ“: PuLID/InstantID        â”‚
   â”‚ â”œâ”€ LoRAåŠ è½½ (è§’è‰²é”š)                 â”‚
   â”‚ â””â”€ ç”Ÿæˆå›¾åƒ                          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
            [å›¾åƒæ–‡ä»¶]

5. è§†é¢‘ç”Ÿæˆé˜¶æ®µ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ VideoGenerator                       â”‚
   â”‚ â”œâ”€ æ¨¡å‹: HunyuanVideo                â”‚
   â”‚ â”œâ”€ è¾“å…¥: å›¾åƒ + Prompt               â”‚
   â”‚ â””â”€ ç”Ÿæˆè§†é¢‘                          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
            [è§†é¢‘æ–‡ä»¶]

6. éŸ³é¢‘ç”Ÿæˆé˜¶æ®µ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ TTSGenerator                         â”‚
   â”‚ â”œâ”€ æ¨¡å‹: CosyVoice                   â”‚
   â”‚ â”œâ”€ è¾“å…¥: narration.text              â”‚
   â”‚ â””â”€ ç”ŸæˆéŸ³é¢‘                          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
            [éŸ³é¢‘æ–‡ä»¶]

7. è§†é¢‘åˆæˆé˜¶æ®µ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ VideoComposer                       â”‚
   â”‚ â”œâ”€ è§†é¢‘ç‰‡æ®µ                          â”‚
   â”‚ â”œâ”€ éŸ³é¢‘åŒæ­¥                          â”‚
   â”‚ â”œâ”€ å­—å¹•ç”Ÿæˆ                          â”‚
   â”‚ â””â”€ BGMæ··éŸ³                          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
            [æœ€ç»ˆè§†é¢‘]
```

---

## æ¨¡å—è¯¦è§£

### 1. è§„åˆ™å¼•æ“å±‚ (v2.1æ ¸å¿ƒ)

#### 1.1 ExecutionRulesV21

**æ–‡ä»¶**: `gen_video/utils/execution_rules_v2_1.py`

**èŒè´£**:
- âœ… SceneIntent â†’ Shot ç¡¬æ˜ å°„ï¼ˆ8ç§åœºæ™¯ç±»å‹ï¼‰
- âœ… Shot â†’ Pose éªŒè¯ä¸è‡ªåŠ¨ä¿®æ­£
- âœ… Model è·¯ç”±è¡¨ï¼ˆç¡¬è§„åˆ™ï¼‰
- âœ… æ€§åˆ«è´Ÿé”ç®¡ç†

**å…³é”®æ–¹æ³•**:
```python
# Shotå†³ç­–ï¼ˆç¡¬æ˜ å°„ï¼‰
shot_decision = rules.get_shot_from_intent("character_intro")
# è¿”å›: ShotDecision(shot_type=ShotType.MEDIUM, allow_override=False)

# PoseéªŒè¯ï¼ˆè‡ªåŠ¨ä¿®æ­£ï¼‰
pose_decision = rules.validate_pose(ShotType.WIDE, "lying")
# è‡ªåŠ¨ä¿®æ­£ä¸º: PoseType.STAND

# Modelè·¯ç”±ï¼ˆç¡¬è§„åˆ™ï¼‰
model, identity = rules.get_model_route(has_character=True, shot_type=ShotType.MEDIUM)
# è¿”å›: (ModelType.FLUX, "pulid")
```

**è®¾è®¡åŸåˆ™**:
- âŒ ç¦æ­¢LLMè¦†ç›–
- âŒ ç¦æ­¢åŠ¨æ€åˆ‡æ¢
- âœ… è‡ªåŠ¨ä¿®æ­£ä¸åˆæ³•ç»„åˆ
- âœ… è¡¨é©±åŠ¨å†³ç­–

---

#### 1.2 CharacterAnchorManager

**æ–‡ä»¶**: `gen_video/utils/character_anchor_v2_1.py`

**èŒè´£**:
- âœ… è§’è‰²LoRAç®¡ç†ï¼ˆLayer 0ï¼Œæ°¸è¿œå­˜åœ¨ï¼‰
- âœ… InstantIDæ¡ä»¶å¯ç”¨ï¼ˆLayer 1ï¼Œå¯é€‰ï¼‰
- âœ… æ€§åˆ«è´Ÿé”ï¼ˆLayer 2ï¼Œå·¥ä¸šçº§æ ‡é…ï¼‰

**è§’è‰²é”šä¼˜å…ˆçº§**:
```
LoRA (Layer 0) > InstantID (Layer 1) > é£æ ¼LoRA
```

**å…³é”®æ–¹æ³•**:
```python
# æ³¨å†Œè§’è‰²
anchor_manager.register_character(
    character_id="hanli",
    gender="male",
    lora_path="hanli_character_v1.safetensors",
    lora_weight=0.6
)

# åˆ¤æ–­æ˜¯å¦ä½¿ç”¨InstantIDï¼ˆæ¡ä»¶å¯ç”¨ï¼‰
should_use = anchor_manager.should_use_instantid("hanli", face_visible=True)

# è·å–æ€§åˆ«è´Ÿé”
negative = anchor_manager.get_negative_prompt_with_gender_lock("hanli")
```

---

### 2. ä¸šåŠ¡é€»è¾‘å±‚

#### 2.1 Execution Planner V3 (å¾…é‡æ„)

**æ–‡ä»¶**: `gen_video/execution_planner_v3.py`

**å½“å‰é—®é¢˜**:
- âŒ ä½¿ç”¨LLMåšå†³ç­–ï¼ˆä¸ç¨³å®šï¼‰
- âŒ åŠ¨æ€åˆ‡æ¢æ¨¡å‹ï¼ˆä¸å¯é¢„æµ‹ï¼‰
- âŒ å…è®¸ä¸åˆæ³•ç»„åˆï¼ˆwide + lyingï¼‰

**v2.1é‡æ„ç›®æ ‡**:
- âœ… ç§»é™¤LLMå†³ç­–ï¼Œæ”¹ä¸ºä½¿ç”¨ExecutionRulesV21
- âœ… ç§»é™¤åŠ¨æ€åˆ‡æ¢ï¼Œæ”¹ä¸ºç¡¬è·¯ç”±è¡¨
- âœ… é›†æˆCharacterAnchorManager

**é‡æ„åæµç¨‹**:
```python
# 1. ä»è§„åˆ™å¼•æ“è·å–Shotï¼ˆç¡¬æ˜ å°„ï¼‰
shot_decision = rules.get_shot_from_intent(scene["intent"]["type"])

# 2. éªŒè¯Poseï¼ˆè‡ªåŠ¨ä¿®æ­£ï¼‰
pose_decision = rules.validate_pose(shot_decision.shot_type, scene["character"]["pose"])

# 3. è·å–Modelè·¯ç”±ï¼ˆç¡¬è§„åˆ™ï¼‰
model, identity = rules.get_model_route(
    has_character=scene["character"]["present"],
    shot_type=shot_decision.shot_type
)

# 4. è·å–è§’è‰²é”š
anchor = anchor_manager.get_anchor(scene["character"]["id"])
```

---

#### 2.2 Prompt Engine V2 (å¾…é‡æ„)

**æ–‡ä»¶**: `gen_video/utils/prompt_engine_v2.py`

**å½“å‰é—®é¢˜**:
- âŒ ä½¿ç”¨LLMåˆ†æåœºæ™¯ï¼ˆä¸ç¨³å®šï¼‰
- âŒ åŠ¨æ€è°ƒæ•´Shot/Poseï¼ˆè¿åç¡¬è§„åˆ™ï¼‰

**v2.1é‡æ„ç›®æ ‡**:
- âœ… åªåšæ¨¡æ¿å¡«å……ï¼Œä¸åšå†³ç­–
- âœ… ä»å·²é”å®šçš„Shot/Poseè¯»å–ï¼ˆä¸ç”Ÿæˆï¼‰
- âœ… æ·»åŠ æ€§åˆ«è´Ÿé”

**é‡æ„åæµç¨‹**:
```python
def build_prompt_v21(scene: Dict[str, Any]) -> str:
    """åªåšæ¨¡æ¿å¡«å……ï¼Œä¸åšå†³ç­–"""
    # 1. ä»sceneä¸­è¯»å–å·²é”å®šçš„shot/poseï¼ˆä¸ç”Ÿæˆï¼‰
    shot_type = scene["shot"]["type"]  # å·²é”å®š
    pose_type = scene["pose"]["type"]  # å·²é”å®š
    
    # 2. å¡«å……æ¨¡æ¿
    shot_desc = _get_shot_description(shot_type)
    pose_desc = _get_pose_description(pose_type)
    scene_desc = scene["prompt"]["scene_description"]
    char_desc = scene["prompt"]["positive_core"]
    
    # 3. åˆå¹¶ï¼ˆä¸è¿›è¡ŒLLMåˆ†æï¼‰
    return f"{shot_desc}, {pose_desc}, {scene_desc}, {char_desc}"
```

---

#### 2.3 Scene Analyzer

**æ–‡ä»¶**: `gen_video/utils/scene_analyzer.py`

**èŒè´£**:
- âœ… æœ¬åœ°è§„åˆ™å¼•æ“ï¼ˆå¿«é€Ÿã€å…è´¹ï¼‰
- âœ… å¯é€‰LLMæ¨¡å¼ï¼ˆä»…ç”¨äºåœºæ™¯æè¿°å¢å¼ºï¼‰
- âŒ ä¸å‚ä¸Shot/Pose/Modelå†³ç­–ï¼ˆv2.1é™åˆ¶ï¼‰

**v2.1é™åˆ¶**:
- LLMåªèƒ½ç”¨äº `scene_description` å’Œ `atmosphere_only`
- ç¦æ­¢ç”¨äº `shot`ã€`pose`ã€`gender`ã€`model`ã€`character_identity`

---

### 3. ç”Ÿæˆå¼•æ“å±‚

#### 3.1 ImageGenerator

**æ–‡ä»¶**: `gen_video/image_generator.py`

**èŒè´£**:
- âœ… å›¾åƒç”Ÿæˆï¼ˆFlux/SDXLï¼‰
- âœ… èº«ä»½æ³¨å…¥ï¼ˆPuLID/InstantIDï¼‰
- âœ… LoRAåŠ è½½ï¼ˆè§’è‰²é”šï¼‰

**v2.1é›†æˆ**:
```python
# 1. ä»è§„åˆ™å¼•æ“è·å–æ¨¡å‹è·¯ç”±
model, identity_engine = rules.get_model_route(has_character, shot_type)

# 2. ä»è§’è‰²é”šç®¡ç†å™¨è·å–LoRA
anchor = anchor_manager.get_anchor(character_id)
if anchor.lora_path:
    load_lora(anchor.lora_path, weight=anchor.lora_weight)

# 3. æ¡ä»¶å¯ç”¨InstantID
if anchor_manager.should_use_instantid(character_id, face_visible):
    use_instantid(anchor.instantid_strength)

# 4. æ·»åŠ æ€§åˆ«è´Ÿé”
negative = anchor_manager.get_negative_prompt_with_gender_lock(character_id)
```

**æ¨¡å‹é€‰æ‹©è§„åˆ™**:
- æœ‰äººç‰© + medium/close_up â†’ Flux + PuLID
- æœ‰äººç‰© + wide â†’ SDXL + InstantID
- æ— äººç‰© â†’ Flux/SDXL

---

#### 3.2 VideoGenerator

**æ–‡ä»¶**: `gen_video/video_generator.py`

**èŒè´£**:
- âœ… å›¾ç”Ÿè§†é¢‘ï¼ˆHunyuanVideoï¼‰
- âœ… è¿åŠ¨æ§åˆ¶ï¼ˆmotion_intensityï¼‰
- âœ… æ—¶é•¿æ§åˆ¶ï¼ˆduration_secï¼‰

**è¾“å…¥**:
- å›¾åƒæ–‡ä»¶ï¼ˆImageGeneratorè¾“å‡ºï¼‰
- Promptï¼ˆPrompt Builderè¾“å‡ºï¼‰
- æ—¶é•¿ï¼ˆscene.duration_secï¼‰

**è¾“å‡º**:
- è§†é¢‘æ–‡ä»¶ï¼ˆ.mp4ï¼‰

---

#### 3.3 TTSGenerator

**æ–‡ä»¶**: `gen_video/tts_generator.py`

**èŒè´£**:
- âœ… æ–‡æœ¬è½¬è¯­éŸ³ï¼ˆCosyVoiceï¼‰
- âœ… æƒ…æ„Ÿæ§åˆ¶ï¼ˆemotion_hintï¼‰
- âœ… æ—¶é•¿è®¡ç®—ï¼ˆç”¨äºè§†é¢‘åŒæ­¥ï¼‰

**è¾“å…¥**:
- narration.text
- voice_id
- emotion_hint

**è¾“å‡º**:
- éŸ³é¢‘æ–‡ä»¶ï¼ˆ.wavï¼‰

---

#### 3.4 VideoComposer

**æ–‡ä»¶**: `gen_video/video_composer.py`

**èŒè´£**:
- âœ… è§†é¢‘ç‰‡æ®µæ‹¼æ¥
- âœ… éŸ³é¢‘åŒæ­¥
- âœ… å­—å¹•ç”Ÿæˆ
- âœ… BGMæ··éŸ³

**è¾“å…¥**:
- è§†é¢‘ç‰‡æ®µåˆ—è¡¨
- éŸ³é¢‘æ–‡ä»¶
- å­—å¹•æ–‡æœ¬

**è¾“å‡º**:
- æœ€ç»ˆè§†é¢‘ï¼ˆ.mp4ï¼‰

---

## v2.1æ ¸å¿ƒæ”¹è¿›

### æ”¹è¿›å¯¹æ¯”è¡¨

| ç»´åº¦ | v2ï¼ˆå½“å‰ï¼‰ | v2.1ï¼ˆé‡æ„åï¼‰ |
|------|-----------|---------------|
| **Shotå†³ç­–** | LLMåˆ†æ + åŠ¨æ€åˆ¤æ–­ | ç¡¬æ˜ å°„è¡¨ï¼ˆSceneIntent â†’ Shotï¼‰ |
| **PoseéªŒè¯** | å…è®¸ä¸åˆæ³•ç»„åˆ | ç¡¬è§„åˆ™è¡¨ï¼ˆè‡ªåŠ¨ä¿®æ­£ï¼‰ |
| **Modelé€‰æ‹©** | ç¨³å®šæ€§è¯„åˆ† + åŠ¨æ€åˆ‡æ¢ | ç¡¬è·¯ç”±è¡¨ï¼ˆç¦æ­¢åˆ‡æ¢ï¼‰ |
| **è§’è‰²é”šå®š** | InstantIDä¸ºä¸» | LoRAä¸ºä¸»ï¼ŒInstantIDä¸ºè¾… |
| **æ€§åˆ«é”å®š** | æ—  | æ€§åˆ«è´Ÿé”ï¼ˆå·¥ä¸šçº§æ ‡é…ï¼‰ |
| **LLMä½¿ç”¨** | å‚ä¸æ‰€æœ‰å†³ç­– | ä»…ç”¨äºåœºæ™¯æè¿°å¢å¼º |
| **å†³ç­–è·¯å¾„** | æ™ºèƒ½åˆ¤æ–­ï¼ˆä¸ç¨³å®šï¼‰ | è¡¨é©±åŠ¨ï¼ˆå¯é¢„æµ‹ï¼‰ |

### ç¨³å®šæ€§æå‡

| é—®é¢˜ | v2 | v2.1 |
|------|----|------|
| å¥³ä¸»ä¹±å…¥ | âŒ å¶å°” | âœ… åŸºæœ¬æ¶ˆå¤±ï¼ˆæ€§åˆ«è´Ÿé”ï¼‰ |
| èººå§¿ç¿»è½¦ | âŒ ç»å¸¸ | âœ… å¤§å¹…ä¸‹é™ï¼ˆç¡¬è§„åˆ™ä¿®æ­£ï¼‰ |
| åœºæ™¯ä¸å¯¹ | âŒ å¶å°” | âœ… æ˜æ˜¾å‡å°‘ï¼ˆShotç¡¬æ˜ å°„ï¼‰ |
| Fluxç„å­¦ | âŒ ä¸å¯é¢„æµ‹ | âœ… å¯é¢„æµ‹ï¼ˆModelè·¯ç”±è¡¨ï¼‰ |
| è§’è‰²æ¼‚ç§» | âŒ ç»å¸¸ | âœ… åŸºæœ¬æ¶ˆå¤±ï¼ˆLoRAé”šå®šï¼‰ |

### ä»£ç ç®€åŒ–

- **åˆ é™¤**: ~30% çš„LLMå†³ç­–ä»£ç 
- **ç®€åŒ–**: Prompt Builderä»500è¡Œå‡å°‘åˆ°~200è¡Œ
- **ç¨³å®š**: å†³ç­–è·¯å¾„ä»"æ™ºèƒ½åˆ¤æ–­"æ”¹ä¸º"è¡¨é©±åŠ¨"

---

## æŠ€æœ¯æ ˆ

### å›¾åƒç”Ÿæˆ

- **Flux.1-dev**: é«˜è´¨é‡å›¾åƒç”Ÿæˆï¼ˆä¸»è¦ï¼‰
- **SDXL**: ç¨³å®šæ–¹æ¡ˆï¼ˆè¿œæ™¯åœºæ™¯ï¼‰
- **PuLID**: èº«ä»½æ³¨å…¥ï¼ˆFluxåœºæ™¯ï¼‰
- **InstantID**: èº«ä»½æ³¨å…¥ï¼ˆSDXLåœºæ™¯ï¼‰

### è§†é¢‘ç”Ÿæˆ

- **HunyuanVideo 1.5**: å›¾ç”Ÿè§†é¢‘ï¼ˆä¸»è¦ï¼‰
- **åˆ†è¾¨ç‡**: 512x768 (ç«–å±) / 512x384 (æ¨ªå±)
- **å¸§ç‡**: 24fps
- **æ­¥æ•°**: 25æ­¥ï¼ˆè’¸é¦ç‰ˆï¼‰

### éŸ³é¢‘ç”Ÿæˆ

- **CosyVoice**: æ–‡æœ¬è½¬è¯­éŸ³
- **æ”¯æŒ**: ä¸­æ–‡ã€æƒ…æ„Ÿæ§åˆ¶

### è§†é¢‘å¤„ç†

- **FFmpeg**: è§†é¢‘æ‹¼æ¥ã€éŸ³é¢‘åŒæ­¥
- **å­—å¹•**: è‡ªåŠ¨ç”Ÿæˆ

---

## æ€§èƒ½ä¸ç¨³å®šæ€§

### æ€§èƒ½æŒ‡æ ‡

| é˜¶æ®µ | è€—æ—¶ | è¯´æ˜ |
|------|------|------|
| è§„åˆ™å¼•æ“ | <10ms | è¡¨é©±åŠ¨ï¼Œæå¿« |
| Promptæ„å»º | <100ms | æ¨¡æ¿å¡«å……ï¼Œå¿«é€Ÿ |
| å›¾åƒç”Ÿæˆ | 10-30s | å–å†³äºæ¨¡å‹ï¼ˆFluxè¾ƒæ…¢ï¼‰ |
| è§†é¢‘ç”Ÿæˆ | 30-60s | HunyuanVideo |
| éŸ³é¢‘ç”Ÿæˆ | 1-3s | CosyVoice |
| è§†é¢‘åˆæˆ | 5-10s | FFmpeg |

### ç¨³å®šæ€§ä¿éšœ

1. **ç¡¬è§„åˆ™è¡¨**: æ‰€æœ‰å†³ç­–åŸºäºè¡¨é©±åŠ¨ï¼Œå¯é¢„æµ‹
2. **è‡ªåŠ¨ä¿®æ­£**: ä¸åˆæ³•ç»„åˆè‡ªåŠ¨ä¿®æ­£ï¼Œä¸å¤±è´¥
3. **è§’è‰²é”šå®š**: LoRAæ°¸è¿œå­˜åœ¨ï¼Œè§’è‰²ä¸ä¸¢å¤±
4. **æ€§åˆ«è´Ÿé”**: é˜²æ­¢æ€§åˆ«é”™è¯¯
5. **ç¦æ­¢åŠ¨æ€åˆ‡æ¢**: Modelè·¯ç”±å›ºå®šï¼Œä¸æ¼‚ç§»

### å®¹é”™æœºåˆ¶

1. **Poseè‡ªåŠ¨ä¿®æ­£**: wide + lying â†’ medium + lying
2. **Modelé™çº§**: å¦‚æœFluxå¤±è´¥ï¼Œå¯é…ç½®é™çº§åˆ°SDXLï¼ˆä½†v2.1ä¸æ¨èåŠ¨æ€åˆ‡æ¢ï¼‰
3. **è§’è‰²é”šé™çº§**: InstantIDå¤±è´¥ â†’ ä»…ä½¿ç”¨LoRAï¼ˆè§’è‰²ä¸ä¸¢å¤±ï¼‰

---

## æ¶æ„ä¼˜åŠ¿

### 1. ç¨³å®šæ€§ä¼˜å…ˆ

- âœ… ç¡¬è§„åˆ™è¡¨ï¼ˆå¯é¢„æµ‹ï¼‰
- âœ… è‡ªåŠ¨ä¿®æ­£ï¼ˆä¸å¤±è´¥ï¼‰
- âœ… è§’è‰²é”šå®šï¼ˆä¸ä¸¢å¤±ï¼‰

### 2. å¯ç»´æŠ¤æ€§

- âœ… è¡¨é©±åŠ¨ï¼ˆæ˜“ä¿®æ”¹ï¼‰
- âœ… æ¨¡å—åŒ–ï¼ˆæ˜“æ‰©å±•ï¼‰
- âœ… æ¸…æ™°åˆ†å±‚ï¼ˆæ˜“ç†è§£ï¼‰

### 3. å¯æ‰©å±•æ€§

- âœ… æ–°å¢åœºæ™¯ç±»å‹ â†’ ä¿®æ”¹æ˜ å°„è¡¨
- âœ… æ–°å¢è§’è‰² â†’ æ³¨å†Œè§’è‰²é”š
- âœ… æ–°å¢æ¨¡å‹ â†’ ä¿®æ”¹è·¯ç”±è¡¨

---

## å¾…å®Œæˆå·¥ä½œ

### é«˜ä¼˜å…ˆçº§

1. âœ… **è§„åˆ™å¼•æ“** - å·²å®Œæˆ
2. âœ… **è§’è‰²é”šç³»ç»Ÿ** - å·²å®Œæˆ
3. â³ **é‡æ„Execution Planner V3** - å¾…å®Œæˆ
4. â³ **é‡æ„Prompt Builder** - å¾…å®Œæˆ

### ä¸­ä¼˜å…ˆçº§

5. â³ **åˆ›å»ºv2 â†’ v2.1è½¬æ¢å™¨** - å¾…å®Œæˆ
6. â³ **æ›´æ–°æµ‹è¯•ç”¨ä¾‹** - å¾…å®Œæˆ

### ä½ä¼˜å…ˆçº§

7. â³ **æ€§èƒ½ä¼˜åŒ–** - å¾…å®Œæˆ
8. â³ **ç›‘æ§ä¸æ—¥å¿—** - å¾…å®Œæˆ

---

## æ€»ç»“

### v2.1æ ¸å¿ƒä»·å€¼

1. **ç¨³å®šæ€§**: ä»"æ™ºèƒ½åˆ¤æ–­"æ”¹ä¸º"è¡¨é©±åŠ¨"ï¼Œå¯é¢„æµ‹æ€§å¤§å¹…æå‡
2. **è§’è‰²ä¸€è‡´æ€§**: LoRAé”šå®š + æ€§åˆ«è´Ÿé”ï¼Œè§’è‰²æ°¸ä¸ä¸¢å¤±
3. **ä»£ç ç®€åŒ–**: åˆ é™¤30%çš„LLMå†³ç­–ä»£ç ï¼Œç»´æŠ¤æˆæœ¬é™ä½
4. **å·¥ä¸šçº§**: ç¬¦åˆä¸»æµAIè§†é¢‘ç”Ÿæˆç³»ç»Ÿçš„è®¾è®¡æ¨¡å¼

### é€‚ç”¨åœºæ™¯

- âœ… é‡äº§å†…å®¹ï¼ˆéœ€è¦ç¨³å®šæ€§ï¼‰
- âœ… è§’è‰²ä¸€è‡´æ€§è¦æ±‚é«˜
- âœ… éœ€è¦å¯é¢„æµ‹çš„è¾“å‡º
- âŒ ä¸é€‚åˆç ”ç©¶å‹/å®éªŒå‹åœºæ™¯ï¼ˆè‡ªç”±åº¦ä½ï¼‰

---

## ç›¸å…³æ–‡æ¡£

- `REFACTOR_PLAN_V2_1.md` - è¯¦ç»†é‡æ„è®¡åˆ’
- `REFACTOR_SUMMARY.md` - é‡æ„æ€»ç»“
- `schemas/scene_v2_1_example.json` - v2.1 JSONç¤ºä¾‹
- `utils/execution_rules_v2_1.py` - è§„åˆ™å¼•æ“å®ç°
- `utils/character_anchor_v2_1.py` - è§’è‰²é”šç³»ç»Ÿå®ç°

