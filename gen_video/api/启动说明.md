# APIæœåŠ¡å¯åŠ¨è¯´æ˜

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### 1. å¯åŠ¨Redisï¼ˆä»»åŠ¡é˜Ÿåˆ—ï¼‰

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨Dockerï¼ˆæ¨èï¼‰
docker run -d --name redis-videogen -p 6379:6379 redis:latest

# æ–¹æ³•2ï¼šä½¿ç”¨æœ¬åœ°Redis
redis-server

# æ£€æŸ¥Redisæ˜¯å¦è¿è¡Œ
redis-cli ping  # åº”è¯¥è¿”å› PONG
```

### 2. å¯åŠ¨Celery Worker

```bash
cd gen_video/api

# å¯åŠ¨Workerï¼ˆå¤„ç†ä»»åŠ¡ï¼‰
celery -A celery_app worker --loglevel=info --concurrency=1

# æˆ–è€…åå°è¿è¡Œ
nohup celery -A celery_app worker --loglevel=info --concurrency=1 > celery.log 2>&1 &
```

**æ³¨æ„**ï¼š
- `--concurrency=1` è¡¨ç¤ºä¸€æ¬¡åªå¤„ç†ä¸€ä¸ªä»»åŠ¡ï¼ˆé¿å…GPUå†…å­˜ä¸è¶³ï¼‰
- å¦‚æœæœ‰å¤šä¸ªGPUï¼Œå¯ä»¥å¢åŠ å¹¶å‘æ•°

### 3. å¯åŠ¨APIæœåŠ¡å™¨

```bash
cd gen_video/api

# æ–¹æ³•1ï¼šç›´æ¥è¿è¡Œ
python main.py

# æ–¹æ³•2ï¼šä½¿ç”¨uvicornï¼ˆæ¨èï¼Œæ”¯æŒçƒ­é‡è½½ï¼‰
uvicorn main:app --reload --host 0.0.0.0 --port 8000

# æ–¹æ³•3ï¼šåå°è¿è¡Œ
nohup uvicorn main:app --host 0.0.0.0 --port 8000 > api.log 2>&1 &
```

### 4. éªŒè¯æœåŠ¡

```bash
# æ£€æŸ¥APIæ˜¯å¦è¿è¡Œ
curl http://localhost:8000/api/v1/health

# æŸ¥çœ‹APIæ–‡æ¡£
# æµè§ˆå™¨æ‰“å¼€: http://localhost:8000/docs
```

## ğŸ“‹ å®Œæ•´å¯åŠ¨æµç¨‹

### ä¸€æ¬¡æ€§å¯åŠ¨è„šæœ¬

åˆ›å»º `start_services.sh`ï¼š

```bash
#!/bin/bash

echo "ğŸš€ å¯åŠ¨APIæœåŠ¡..."

# 1. æ£€æŸ¥Redis
if ! redis-cli ping > /dev/null 2>&1; then
    echo "âš ï¸  Redisæœªè¿è¡Œï¼Œå¯åŠ¨Redis..."
    docker run -d --name redis-videogen -p 6379:6379 redis:latest
    sleep 2
fi

# 2. å¯åŠ¨Celery Workerï¼ˆåå°ï¼‰
echo "ğŸ”§ å¯åŠ¨Celery Worker..."
cd gen_video/api
nohup celery -A celery_app worker --loglevel=info --concurrency=1 > celery.log 2>&1 &
CELERY_PID=$!
echo "Celery Worker PID: $CELERY_PID"

# 3. å¯åŠ¨APIæœåŠ¡å™¨ï¼ˆåå°ï¼‰
echo "ğŸŒ å¯åŠ¨APIæœåŠ¡å™¨..."
nohup uvicorn main:app --host 0.0.0.0 --port 8000 > api.log 2>&1 &
API_PID=$!
echo "APIæœåŠ¡å™¨ PID: $API_PID"

echo ""
echo "âœ… æœåŠ¡å·²å¯åŠ¨"
echo "   - API: http://localhost:8000"
echo "   - æ–‡æ¡£: http://localhost:8000/docs"
echo "   - Celery PID: $CELERY_PID"
echo "   - API PID: $API_PID"
echo ""
echo "æŸ¥çœ‹æ—¥å¿—ï¼š"
echo "   - Celery: tail -f gen_video/api/celery.log"
echo "   - API: tail -f gen_video/api/api.log"
```

### åœæ­¢æœåŠ¡

```bash
# åœæ­¢Celery Worker
pkill -f "celery.*worker"

# åœæ­¢APIæœåŠ¡å™¨
pkill -f "uvicorn.*main:app"

# åœæ­¢Redisï¼ˆå¦‚æœä½¿ç”¨Dockerï¼‰
docker stop redis-videogen
docker rm redis-videogen
```

## ğŸ§ª æµ‹è¯•API

### ä½¿ç”¨æµ‹è¯•è„šæœ¬

```bash
cd gen_video/api
python test_api.py
```

### æ‰‹åŠ¨æµ‹è¯•

```bash
# 1. å¥åº·æ£€æŸ¥
curl http://localhost:8000/api/v1/health

# 2. ç”Ÿæˆå›¾åƒ
curl -X POST "http://localhost:8000/api/v1/images/generate" \
  -H "Authorization: Bearer test-token" \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "xianxia fantasy, Han Li, calm cultivator",
    "width": 1536,
    "height": 864
  }'

# 3. æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ï¼ˆæ›¿æ¢ {task_id}ï¼‰
curl -X GET "http://localhost:8000/api/v1/tasks/{task_id}" \
  -H "Authorization: Bearer test-token"
```

## âš™ï¸ é…ç½®

### ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼ˆåœ¨ `gen_video/api/` ç›®å½•ä¸‹ï¼‰ï¼š

```env
# Redisé…ç½®
REDIS_URL=redis://localhost:6379/0

# æ•°æ®åº“é…ç½®ï¼ˆåç»­ä½¿ç”¨ï¼‰
DATABASE_URL=postgresql://user:password@localhost:5432/videogen

# APIå¯†é’¥
SECRET_KEY=your-secret-key-here
```

### é…ç½®æ–‡ä»¶

ç¡®ä¿ `gen_video/config.yaml` å­˜åœ¨ä¸”é…ç½®æ­£ç¡®ã€‚

## ğŸ“Š ç›‘æ§

### æŸ¥çœ‹ä»»åŠ¡é˜Ÿåˆ—çŠ¶æ€

```bash
# ä½¿ç”¨Celeryç›‘æ§å‘½ä»¤
celery -A celery_app inspect active
celery -A celery_app inspect scheduled
celery -A celery_app inspect registered
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# Celeryæ—¥å¿—
tail -f gen_video/api/celery.log

# APIæ—¥å¿—
tail -f gen_video/api/api.log

# æˆ–æŸ¥çœ‹nohupè¾“å‡º
tail -f nohup.out
```

## â“ å¸¸è§é—®é¢˜

### 1. Redisè¿æ¥å¤±è´¥

**é”™è¯¯**: `Connection refused` æˆ– `Error 111`

**è§£å†³**:
- æ£€æŸ¥Redisæ˜¯å¦è¿è¡Œï¼š`redis-cli ping`
- æ£€æŸ¥Redisç«¯å£æ˜¯å¦æ­£ç¡®ï¼ˆé»˜è®¤6379ï¼‰
- æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

### 2. Celery Workeræ— æ³•å¯åŠ¨

**é”™è¯¯**: `ImportError` æˆ–æ¨¡å—æ‰¾ä¸åˆ°

**è§£å†³**:
- æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„ç›®å½•ï¼ˆ`gen_video/api/`ï¼‰
- æ£€æŸ¥Pythonè·¯å¾„æ˜¯å¦æ­£ç¡®
- ç¡®ä¿æ‰€æœ‰ä¾èµ–å·²å®‰è£…ï¼š`pip install -r requirements.txt`

### 3. ä»»åŠ¡ä¸€ç›´å¤„äºqueuedçŠ¶æ€

**åŸå› **:
- Celery Workeræœªè¿è¡Œ
- Redisè¿æ¥å¤±è´¥
- ä»»åŠ¡é˜Ÿåˆ—é…ç½®é”™è¯¯

**è§£å†³**:
- æ£€æŸ¥Celery Workeræ˜¯å¦è¿è¡Œ
- æ£€æŸ¥Redisè¿æ¥
- æŸ¥çœ‹Celeryæ—¥å¿—

### 4. GPUå†…å­˜ä¸è¶³

**è§£å†³**:
- å‡å°‘å¹¶å‘æ•°ï¼š`--concurrency=1`
- ä½¿ç”¨æ›´å°çš„æ¨¡å‹æˆ–é™ä½åˆ†è¾¨ç‡
- ä½¿ç”¨å¤šGPUåˆ†å¸ƒä»»åŠ¡

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [MVPå¼€å‘è®¡åˆ’.md](../../MVPå¼€å‘è®¡åˆ’.md)
- [MVPå¼€å‘è¿›åº¦-ç¬¬äºŒæ­¥å®Œæˆ.md](../../MVPå¼€å‘è¿›åº¦-ç¬¬äºŒæ­¥å®Œæˆ.md)

---

**æœ€åæ›´æ–°**: 2024å¹´11æœˆ30æ—¥

