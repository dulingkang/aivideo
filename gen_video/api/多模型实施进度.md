# 多模型组合方案 - 实施进度

## ✅ 已完成（第一阶段）

### 1. 核心框架搭建

- ✅ **模型选择器** (`gen_video/model_selector.py`)
  - 实现了 `ModelSelector` 类
  - 支持根据任务类型（character/scene/batch）自动选择模型
  - 支持根据提示词关键词自动检测任务类型
  - 支持手动指定模型引擎

- ✅ **配置文件更新** (`gen_video/config.yaml`)
  - 添加了 `model_selection` 配置段
  - 配置了 Flux + InstantID（人物生成）
  - 配置了 Hunyuan-DiT（中文场景）
  - 配置了 Kolors（真实感场景）
  - 配置了 SD3 Turbo（批量生成）

- ✅ **ImageGenerator 更新** (`gen_video/image_generator.py`)
  - 添加了多模型 pipeline 缓存（flux_pipeline, hunyuan_dit_pipeline, kolors_pipeline, sd3_turbo_pipeline）
  - 更新了 `load_pipeline()` 方法，支持多引擎加载
  - 实现了 `_load_sd3_turbo_pipeline()` 方法（基础框架）
  - 实现了 `_load_flux_pipeline()` 方法（占位实现）
  - 实现了 `_load_hunyuan_dit_pipeline()` 方法（占位实现）
  - 实现了 `_load_kolors_pipeline()` 方法（占位实现）
  - 更新了 `generate_image()` 方法，支持自动模型选择

- ✅ **API 端点更新** (`gen_video/api/mvp_main.py`)
  - 添加了 `model_engine` 参数（支持 auto/flux-instantid/hunyuan-dit/kolors/sd3-turbo）
  - 添加了 `task_type` 参数（支持 character/scene/batch）
  - 更新了 API 文档说明

---

## 🚧 待完成（第二阶段）

### 2. 模型 Pipeline 完整实现

#### 2.1 SD3 Turbo Pipeline（优先级：高）
- ✅ 基础框架已实现
- ⚠️ 需要完善：
  - 实现完整的 pipeline 加载逻辑
  - 实现批量生成功能（batch_mode）
  - 测试生成效果

#### 2.2 Flux 1-dev + InstantID Pipeline（优先级：高）
- ⚠️ 当前为占位实现
- 需要完成：
  - 实现 Flux 1-dev base model 加载
  - 集成 InstantID ControlNet
  - 集成 LoRA 支持
  - 测试固定人设效果

#### 2.3 Hunyuan-DiT Pipeline（优先级：中）
- ⚠️ 当前为占位实现
- 需要完成：
  - 研究 Hunyuan-DiT 的 API 和加载方式
  - 实现 pipeline 加载
  - 实现中文提示词优化
  - 测试中文场景生成效果

#### 2.4 Kolors Pipeline（优先级：中）
- ⚠️ 当前为占位实现
- 需要完成：
  - 研究 Kolors 的 API 和加载方式
  - 实现 pipeline 加载
  - 实现真实感增强功能
  - 测试真实感场景生成效果

---

## 📋 下一步计划

### 立即开始（本周）

1. **完善 SD3 Turbo Pipeline**
   - 实现完整的 pipeline 加载
   - 测试批量生成功能
   - 验证生成速度和质量

2. **实现 Flux + InstantID 集成**
   - 下载 Flux 1-dev 模型
   - 实现 Flux base model 加载
   - 集成 InstantID ControlNet
   - 测试固定人设效果

### 短期（2周内）

3. **实现 Hunyuan-DiT Pipeline**
   - 获取 Hunyuan-DiT 模型和文档
   - 实现 pipeline 加载
   - 测试中文场景生成

4. **实现 Kolors Pipeline**
   - 获取 Kolors 模型和文档
   - 实现 pipeline 加载
   - 测试真实感场景生成

### 中期（1个月内）

5. **性能优化**
   - 实现模型延迟加载（按需加载）
   - 实现模型卸载机制（节省显存）
   - 优化多模型切换速度

6. **完整测试**
   - 测试所有模型的生成效果
   - 测试自动模型选择准确性
   - 性能基准测试

---

## 🔧 技术细节

### 模型选择逻辑

```python
# 自动选择流程
1. 如果手动指定了 model_engine，直接使用
2. 如果没有指定 task_type，根据提示词和参考图像自动检测
3. 根据任务类型选择最适合的模型：
   - character → flux-instantid
   - scene → hunyuan-dit / kolors（根据关键词）
   - batch → sd3-turbo
```

### 配置结构

```yaml
image:
  engine: auto  # 自动模式
  model_selection:
    character:
      engine: flux-instantid
      # ... 配置
    scene:
      engines: [hunyuan-dit, kolors, sd3-turbo]
      hunyuan_dit: { ... }
      kolors: { ... }
      sd3_turbo: { ... }
```

---

## 📝 使用示例

### API 调用示例

```python
# 自动选择（推荐）
POST /api/v1/images/generate
{
  "prompt": "科普主持人站在科技馆前",
  "model_engine": "auto",
  "task_type": "character"
}

# 手动指定模型
POST /api/v1/images/generate
{
  "prompt": "现代化的科学实验室",
  "model_engine": "hunyuan-dit",
  "task_type": "scene"
}
```

---

## ⚠️ 注意事项

1. **模型下载**：需要下载大量模型文件（约 50-60GB），确保有足够的存储空间
2. **显存需求**：多模型共存需要大量显存（建议 24GB+），或使用模型卸载机制
3. **模型授权**：Hunyuan-DiT 可能需要特殊授权，请参考官方文档
4. **依赖版本**：SD3 Turbo 需要 diffusers >= 0.27.0

---

## 🎯 成功标准

- ✅ 所有模型 pipeline 可以正常加载
- ✅ 自动模型选择准确率 > 90%
- ✅ 生成质量符合预期
- ✅ API 响应时间 < 60秒（单张图像）
- ✅ 支持批量生成（SD3 Turbo）

---

**最后更新**：2024年12月

