# 视频身份保持 - M6 里程碑

> 创建日期: 2025-12-17
> 更新日期: 2025-12-18 08:30
> 目标: 实现视频生成时的角色身份一致性保持

## 📋 MVP 策略（最终方案）

### 核心原则
- **系统简单** - 避免过度集成
- **参数少** - 减少调试复杂度
- **可维护** - 清晰的错误处理
- **成功率高** - 合理的阈值设置
- **能规模化** - 支持批量生成

### 技术路线

```
【图像阶段】
FLUX + PuLID → 角色 Anchor 图（中景 + 正脸）

【视频阶段】
HunyuanVideo 1.5 (I2V)
        ↓
VideoIdentityAnalyzer 验证
        ↓
失败 → 调整参数重试（最多3次）
        ↓
成功 → 输出视频
```

---

## 🎬 镜头语言规范

### ✅ 推荐使用

| 镜头类型 | 漂移风险 | 适用场景 |
|----------|----------|----------|
| **远景 (wide)** | 🟢 低 | 动作、环境、建立镜头 |
| **中景 (medium)** | 🟢 低-中 | 对话、日常、过渡 |
| **中近景 (medium_close)** | 🟡 中 | 情感表达（慎用） |

### ⚠️ 谨慎使用

| 镜头类型 | 漂移风险 | 风险说明 |
|----------|----------|----------|
| **近景 (close)** | 🟠 中-高 | 人脸占比大，易漂移 |
| **特写 (extreme_close)** | 🔴 高 | 不建议使用 |

### ❌ 应避免

- 脸占画面 > 50%
- 剧烈头部转动
- 长时间大特写
- 快速运动
- 多人脸场景

### ✅ 替代建议

- 多用中景、侧身、半背
- 使用环境遮挡
- 缓慢平滑的运动
- 静态或微动镜头

---

## 📊 阈值配置表

### 相似度阈值

| 指标 | 阈值 | 动作 |
|------|------|------|
| 平均相似度 | ≥ 0.70 | ✅ 通过 |
| 平均相似度 | 0.65 - 0.70 | 🔄 重试 |
| 平均相似度 | < 0.65 | ❌ 丢弃 |

### 漂移阈值

| 指标 | 阈值 | 说明 |
|------|------|------|
| 单帧漂移 | < 0.50 | 视为漂移帧 |
| 漂移帧比例 | ≤ 10% | 可接受 |
| 漂移帧比例 | > 10% | 需重试 |

### 人脸检测

| 指标 | 阈值 | 说明 |
|------|------|------|
| 检测率 | ≥ 80% | 正常 |
| 检测率 | < 80% | 镜头语言问题 |

### 镜头容差

| 镜头类型 | 容差 | 调整后阈值 |
|----------|------|------------|
| 远景 | +0.10 | 0.60 通过 |
| 中景 | +0.05 | 0.65 通过 |
| 近景 | +0.03 | 0.67 通过 |
| 特写 | +0.02 | 0.68 通过 |

---

## 🔧 工程实现

### 核心类

#### VideoIdentityVerifier

```python
from video_identity_verifier import (
    VideoIdentityVerifier,
    IdentityVerificationConfig,
    VerificationResult
)

# 创建验证器
config = IdentityVerificationConfig(
    similarity_threshold=0.70,
    similarity_discard=0.65,
    max_retries=3
)
verifier = VideoIdentityVerifier(config)

# 验证视频
result = verifier.verify_video(
    video_path="output.mp4",
    reference_image="reference.jpg",
    shot_type="medium"
)

if result.passed:
    print("✅ 验证通过")
elif result.should_retry:
    print("🔄 需要重试")
else:
    print("❌ 应该丢弃")
```

#### 带验证的视频生成

```python
from video_identity_verifier import generate_video_with_verification

video_path, result = generate_video_with_verification(
    video_generator=generator,
    image_path="input.png",
    output_path="output.mp4",
    reference_image="reference.jpg",
    prompt="a woman walking in the park",
    shot_type="medium",
    max_retries=3
)
```

#### 镜头语言建议

```python
from video_identity_verifier import ShotLanguageAdvisor, ShotLanguage

# 获取漂移风险
risk = ShotLanguageAdvisor.get_drift_risk(ShotLanguage.MEDIUM)

# 增强 prompt
enhanced = ShotLanguageAdvisor.enhance_prompt_for_stability(
    "a woman talking", ShotLanguage.MEDIUM
)

# 获取稳定性 negative prompt
neg = ShotLanguageAdvisor.get_negative_prompt_for_stability()
```

---

## 📁 文件清单

| 文件 | 功能 |
|------|------|
| `video_identity_verifier.py` | 身份验证器主模块 |
| `utils/video_identity_analyzer.py` | 视频帧分析器 |
| `utils/image_quality_analyzer.py` | 图像质量分析器 |

---

## 📈 预期效果

| 指标 | 当前 | 目标 |
|------|------|------|
| 平均相似度 | 未知 | ≥ 0.70 |
| 漂移率 | 未知 | ≤ 10% |
| 重试成功率 | - | ≥ 80% |
| 生成速度 | ~30s | ~30s (不变) |

---

## ⚡ 快速决策表

| 情况 | 建议 |
|------|------|
| 当前阶段/MVP | ✅ 只用 HunyuanVideo |
| 批量跑视频 | ✅ 只用 HunyuanVideo |
| 单集 10-20s | ✅ 只用 HunyuanVideo |
| 近景情绪特写 | ⚠️ 后续可补 ID-Animator |
| 商用精修 | ⚠️ 后续局部使用 |

---

## 📝 下一步

1. ✅ 创建 `VideoIdentityVerifier` 
2. ⬜ 集成到 `video_generator.py`
3. ⬜ 测试完整流程
4. ⬜ 优化阈值参数

---

*90% 的项目死在"过度集成"，先跑通 MVP 再说*
