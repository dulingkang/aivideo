# æ¶æ„é‡æ„ï¼šè§„åˆ™ä¸‹æ²‰åˆ°ä»£ç å±‚

> é‡æ„æ—¥æœŸï¼š2025-12-19
> ç›®æ ‡ï¼šå°†ç¡¬è§„åˆ™ä» LLM prompt ä¸­ç§»é™¤ï¼Œä¸‹æ²‰åˆ°ä»£ç å±‚ï¼Œæå‡å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§

## ğŸ“‹ é‡æ„èƒŒæ™¯

### é—®é¢˜è¯Šæ–­

**åŸæ¶æ„é—®é¢˜**ï¼š
- LLM prompt è¿‡é‡ã€è¿‡æ­»ã€ä¸å¯ç»´æŠ¤
- å°† LLM é™çº§æˆè§„åˆ™æ‰§è¡Œå™¨ï¼ˆif-elseï¼‰
- ç¡¬è§„åˆ™å†™æ­»åœ¨ prompt ä¸­ï¼Œéš¾ä»¥æ‰©å±•
- æ–°åŠ¨ä½œ/æ–°å§¿æ€éœ€è¦ä¿®æ”¹ prompt

**å·¥ç¨‹åˆ¤æ–­**ï¼š
> è§„åˆ™è¦ç•™ï¼Œä½†å¿…é¡»"é™çº§æˆå…œåº•çº¦æŸ"ï¼Œè€Œä¸æ˜¯å¼ºåˆ¶æ¨¡æ¿æ³¨å…¥

---

## ğŸ—ï¸ æ–°æ¶æ„è®¾è®¡

### æ¶æ„åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§„åˆ™å¼•æ“å±‚ (PostureController)         â”‚
â”‚  - å¯¼æ¼”è¯­ä¹‰åˆ¤æ–­                         â”‚
â”‚  - "ä¿æŒä¸åŠ¨"+"è„šä¸‹" â†’ lying_candidate â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ hint
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM è¯­ä¹‰ç†è§£å±‚ (SceneAnalyzer)         â”‚
â”‚  - ç†è§£è¯­ä¹‰ï¼Œä¸åšç¡¬è§„åˆ™åˆ¤æ–­             â”‚
â”‚  - è¿”å›ç»“æ„åŒ–ç»“æœ                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ æ•´åˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å†³ç­–è¡¨å±‚ (PostureDecisionTable)         â”‚
â”‚  - åŠ¨ä½œ â†’ å§¿æ€ â†’ é•œå¤´æ˜ å°„               â”‚
â”‚  - å·¥ç¨‹çº§é…ç½®                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ å†³ç­–
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Execution Planner V3                   â”‚
â”‚  - æ•´åˆè§„åˆ™å±‚å’Œ LLM å±‚                  â”‚
â”‚  - ç”Ÿæˆæœ€ç»ˆ prompt                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ é‡æ„å†…å®¹

### 1. ç²¾ç®€ LLM Prompt

**åŸç‰ˆæœ¬**ï¼ˆè¿‡é‡ï¼‰ï¼š
- åŒ…å«å¤§é‡ç¡¬è§„åˆ™ï¼ˆ"å¦‚æœæç¤ºè¯æåˆ°è„šä¸‹ â†’ lying"ï¼‰
- å¼ºåˆ¶æ¨¡æ¿ï¼ˆ"å¿…é¡»ä¸¥æ ¼éµå¾ª"ï¼‰
- å¯¼æ¼”è¯­ä¹‰åˆ¤æ–­ï¼ˆ"ä¿æŒä¸åŠ¨"+"è„šä¸‹" â†’ lyingï¼‰

**æ–°ç‰ˆæœ¬**ï¼ˆç²¾ç®€ï¼‰ï¼š
```text
ä½ æ˜¯å›¾åƒç”Ÿæˆåœºæ™¯åˆ†æä¸“å®¶ã€‚
è¯·åˆ†æç»™å®šæç¤ºè¯çš„ã€ŒåŠ¨ä½œã€å§¿æ€ã€é•œå¤´éœ€æ±‚ã€ï¼Œå¹¶ç»“æ„åŒ–è¾“å‡ºã€‚

åˆ†æåŸåˆ™ï¼š
1. æ ¹æ®è¯­ä¹‰æ¨æ–­çœŸå®å§¿æ€ï¼Œè€Œä¸æ˜¯é»˜è®¤ç«™ç«‹
2. è‹¥äººç‰©ä¸åœ°é¢äº§ç”Ÿç›´æ¥æ¥è§¦ï¼Œåº”ä¼˜å…ˆè€ƒè™‘ç›¸åº”çš„å§¿æ€ç±»å‹
3. posture_positive / negative ä½¿ç”¨è‹±æ–‡ï¼Œä¾¿äºç”Ÿæˆæ¨¡å‹ç†è§£
4. æ¨èé•œå¤´åº”æ”¯æŒå§¿æ€ä¸ç¯å¢ƒåŒæ—¶å¯è§ï¼ˆå¦‚æœéœ€è¦ï¼‰
```

**æ”¹è¿›ç‚¹**ï¼š
- âœ… ç§»é™¤ç¡¬è§„åˆ™ï¼ˆä¸‹æ²‰åˆ°ä»£ç å±‚ï¼‰
- âœ… ç§»é™¤å¼ºåˆ¶æ¨¡æ¿ï¼ˆç”± PostureController æä¾›ï¼‰
- âœ… åªä¿ç•™è¯­ä¹‰ç†è§£åŸåˆ™

---

### 2. å¢å¼º PostureControllerï¼ˆè§„åˆ™å¼•æ“å±‚ï¼‰

**æ–°å¢åŠŸèƒ½**ï¼š`analyze_director_semantics()`

```python
def analyze_director_semantics(self, prompt: str) -> Dict[str, Any]:
    """
    å¯¼æ¼”è¯­ä¹‰åˆ†æï¼ˆè§„åˆ™å¼•æ“å±‚ï¼‰
    
    åˆ¤æ–­å¯¼æ¼”æ„å›¾ï¼Œè€Œä¸æ˜¯è¯­è¨€å­¦å¿…ç„¶ã€‚
    ä¾‹å¦‚ï¼š"ä¿æŒä¸åŠ¨"+"è„šä¸‹" â†’ å¯èƒ½æ˜¯ lyingï¼Œä½†ä¸æ˜¯å¿…ç„¶ã€‚
    """
    # è§„åˆ™1: "ä¿æŒä¸åŠ¨" + "è„šä¸‹" â†’ lying å€™é€‰ï¼ˆä½†ä¸æ˜¯å¿…ç„¶ï¼‰
    # è§„åˆ™2: "ä½“ä¼š" + "è„šä¸‹" â†’ lying å€™é€‰
    # è§„åˆ™3: æ˜ç¡®åŠ¨ä½œè¯ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
```

**ç‰¹ç‚¹**ï¼š
- âœ… è¿”å› `posture_hint`ï¼ˆå€™é€‰ï¼Œä¸æ˜¯å¼ºåˆ¶ï¼‰
- âœ… è¿”å›ç½®ä¿¡åº¦ï¼ˆ0.0-1.0ï¼‰
- âœ… å¯æ‰©å±•ï¼ˆæ–°è§„åˆ™åªéœ€æ·»åŠ ä»£ç ï¼‰

---

### 3. åˆ›å»ºå†³ç­–è¡¨ï¼ˆå·¥ç¨‹çº§æ˜ å°„ï¼‰

**æ–°æ–‡ä»¶**ï¼š`utils/posture_decision_table.py`

```python
POSTURE_SHOT_DECISION_TABLE = {
    PostureType.LYING: {
        "recommended_shots": [ShotType.FULL, ShotType.WIDE, ShotType.MEDIUM],
        "needs_ground": True,
        "needs_full_body": True,  # ä½†å¯ä»¥è¦†ç›–ï¼ˆä¸­è¿‘æ™¯èººç€ä¹Ÿå¸¸è§ï¼‰
        "reference_strength_reduction": 20,  # é™ä½å‚è€ƒå¼ºåº¦
        "priority": "high"
    },
    # ...
}
```

**åŠŸèƒ½**ï¼š
- âœ… åŠ¨ä½œ â†’ å§¿æ€ â†’ é•œå¤´çš„æ˜ å°„
- âœ… å‚è€ƒå¼ºåº¦è°ƒæ•´
- âœ… ä¼˜å…ˆçº§æ§åˆ¶

---

### 4. é‡æ„ Execution Planner V3

**æ•´åˆæµç¨‹**ï¼š

```python
# 1. è·å– LLM çš„è¯­ä¹‰ç†è§£ç»“æœ
llm_posture_type = analysis_result.posture_type

# 2. ä½¿ç”¨è§„åˆ™å¼•æ“åšå¯¼æ¼”è¯­ä¹‰åˆ¤æ–­
director_semantics = posture_controller.analyze_director_semantics(original_prompt)
posture_hint = director_semantics.get("posture_hint")

# 3. æ•´åˆè§„åˆ™å±‚å’Œ LLM å±‚
final_posture_type = llm_posture_type or posture_hint

# 4. ä½¿ç”¨å†³ç­–è¡¨å†³å®šé•œå¤´
recommended_shot = recommend_shot_for_posture(
    posture_type=final_posture_type,
    current_shot=shot_type,
    needs_ground=analysis_result.needs_ground_visible,
    needs_environment=analysis_result.needs_environment_visible
)

# 5. ç”Ÿæˆå¢å¼ºæè¿°ï¼ˆç”± Execution Planner æ ¹æ®è§„åˆ™ç”Ÿæˆï¼‰
enhancement_descriptions = []
if decision.get("needs_full_body"):
    enhancement_descriptions.append("å…¨èº«å¯è§ï¼Œå®Œæ•´èº«ä½“")
```

---

## âœ… ä¼˜åŠ¿å¯¹æ¯”

| ç»´åº¦ | åŸæ¶æ„ | æ–°æ¶æ„ |
|------|--------|--------|
| **å¯ç»´æŠ¤æ€§** | âŒ è§„åˆ™åœ¨ prompt ä¸­ï¼Œéš¾ä»¥ä¿®æ”¹ | âœ… è§„åˆ™åœ¨ä»£ç ä¸­ï¼Œæ˜“äºä¿®æ”¹ |
| **å¯æ‰©å±•æ€§** | âŒ æ–°åŠ¨ä½œéœ€è¦æ”¹ prompt | âœ… æ–°åŠ¨ä½œåªéœ€æ·»åŠ ä»£ç  |
| **LLM è§’è‰²** | âŒ è§„åˆ™æ‰§è¡Œå™¨ | âœ… è¯­ä¹‰ç†è§£å™¨ |
| **è§„åˆ™çµæ´»æ€§** | âŒ ç¡¬è§„åˆ™ï¼Œä¸å¯è¦†ç›– | âœ… å€™é€‰æç¤ºï¼Œå¯è¦†ç›– |
| **å·¥ç¨‹å¥åº·åº¦** | âš ï¸ èƒ½ç”¨ä½†ä¸è¯¥é•¿æœŸç”¨ | âœ… å·¥ç¨‹çº§æ¶æ„ |

---

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯ï¼š "éŸ©ç«‹ä¿æŒä¸åŠ¨ï¼Œé™é™ä½“ä¼šè„šä¸‹ç‚½çƒ­çš„æ²™åœ°"

**å¤„ç†æµç¨‹**ï¼š

1. **è§„åˆ™å¼•æ“å±‚**ï¼š
   ```python
   director_semantics = {
       "posture_hint": "lying_candidate",
       "confidence": 0.7,
       "needs_ground": True,
       "needs_full_body": True
   }
   ```

2. **LLM è¯­ä¹‰ç†è§£å±‚**ï¼š
   ```json
   {
       "posture_type": "lying",
       "posture_positive": "lying on the ground, body fully reclined, ...",
       "needs_ground_visible": true
   }
   ```

3. **å†³ç­–è¡¨å±‚**ï¼š
   ```python
   decision = {
       "recommended_shots": ["full", "wide", "medium"],
       "reference_strength_reduction": 20
   }
   ```

4. **Execution Planner**ï¼š
   - æ•´åˆï¼š`final_posture_type = "lying"`
   - æ¨èé•œå¤´ï¼š`full`ï¼ˆéœ€è¦åœ°é¢å’Œå…¨èº«ï¼‰
   - é™ä½å‚è€ƒå¼ºåº¦ï¼š`60% â†’ 40%`
   - ç”Ÿæˆ promptï¼š`lying on the ground, ... + å…¨èº«é•œå¤´ + åŸå§‹prompt`

---

## ğŸ“Š æ¶æ„å¯¹æ¯”

### åŸæ¶æ„ï¼ˆä¸æ¨èï¼‰

```
LLM Prompt (åŒ…å«ç¡¬è§„åˆ™)
    â†“
LLM è¿”å›ï¼ˆå¼ºåˆ¶ç»“æœï¼‰
    â†“
ç›´æ¥ä½¿ç”¨
```

**é—®é¢˜**ï¼š
- LLM è¢«é™çº§æˆ if-else
- è§„åˆ™éš¾ä»¥æ‰©å±•
- Prompt è„†å¼±

---

### æ–°æ¶æ„ï¼ˆæ¨èï¼‰

```
è§„åˆ™å¼•æ“ (å¯¼æ¼”è¯­ä¹‰åˆ¤æ–­)
    â†“ hint
LLM (è¯­ä¹‰ç†è§£)
    â†“ æ•´åˆ
å†³ç­–è¡¨ (å·¥ç¨‹çº§æ˜ å°„)
    â†“ å†³ç­–
Execution Planner (ç”Ÿæˆ prompt)
```

**ä¼˜åŠ¿**ï¼š
- âœ… è§„åˆ™åœ¨ä»£ç ä¸­ï¼Œæ˜“äºç»´æŠ¤
- âœ… LLM åšè¯­ä¹‰ç†è§£ï¼Œä¸æ˜¯è§„åˆ™æ‰§è¡Œ
- âœ… å¯æ‰©å±•ã€å¯è¦†ç›–

---

## ğŸ¯ ä¸‹ä¸€æ­¥ä¼˜åŒ–

1. **æ‰©å±•è§„åˆ™å¼•æ“**ï¼š
   - æ·»åŠ æ›´å¤šå¯¼æ¼”è¯­ä¹‰è§„åˆ™
   - æ”¯æŒè‡ªå®šä¹‰è§„åˆ™é…ç½®

2. **å®Œå–„å†³ç­–è¡¨**ï¼š
   - æ·»åŠ æ›´å¤šå§¿æ€ç±»å‹
   - æ”¯æŒåœºæ™¯ç‰¹å®šçš„é•œå¤´æ¨è

3. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - è§„åˆ™å¼•æ“ç»“æœç¼“å­˜
   - LLM ç»“æœç¼“å­˜

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `utils/scene_analyzer.py` - LLM åœºæ™¯åˆ†æå™¨ï¼ˆç²¾ç®€ promptï¼‰
- `utils/posture_controller.py` - å§¿æ€æ§åˆ¶å™¨ï¼ˆè§„åˆ™å¼•æ“å±‚ï¼‰
- `utils/posture_decision_table.py` - å†³ç­–è¡¨ï¼ˆå·¥ç¨‹çº§æ˜ å°„ï¼‰
- `execution_planner_v3.py` - æ‰§è¡Œè§„åˆ’å™¨ï¼ˆæ•´åˆå±‚ï¼‰

---

*æ¶æ„é‡æ„å®Œæˆï¼Œç³»ç»Ÿæ›´å¥åº·ã€å¯ç»´æŠ¤ã€å¯æ‰©å±•* âœ…

