# 组件安装指南

## 当前状态

由于磁盘空间限制，部分组件无法立即安装。以下是安装指南和替代方案。

## 已安装的组件

✅ **PyTorch 2.7.1** (CUDA 12.6)
✅ **PyYAML**
✅ **基础依赖**

## 需要安装的组件

### 1. FFmpeg（系统级安装，不在虚拟环境中）

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install ffmpeg

# 或使用 conda（如果可用）
conda install -c conda-forge ffmpeg

# 验证安装
ffmpeg -version
```

**注意**: FFmpeg 是系统工具，不需要在虚拟环境中安装。

### 2. 音频处理库（小体积，可以安装）

```bash
source /vepfs-dev/shawn/venv/py312/bin/activate

# 安装音频处理库（如果空间允许）
pip install librosa soundfile

# 如果空间不足，可以只安装 soundfile（更小）
pip install soundfile
```

### 3. ChatTTS（推荐，中等体积）

```bash
source /vepfs-dev/shawn/venv/py312/bin/activate

# 安装 ChatTTS
pip install chattts

# 首次运行时会自动下载模型（约1-2GB）
```

**如果空间不足**:
- 可以先清理虚拟环境：`pip cache purge`
- 或使用其他位置的缓存：`pip install --cache-dir /path/to/large/disk chattts`

### 4. WhisperX（较大，可选）

```bash
source /vepfs-dev/shawn/venv/py312/bin/activate

# 安装 WhisperX
pip install whisperx

# 首次运行时会下载模型（large-v3 约 3GB）
```

**如果空间不足**:
- 可以使用 smaller 模型（base, small）
- 或使用在线 API（如 OpenAI Whisper API）

### 5. Stability-AI generative-models（大型，可选）

```bash
# 克隆仓库（需要较大空间）
cd /vepfs-dev/shawn
git clone https://github.com/Stability-AI/generative-models.git

# 安装依赖
cd generative-models
source /vepfs-dev/shawn/venv/py312/bin/activate
pip install -r requirements/pt2.txt
pip install .

# 设置环境变量
export GENERATIVE_MODELS_PATH=/vepfs-dev/shawn/generative-models
```

**SVD 模型下载**:
```bash
# 使用 huggingface-cli
pip install huggingface_hub
huggingface-cli download stabilityai/stable-video-diffusion-img2vid-xt

# 或手动下载到指定目录
```

## 磁盘空间管理

### 检查磁盘空间

```bash
# 检查虚拟环境大小
du -sh /vepfs-dev/shawn/venv/py312

# 检查可用空间
df -h /vepfs-dev/shawn

# 清理 pip 缓存
pip cache purge

# 清理不需要的包
pip uninstall -y <package_name>
```

### 优化安装

1. **使用 --no-cache-dir**:
   ```bash
   pip install --no-cache-dir chattts
   ```

2. **安装到其他位置**:
   ```bash
   pip install --target /path/to/large/disk chattts
   ```

3. **使用 conda**（如果可用）:
   ```bash
   conda install -c conda-forge chattts
   ```

## 最小化安装方案

如果磁盘空间非常有限，可以只安装必要组件：

### 方案1: 仅使用脚本解析和视频合成

```bash
# 只需要 FFmpeg（系统级）
sudo apt install ffmpeg

# Python 依赖（已安装）
# 可以手动生成视频片段，然后使用系统合成
```

### 方案2: 使用在线服务

- **TTS**: 使用在线 TTS API（如 Azure、Google TTS）
- **字幕**: 使用在线字幕服务
- **视频生成**: 使用在线视频生成服务

### 方案3: 分步安装

1. 先安装小体积组件（librosa, soundfile）
2. 清理空间后安装 ChatTTS
3. 最后安装大型组件（WhisperX, generative-models）

## 声音克隆相关安装

### 必需库

```bash
source /vepfs-dev/shawn/venv/py312/bin/activate

# 音频处理（必需）
pip install librosa soundfile

# ChatTTS（声音克隆）
pip install chattts
```

### 验证安装

```bash
python -c "import chattts; import librosa; import soundfile; print('✓ 所有库已安装')"
```

## 安装顺序建议

1. **FFmpeg**（系统级，必需）
2. **librosa, soundfile**（小体积，推荐）
3. **ChatTTS**（中等体积，推荐用于声音克隆）
4. **WhisperX**（较大，可选）
5. **generative-models**（很大，可选）

## 故障排除

### 磁盘空间不足

```bash
# 清理 pip 缓存
pip cache purge

# 清理虚拟环境
find /vepfs-dev/shawn/venv/py312 -name "*.pyc" -delete
find /vepfs-dev/shawn/venv/py312 -name "__pycache__" -type d -exec rm -r {} +

# 检查大文件
du -sh /vepfs-dev/shawn/venv/py312/lib/python*/site-packages/* | sort -h | tail -20
```

### 安装失败

```bash
# 使用 verbose 模式查看详细错误
pip install -v chattts

# 尝试单独安装依赖
pip install torch torchvision torchaudio
pip install transformers
pip install chattts --no-deps
pip install <missing_dependency>
```

## 当前可用功能

即使某些组件未安装，以下功能仍可使用：

1. ✅ **脚本解析** - 已测试，可以正常工作
2. ✅ **配置文件管理** - 可以使用
3. ⚠️ **视频合成** - 需要 FFmpeg（系统级安装）
4. ⚠️ **TTS 生成** - 需要 ChatTTS
5. ⚠️ **字幕生成** - 需要 WhisperX
6. ⚠️ **视频生成** - 需要 generative-models

## 下一步

1. **安装 FFmpeg**（系统级，不占用虚拟环境空间）
2. **安装音频处理库**（librosa, soundfile）
3. **录制参考音频**（用于声音克隆）
4. **安装 ChatTTS**（如果空间允许）
5. **测试声音克隆功能**

## 参考

- [ChatTTS 文档](https://github.com/2noise/ChatTTS)
- [WhisperX 文档](https://github.com/m-bain/whisperX)
- [FFmpeg 文档](https://ffmpeg.org/documentation.html)

