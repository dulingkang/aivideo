# 图像生成质量优化说明

## 优化目标
解决以下问题：
1. **横向拉伸**：人物被横向拉伸，比例不自然
2. **服饰不对**：生成的服饰与角色设定不符
3. **质量不稳定**：有些形象是对的，有些不对

## 优化策略
根据分析，**决定生成质量的关键要素是 YAML 配置参数**，而不是 prompt 的质量。本次优化重点调整了以下核心参数：

---

## 配置参数优化（config.yaml）

### 1. 推理步数优化
```yaml
num_inference_steps: 60  # 从 50 提高到 60
```
- **影响**：提高生成质量，减少拉伸和变形
- **建议范围**：50-70（步数越多质量越好但速度越慢）

### 2. 引导尺度优化
```yaml
guidance_scale: 7.5  # 从 8.5 降到 7.5
```
- **影响**：减少过度引导，使生成更自然，避免僵硬
- **建议范围**：7.0-8.5（过高可能导致过度引导和僵硬）

### 3. 面部权重优化
```yaml
face_emb_scale: 0.65  # 从 0.55 提高到 0.65
```
- **影响**：确保角色一致性和服饰准确性
- **建议范围**：0.5-0.7（过低角色不像，过高可能导致僵硬）

### 4. 面部关键点缩放优化（关键参数）
```yaml
face_kps_scale: 0.85  # 从 1.0 降到 0.85
```
- **影响**：**这是解决横向拉伸的关键参数**
- **原理**：降低关键点缩放可以减少 ControlNet 的过度控制，避免人物被拉伸
- **建议范围**：0.7-0.9（降低可减少横向拉伸）

### 5. LoRA 权重优化
```yaml
lora:
  alpha: 0.75  # 从 0.7 提高到 0.75
  ip_adapter_scale_multiplier: 0.55  # 从 0.5 提高到 0.55
```
- **影响**：增强角色特征和服饰准确性，平衡角色一致性和 LoRA 特征
- **建议范围**：
  - `alpha`: 0.6-0.8（过低特征不明显，过高可能导致过度风格化）
  - `ip_adapter_scale_multiplier`: 0.4-0.6（过低角色不像，过高可能导致冲突）

---

## 代码动态参数优化（image_generator.py）

### 1. 中景/半身像场景优化（重点）
```python
# ControlNet 权重
controlnet_scale = 0.28  # 从 0.35 降到 0.28
min_controlnet_scale = 0.25  # 从 0.30 降到 0.25

# 面部关键点缩放
face_kps_scale = face_kps_scale_cfg * 0.60  # 从 0.55 提高到 0.60（因为基准值已降低）
```
- **影响**：进一步减少过度控制，避免横向拉伸
- **原理**：降低 ControlNet 权重和关键点缩放，给模型更多自由度，减少僵硬和拉伸

### 2. 近景/特写场景优化
```python
controlnet_scale = 0.30  # 从 0.35 降到 0.30
```
- **影响**：避免身体过宽、模糊和横向拉伸

---

## 参数影响说明

### 核心参数优先级（按影响程度）

1. **face_kps_scale**（最重要）
   - 直接影响人物比例和拉伸
   - 降低此值可显著减少横向拉伸

2. **controlnet_scale**（重要）
   - 控制 ControlNet 的强度
   - 过高会导致过度控制，产生僵硬和拉伸

3. **face_emb_scale**（重要）
   - 控制角色一致性
   - 影响角色相似度和服饰准确性

4. **num_inference_steps**（中等）
   - 影响生成质量
   - 步数越多质量越好，但速度越慢

5. **guidance_scale**（中等）
   - 控制文本提示的影响
   - 过高可能导致过度引导

6. **lora.alpha**（中等）
   - 控制角色特征强度
   - 影响服饰、发型等特征

---

## 使用建议

### 如果仍然出现横向拉伸
1. 进一步降低 `face_kps_scale`（例如：0.80 或 0.75）
2. 进一步降低中景场景的 `controlnet_scale`（例如：0.25 或 0.22）
3. 检查参考图像是否本身有拉伸问题

### 如果服饰仍然不对
1. 提高 `lora.alpha`（例如：0.80）
2. 提高 `face_emb_scale`（例如：0.70）
3. 检查 LoRA 模型是否训练充分

### 如果角色不像
1. 提高 `face_emb_scale`（例如：0.70）
2. 提高 `lora.alpha`（例如：0.80）
3. 检查参考图像质量

### 如果生成速度太慢
1. 降低 `num_inference_steps`（例如：50 或 55）
2. 使用 fp8 量化（如果硬件支持）

---

## 参数调优流程

1. **先调整核心参数**：`face_kps_scale` 和 `controlnet_scale`
2. **再调整角色一致性**：`face_emb_scale` 和 `lora.alpha`
3. **最后调整质量参数**：`num_inference_steps` 和 `guidance_scale`
4. **测试验证**：生成几张图片，观察效果
5. **微调**：根据结果微调参数，每次调整 0.05-0.1

---

## 注意事项

1. **参数相互影响**：调整一个参数可能影响其他参数的效果
2. **场景差异**：不同场景（远景/中景/近景）需要不同的参数
3. **模型差异**：不同的 LoRA 模型可能需要不同的权重
4. **参考图像**：参考图像的质量直接影响生成效果

---

## 优化效果预期

经过本次优化，预期可以：
- ✅ 显著减少横向拉伸问题
- ✅ 提高服饰准确性
- ✅ 提高生成质量稳定性
- ✅ 保持角色一致性

如果效果不理想，请按照上述"使用建议"进一步调整参数。

