# Promptæ¨¡å—é‡æ„å®æ–½è®¡åˆ’

## ğŸ“Š å½“å‰çŠ¶æ€

### å·²å®Œæˆ âœ…
1. **åŸºç¡€æ¨¡å—ç»“æ„**
   - `prompt/__init__.py` - æ¨¡å—å¯¼å‡º
   - `prompt/token_estimator.py` - Tokenä¼°ç®—å™¨ï¼ˆçº¦150è¡Œï¼‰
   - `prompt/parser.py` - Promptè§£æå™¨ï¼ˆçº¦150è¡Œï¼‰
   - `prompt/optimizer.py` - Promptä¼˜åŒ–å™¨ï¼ˆçº¦200è¡Œï¼‰
   - `prompt/builder.py` - Promptæ„å»ºå™¨ï¼ˆåŸºç¡€æ¡†æ¶ï¼Œå¾…å®Œå–„ï¼‰

### å¾…å®Œæˆ â³
1. **PromptBuilder å®Œæ•´å®ç°**
   - `build()` æ–¹æ³•ï¼ˆçº¦1500è¡Œï¼Œæœ€å¤æ‚ï¼‰
   - è¾…åŠ©æ–¹æ³•ï¼š
     - `_convert_camera_to_prompt()` (çº¦170è¡Œ)
     - `_convert_motion_to_prompt()` (çº¦60è¡Œ)
     - `_looks_like_camera_prompt()` (çº¦10è¡Œ)
     - `_build_character_prompt()` (çº¦40è¡Œ)
     - `_build_character_prompt_compact()` (çº¦60è¡Œ)
     - `_build_character_description_prompt()` (çº¦70è¡Œ)
     - `_build_scene_background_prompt()` (çº¦100è¡Œ)
     - `_build_scene_background_prompt_compact()` (çº¦70è¡Œ)

2. **ä¾èµ–æ³¨å…¥**
   - `_identify_characters_in_scene()` - éœ€è¦ä» ImageGenerator æ³¨å…¥
   - `_needs_character()` - éœ€è¦ä» ImageGenerator æ³¨å…¥

---

## ğŸ¯ å®æ–½ç­–ç•¥

### æ–¹æ¡ˆAï¼šå®Œæ•´è¿ç§»ï¼ˆæ¨èï¼Œä½†å·¥ä½œé‡å¤§ï¼‰

**æ­¥éª¤**ï¼š
1. åˆ›å»º `PromptBuilder` çš„å®Œæ•´å®ç°
2. å°†æ‰€æœ‰è¾…åŠ©æ–¹æ³•è¿ç§»åˆ° `PromptBuilder`
3. æ›´æ–° `ImageGenerator` ä½¿ç”¨ `PromptBuilder`
4. ä¿æŒå‘åå…¼å®¹

**ä¼˜ç‚¹**ï¼š
- âœ… å½»åº•è§£è€¦
- âœ… æ˜“äºæµ‹è¯•
- âœ… ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™

**ç¼ºç‚¹**ï¼š
- âš ï¸ å·¥ä½œé‡å¤§ï¼ˆéœ€è¦è¿ç§»çº¦2000è¡Œä»£ç ï¼‰
- âš ï¸ éœ€è¦ä»”ç»†å¤„ç†ä¾èµ–å…³ç³»

### æ–¹æ¡ˆBï¼šæ¸è¿›å¼è¿ç§»ï¼ˆæ¨èç”¨äºå¿«é€Ÿå®æ–½ï¼‰

**æ­¥éª¤**ï¼š
1. å…ˆåˆ›å»º `PromptBuilder` ä½œä¸º `ImageGenerator.build_prompt()` çš„åŒ…è£…å™¨
2. é€æ­¥å°†æ–¹æ³•è¿ç§»åˆ° `PromptBuilder`
3. æœ€åæ›¿æ¢ `ImageGenerator.build_prompt()` çš„å®ç°

**ä¼˜ç‚¹**ï¼š
- âœ… é£é™©å°ï¼Œå¯ä»¥é€æ­¥éªŒè¯
- âœ… ä¿æŒå‘åå…¼å®¹
- âœ… å¯ä»¥åˆ†é˜¶æ®µå®æ–½

**ç¼ºç‚¹**ï¼š
- âš ï¸ è¿‡æ¸¡æœŸä¼šæœ‰ä»£ç é‡å¤

---

## ğŸ“‹ è¯¦ç»†è¿ç§»æ¸…å•

### é˜¶æ®µ1ï¼šè¾…åŠ©æ–¹æ³•è¿ç§»ï¼ˆä½é£é™©ï¼‰

- [ ] `_convert_camera_to_prompt()` â†’ `PromptBuilder._convert_camera_to_prompt()`
- [ ] `_convert_motion_to_prompt()` â†’ `PromptBuilder._convert_motion_to_prompt()`
- [ ] `_looks_like_camera_prompt()` â†’ `PromptBuilder._looks_like_camera_prompt()`
- [ ] `_translate_chinese_to_english()` â†’ `PromptBuilder._translate_chinese_to_english()` âœ… (å·²å®Œæˆ)
- [ ] `_clean_prompt_text()` â†’ `PromptBuilder._clean_prompt_text()` âœ… (å·²å®Œæˆ)

### é˜¶æ®µ2ï¼šè§’è‰²å’Œåœºæ™¯æ–¹æ³•è¿ç§»ï¼ˆä¸­é£é™©ï¼‰

- [ ] `_build_character_prompt()` â†’ `PromptBuilder._build_character_prompt()`
- [ ] `_build_character_prompt_compact()` â†’ `PromptBuilder._build_character_prompt_compact()`
- [ ] `_build_character_description_prompt()` â†’ `PromptBuilder._build_character_description_prompt()`
- [ ] `_build_scene_background_prompt()` â†’ `PromptBuilder._build_scene_background_prompt()`
- [ ] `_build_scene_background_prompt_compact()` â†’ `PromptBuilder._build_scene_background_prompt_compact()`
- [ ] `_get_character_profile()` â†’ `PromptBuilder._get_character_profile()` âœ… (å·²å®Œæˆ)
- [ ] `_get_scene_profile()` â†’ `PromptBuilder._get_scene_profile()` âœ… (å·²å®Œæˆ)

### é˜¶æ®µ3ï¼šä¸»æ–¹æ³•è¿ç§»ï¼ˆé«˜é£é™©ï¼Œéœ€è¦ä»”ç»†å¤„ç†ï¼‰

- [ ] `build_prompt()` â†’ `PromptBuilder.build()`
  - éœ€è¦å¤„ç†ä¾èµ–ï¼š
    - `intent_analyzer` âœ… (å·²æ³¨å…¥)
    - `_identify_characters_in_scene()` (éœ€è¦æ³¨å…¥)
    - `_needs_character()` (éœ€è¦æ³¨å…¥)
    - `character_profiles` âœ… (å·²æ³¨å…¥)
    - `scene_profiles` âœ… (å·²æ³¨å…¥)

### é˜¶æ®µ4ï¼šé›†æˆå’Œæµ‹è¯•ï¼ˆå…³é”®ï¼‰

- [ ] æ›´æ–° `ImageGenerator.__init__()` åˆ›å»º `PromptBuilder` å®ä¾‹
- [ ] æ›´æ–° `ImageGenerator.build_prompt()` å§”æ‰˜ç»™ `PromptBuilder.build()`
- [ ] è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
- [ ] éªŒè¯åŠŸèƒ½æ­£å¸¸
- [ ] æ€§èƒ½æµ‹è¯•

---

## ğŸ”§ ä¾èµ–å¤„ç†

### éœ€è¦æ³¨å…¥çš„ä¾èµ–

1. **`_identify_characters_in_scene()`**
   - å½“å‰åœ¨ `ImageGenerator` ä¸­
   - é€‰é¡¹Aï¼šç§»åˆ° `PromptBuilder`ï¼ˆå¦‚æœåªç”¨äºpromptæ„å»ºï¼‰
   - é€‰é¡¹Bï¼šä½œä¸ºä¾èµ–æ³¨å…¥ï¼ˆå¦‚æœå…¶ä»–åœ°æ–¹ä¹Ÿä½¿ç”¨ï¼‰

2. **`_needs_character()`**
   - å½“å‰åœ¨ `ImageGenerator` ä¸­
   - é€‰é¡¹Aï¼šç§»åˆ° `PromptBuilder`
   - é€‰é¡¹Bï¼šä½œä¸ºä¾èµ–æ³¨å…¥

### å»ºè®®æ–¹æ¡ˆ

**æ–¹æ¡ˆ1ï¼šæ–¹æ³•æ³¨å…¥ï¼ˆæ¨èï¼‰**
```python
class PromptBuilder:
    def __init__(self, ..., identify_characters_fn, needs_character_fn):
        self._identify_characters = identify_characters_fn
        self._needs_character = needs_character_fn
```

**æ–¹æ¡ˆ2ï¼šå®Œæ•´è¿ç§»**
```python
# å°† _identify_characters_in_scene å’Œ _needs_character ä¹Ÿç§»åˆ° PromptBuilder
# å¦‚æœå®ƒä»¬åªç”¨äºpromptæ„å»º
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¿æŒå‘åå…¼å®¹**
   - `ImageGenerator.build_prompt()` çš„æ¥å£ä¸èƒ½å˜
   - å†…éƒ¨å®ç°å¯ä»¥é‡æ„

2. **æµ‹è¯•è¦†ç›–**
   - æ¯ä¸ªè¿ç§»çš„æ–¹æ³•éƒ½è¦æœ‰å•å…ƒæµ‹è¯•
   - é›†æˆæµ‹è¯•ç¡®ä¿æ•´ä½“åŠŸèƒ½æ­£å¸¸

3. **æ€§èƒ½å½±å“**
   - ç¡®ä¿é‡æ„åæ€§èƒ½ä¸ä¸‹é™
   - æ³¨æ„ä¾èµ–æ³¨å…¥çš„å¼€é”€

4. **é”™è¯¯å¤„ç†**
   - ä¿æŒåŸæœ‰çš„é”™è¯¯å¤„ç†é€»è¾‘
   - æ·»åŠ é€‚å½“çš„æ—¥å¿—

---

## ğŸ“… æ—¶é—´ä¼°ç®—

- **é˜¶æ®µ1ï¼ˆè¾…åŠ©æ–¹æ³•ï¼‰**: 2-3å°æ—¶
- **é˜¶æ®µ2ï¼ˆè§’è‰²/åœºæ™¯æ–¹æ³•ï¼‰**: 3-4å°æ—¶
- **é˜¶æ®µ3ï¼ˆä¸»æ–¹æ³•ï¼‰**: 4-6å°æ—¶
- **é˜¶æ®µ4ï¼ˆé›†æˆæµ‹è¯•ï¼‰**: 2-3å°æ—¶

**æ€»è®¡**: çº¦11-16å°æ—¶

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³æ‰§è¡Œ**: å®Œæˆ `PromptBuilder` çš„è¾…åŠ©æ–¹æ³•è¿ç§»ï¼ˆé˜¶æ®µ1ï¼‰
2. **æœ¬å‘¨å®Œæˆ**: å®Œæˆè§’è‰²å’Œåœºæ™¯æ–¹æ³•è¿ç§»ï¼ˆé˜¶æ®µ2ï¼‰
3. **ä¸‹å‘¨å®Œæˆ**: å®Œæˆä¸»æ–¹æ³•è¿ç§»å’Œé›†æˆï¼ˆé˜¶æ®µ3-4ï¼‰

















