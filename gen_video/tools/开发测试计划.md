# 开发测试计划（2025-01-19）

## 📋 当前状态

### ✅ 已完成
1. **CLIP模型下载优化** - 支持多种下载方式，自动修复损坏文件
2. **身份注入逻辑修复** - 无参考图像时自动跳过身份注入
3. **场景配置分析** - 完成 `lingjie/episode/1.v2-1.json` 分析
4. **Execution Planner V3验证** - 参考强度策略正确（场景1: 30，场景3: 85）
5. **M6集成验证** - 正确识别需要M6的场景

### ⚠️ 发现问题
- **场景1视频缺失**：图片已生成（772KB），但视频未生成
  - 可能原因：M6验证失败、生成中断、或仍在生成中

### 🔄 进行中
- 排查场景1视频缺失原因
- 继续生成剩余场景（场景2、3、999）

---

## 🎯 下一步开发测试计划

### 阶段1: 问题排查（优先级：高）

#### 1.1 调试场景1视频缺失问题
**工具**: `tools/debug_scene_generation.py`

```bash
cd gen_video
python3 tools/debug_scene_generation.py --output-dir outputs/lingjie_ep1_v2 --scene-id 001
```

**检查项**:
- [ ] 图片文件是否存在且完整
- [ ] 视频文件是否存在（可能在不同路径）
- [ ] M6报告是否存在，验证结果如何
- [ ] 日志文件中是否有错误信息
- [ ] 是否有部分生成的文件（.tmp）

**预期结果**:
- 确定视频缺失的具体原因
- 如果是M6验证失败，记录失败原因
- 如果是生成中断，记录中断位置

#### 1.2 修复批量生成脚本
**问题**: 需要添加 `--skip-existing` 和 `--continue-on-error` 参数

**修改文件**: `tools/batch_novel_generator.py`

**功能**:
- `--skip-existing`: 跳过已生成图片/视频的场景
- `--continue-on-error`: 遇到错误继续处理下一个场景
- 添加进度监控（每完成一个场景输出状态）
- 添加超时保护（避免长时间卡住）

---

### 阶段2: 继续生成（优先级：高）

#### 2.1 重新生成场景1视频
**如果场景1视频确实缺失**:
```bash
cd gen_video
python3 generate_novel_video.py \
    --json-path ../lingjie/episode/1.v2-1.json \
    --scene-ids 1 \
    --output-dir outputs/lingjie_ep1_v2_retry
```

#### 2.2 生成剩余场景
**场景列表**:
- 场景2: 天空三颗太阳（无角色，不需要M6）
- 场景3: 韩立特写（需要M6，参考强度85）
- 场景999: 结尾（无角色，不需要M6）

**使用批量生成脚本**:
```bash
cd gen_video
./tools/继续生成场景.sh
```

**或手动指定场景**:
```bash
python3 tools/batch_novel_generator.py \
    --json-path ../lingjie/episode/1.v2-1.json \
    --scene-ids 2,3,999 \
    --output-dir outputs/lingjie_ep1_v2_continue
```

---

### 阶段3: 验证和优化（优先级：中）

#### 3.1 角色一致性验证
**目标**: 验证场景1和场景3的韩立是否一致

**工具**: 使用M6验证报告中的相似度指标

**检查项**:
- [ ] 场景1的M6相似度（预期：≥0.65）
- [ ] 场景3的M6相似度（预期：≥0.75，特写需要更高）
- [ ] 两个场景之间的角色一致性（如果可能，进行跨场景相似度对比）

#### 3.2 生成完整报告
**工具**: 扩展 `batch_novel_generator.py` 的报告功能

**报告内容**:
- 所有场景的生成状态（图片/视频/M6）
- 图片质量分析（相似度、构图等）
- M6验证结果汇总
- 生成时间统计
- 失败场景和原因分析

**输出格式**:
- JSON报告：`batch_report.json`
- Markdown报告：`batch_report.md`

---

### 阶段4: 批量生成优化（优先级：中）

#### 4.1 添加进度监控
**功能**:
- 实时显示当前处理的场景
- 显示已完成/总数
- 显示预计剩余时间
- 每完成一个场景立即保存状态

#### 4.2 错误重试机制
**功能**:
- M6验证失败自动重试（最多3次）
- 生成中断自动恢复
- 记录重试次数和原因

#### 4.3 超时保护
**功能**:
- 图片生成超时：5分钟
- 视频生成超时：10分钟
- M6验证超时：2分钟
- 超时后自动跳过并记录

---

## 📊 测试检查清单

### 场景1（韩立躺在沙地）
- [ ] 图片已生成且完整
- [ ] 视频已生成且完整
- [ ] M6验证通过（相似度≥0.65）
- [ ] 参考强度正确（30）
- [ ] 姿态正确（lying）

### 场景2（天空三颗太阳）
- [ ] 图片已生成
- [ ] 视频已生成
- [ ] 不需要M6验证
- [ ] 场景描述正确

### 场景3（韩立特写）
- [ ] 图片已生成且完整
- [ ] 视频已生成且完整
- [ ] M6验证通过（相似度≥0.75）
- [ ] 参考强度正确（85）
- [ ] 面部清晰可见

### 场景999（结尾）
- [ ] 图片已生成
- [ ] 视频已生成
- [ ] 不需要M6验证

---

## 🔧 开发任务清单

### 高优先级
1. [ ] 修复批量生成脚本的 `--skip-existing` 参数
2. [ ] 添加 `--continue-on-error` 参数
3. [ ] 运行调试脚本排查场景1问题
4. [ ] 重新生成场景1视频（如果需要）
5. [ ] 生成剩余场景（2、3、999）

### 中优先级
6. [ ] 添加进度监控功能
7. [ ] 添加错误重试机制
8. [ ] 添加超时保护
9. [ ] 生成完整报告系统
10. [ ] 角色一致性验证工具

### 低优先级
11. [ ] 性能优化（模型加载复用）
12. [ ] 显存管理优化
13. [ ] 日志系统完善

---

## 📝 预期成果

### 短期（1-2天）
- ✅ 场景1问题排查完成
- ✅ 所有场景生成完成（5个场景）
- ✅ 基础报告生成

### 中期（3-5天）
- ✅ 批量生成脚本优化完成
- ✅ 完整报告系统上线
- ✅ 角色一致性验证通过

### 长期（1-2周）
- ✅ 性能优化完成
- ✅ 产线集成准备就绪
- ✅ 文档完善

---

## 🚀 立即行动

1. **运行调试脚本**:
   ```bash
   cd gen_video
   python3 tools/debug_scene_generation.py --output-dir outputs/lingjie_ep1_v2 --scene-id 001
   ```

2. **根据调试结果决定下一步**:
   - 如果视频确实缺失 → 重新生成场景1
   - 如果M6验证失败 → 分析失败原因并修复
   - 如果生成中断 → 检查日志并修复

3. **继续生成剩余场景**:
   ```bash
   ./tools/继续生成场景.sh
   ```

---

*最后更新: 2025-01-19*

