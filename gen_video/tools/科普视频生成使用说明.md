# 科普视频生成使用说明

## 快速开始

### 1. 激活主环境

```bash
source /vepfs-dev/shawn/venv/py312/bin/activate
cd /vepfs-dev/shawn/vid/fanren/gen_video
```

### 2. 查看可用选题

```bash
proxychains4 python tools/kepu_quick_generate.py --list
```

### 3. 生成科普视频

```bash
proxychains4 python tools/kepu_quick_generate.py \
  --topic "什么是黑洞？" \
  --ip-character kepu_gege
```

或者使用包装脚本：

```bash
bash tools/run_with_proxy.sh python tools/kepu_quick_generate.py \
  --topic "什么是黑洞？" \
  --ip-character kepu_gege
```

## 参数说明

- `--topic`: 选题标题（从知识库中选择，必须精确匹配）
- `--ip-character`: IP角色
  - `kepu_gege`: 科普哥哥（默认）
  - `weilai_jiejie`: 未来姐姐
- `--config`: 配置文件路径（默认: config.yaml）
- `--script`: 自定义脚本JSON文件路径（可选）
- `--list`: 列出所有可用选题

## 工作流程

1. **脚本生成**: 根据选题自动生成脚本JSON
2. **图像生成**: 使用 Flux.1 生成场景图像（科普风格）
3. **语音生成**: 通过子进程调用 CosyVoice 环境生成TTS
4. **视频合成**: 合成最终视频

## 输出位置

- 脚本JSON: `outputs/kepu_videos/{选题标题}_script.json`
- 图像: `outputs/images/{输出名称}/`
- 音频: `outputs/audio/{输出名称}/`
- 最终视频: `outputs/{输出名称}/{输出名称}.mp4`

## 环境说明

- **主环境**: `/vepfs-dev/shawn/venv/py312` - 用于图像、视频生成
- **CosyVoice 环境**: `/vepfs-dev/shawn/venv/cosyvoice` - 用于TTS生成（自动通过子进程调用）

## 注意事项

1. **网络代理**: 需要使用 `proxychains4` 来访问 HuggingFace 等外部资源
2. **GPU 内存**: 确保有足够的 GPU 内存（建议至少 24GB）
3. **生成时间**: 完整视频生成可能需要 5-10 分钟，取决于场景数量和模型加载时间

## 示例

### 生成"什么是黑洞？"视频

```bash
source /vepfs-dev/shawn/venv/py312/bin/activate
cd /vepfs-dev/shawn/vid/fanren/gen_video

proxychains4 python tools/kepu_quick_generate.py \
  --topic "什么是黑洞？" \
  --ip-character kepu_gege
```

### 使用未来姐姐生成视频

```bash
proxychains4 python tools/kepu_quick_generate.py \
  --topic "什么是黑洞？" \
  --ip-character weilai_jiejie
```

## 故障排除

### 问题1: 网络连接失败

**解决**: 确保 `proxychains4` 配置正确，并且代理服务正在运行

### 问题2: CosyVoice 子进程失败

**解决**: 检查 CosyVoice 环境是否正确配置：
```bash
source /vepfs-dev/shawn/venv/cosyvoice/bin/activate
python -c "import transformers; print(transformers.__version__)"
# 应该显示: 4.51.3
```

### 问题3: GPU 内存不足

**解决**: 
- 使用更轻量的模型（如 `sdxl` 或 `kolors`）
- 减少并发生成数量
- 清理 GPU 缓存

## 更多信息

- 配置文档: `gen_video/tools/dual_environment_setup.md`
- 测试工具: `gen_video/tools/test_dual_environment.py`

