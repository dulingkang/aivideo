# 参考强度调优测试结果分析

> 测试日期: 2025-12-17  
> 测试脚本: `test_reference_strength_tuning.py`

## 📊 测试结果汇总

| 参考强度 | 镜头类型 | 生成模式 | 状态 | 人脸相似度 | 备注 |
|---------|---------|---------|------|-----------|------|
| 40% | wide | 解耦融合 | ❌ OOM | - | 测试前显存被占用 |
| 50% | medium | 解耦融合 | ✅ 成功 | - | 使用原生模式 |
| 60% | medium | 解耦融合 | ✅ 成功 | - | 使用原生模式 |
| 70% | close | 解耦融合 | ⚠️ 部分成功 | 0.00 | 人脸检测失败 |
| 80% | close | 解耦融合 | ⚠️ 部分成功 | 0.00 | 人脸检测失败 |

## 🔍 问题分析

### 1. 第一个测试（40%）OOM
**原因**：测试开始前显存已被其他进程占用（95.21 GiB / 95.22 GiB）

**解决方案**：
- 测试前检查并清理显存
- 或者跳过第一个测试，从 50% 开始

### 2. 70% 和 80% 人脸检测失败

**现象**：
- 使用 diffusers pipeline 生成场景
- 场景生成后，人脸检测失败（"无法检测到人脸"）
- 相似度为 0.00

**可能原因**：
1. **场景生成问题**：解耦融合模式中，场景生成器可能生成了没有人物或人物不清晰的图像
2. **检测时机问题**：在场景生成阶段检测人脸，但此时还没有注入身份，可能人物特征不明显
3. **检测方法问题**：YOLO 检测人物区域，但人脸检测器在生成的图像中检测不到清晰人脸

**解决方案**：
1. 改进场景 prompt，确保包含人物描述
2. 在身份注入后再进行人脸检测（而不是在场景生成后）
3. 如果场景中没有人物，应该跳过解耦模式，直接使用 PuLID 模式

## 💡 优化建议

### 1. 改进解耦融合流程

当前流程：
```
场景生成 → 人物检测 → 身份注入 → 边缘融合 → 人脸验证
```

建议流程：
```
场景生成 → 人物检测 → 身份注入 → 边缘融合 → 人脸验证（在最终图像上）
```

**关键改进**：人脸验证应该在最终图像上进行，而不是在场景生成后的中间图像上。

### 2. 场景 Prompt 优化

解耦融合模式中，场景生成器需要生成包含人物的场景。当前 `_build_scene_prompt` 可能移除了人物描述，导致生成纯场景。

**建议**：保留人物描述，但降低权重，让环境占主导。

### 3. 模式选择优化

对于特写/近景（70%+），应该：
- 优先使用 PuLID 直接生成（不使用解耦模式）
- 解耦模式更适合远景/中景（参考强度 < 60%）

## 📈 参数调优建议

基于测试结果：

| 镜头类型 | 推荐参考强度 | 推荐模式 | 说明 |
|---------|------------|---------|------|
| extreme_wide | 20-30% | 解耦融合 | 环境优先 |
| wide | 30-40% | 解耦融合 | 环境优先 |
| full | 45-50% | 解耦融合 | 平衡 |
| american | 55-60% | PuLID 直接 | 平衡 |
| medium | 60-65% | PuLID 直接 | 平衡（推荐） |
| medium_close | 70-75% | PuLID 直接 | 人脸优先 |
| close | 75-85% | PuLID 直接 | 人脸优先 |
| extreme_close | 85-90% | PuLID 直接 | 强锁脸 |

## 🎯 下一步行动

1. ✅ **修复人脸检测逻辑**：在最终图像上验证，而不是中间图像（已完成）
2. ✅ **调整模式选择**：特写/近景（参考强度 > 70%）不使用解耦模式（已完成）
3. ⏳ **优化场景 Prompt**：确保包含人物描述（待优化）
4. ⏳ **重新测试**：修复后重新运行测试

## ✅ 已完成的修复

### 1. 模式选择优化
- 特写/近景（参考强度 > 70%）现在直接使用 PuLID 模式，不使用解耦模式
- 解耦模式仅用于远景/中景（参考强度 < 70%）

### 2. 人脸验证优化
- 解耦模式：在最终图像上进行人脸验证（身份注入后）
- PuLID 模式：在生成后立即验证

### 3. FluxWrapper 返回格式修复
- 修复了 FluxWrapper 的返回格式，使其兼容 diffusers pipeline 接口

