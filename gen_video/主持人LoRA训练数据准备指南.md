# 主持人 LoRA 训练数据准备指南

## 📊 图片数量建议

### ✅ **推荐配置：20-30 张（最佳平衡）**

- **最少：15 张**（效果一般，但可以快速测试）
- **推荐：20-30 张**（效果最好，训练时间适中）
- **最多：50 张**（效果提升有限，训练时间翻倍）

**为什么 20-30 张最合适？**
- 足够覆盖不同角度、表情、服装
- 训练时间适中（1-2 小时）
- 不容易过拟合
- 效果稳定

---

## 🎯 图片类型分布建议

### **20 张图片的分配：**

| 类型 | 数量 | 说明 |
|------|------|------|
| **正面半身** | 5-6 张 | 标准主持人形象，不同表情 |
| **正面全身** | 3-4 张 | 展示服装和整体形象 |
| **侧面/45度角** | 3-4 张 | 增加角度多样性 |
| **不同服装** | 3-4 张 | 正装、商务装等 |
| **不同表情** | 3-4 张 | 微笑、严肃、温和等 |
| **不同背景** | 2-3 张 | 纯色、演播室、户外等 |

### **30 张图片的分配：**

在 20 张基础上，增加：
- 更多角度变化（2-3 张）
- 更多表情变化（2-3 张）
- 更多服装变化（2-3 张）
- 不同光线条件（2-3 张）

---

## 📝 提示词模板（每张图片）

### **命名规则：**
```
_repeat_10_提示词.jpg
```

**`_repeat_10_` 表示这张图片在训练中重复 10 次**

### **提示词结构：**
```
[触发词] + [性别] + [职业] + [风格] + [表情] + [服装] + [角度] + [背景]
```

---

## 🎨 具体提示词示例（20 张）

### **1. 正面半身（5-6 张）**

```
_repeat_10_科普主持人，男性，专业形象，微笑，正式着装，正面，演播室背景.jpg
_repeat_10_科普主持人，男性，专业形象，温和表情，商务正装，正面半身，纯色背景.jpg
_repeat_10_科普主持人，男性，专业形象，自信微笑，正式西装，正面，柔和光线.jpg
_repeat_10_科普主持人，男性，专业形象，亲和力，正式着装，正面，专业摄影.jpg
_repeat_10_科普主持人，男性，专业形象，自然微笑，商务正装，正面，高清.jpg
_repeat_10_科普主持人，男性，专业形象，正式表情，正装，正面，专业打光.jpg
```

### **2. 正面全身（3-4 张）**

```
_repeat_10_科普主持人，男性，专业形象，微笑，正式西装，全身，演播室.jpg
_repeat_10_科普主持人，男性，专业形象，温和，商务正装，全身，纯色背景.jpg
_repeat_10_科普主持人，男性，专业形象，自信，正式着装，全身，专业摄影.jpg
_repeat_10_科普主持人，男性，专业形象，亲和，正装，全身，高清.jpg
```

### **3. 侧面/45度角（3-4 张）**

```
_repeat_10_科普主持人，男性，专业形象，微笑，正式着装，侧面，演播室.jpg
_repeat_10_科普主持人，男性，专业形象，温和，商务正装，45度角，纯色背景.jpg
_repeat_10_科普主持人，男性，专业形象，自信，正式西装，侧面，专业摄影.jpg
_repeat_10_科普主持人，男性，专业形象，自然，正装，45度角，高清.jpg
```

### **4. 不同服装（3-4 张）**

```
_repeat_10_科普主持人，男性，专业形象，微笑，深色西装，正面，演播室.jpg
_repeat_10_科普主持人，男性，专业形象，温和，浅色商务装，正面，纯色背景.jpg
_repeat_10_科普主持人，男性，专业形象，自信，正式衬衫，正面，专业摄影.jpg
_repeat_10_科普主持人，男性，专业形象，亲和，商务休闲装，正面，高清.jpg
```

### **5. 不同表情（3-4 张）**

```
_repeat_10_科普主持人，男性，专业形象，严肃表情，正式着装，正面，演播室.jpg
_repeat_10_科普主持人，男性，专业形象，温和微笑，商务正装，正面，纯色背景.jpg
_repeat_10_科普主持人，男性，专业形象，自信表情，正式西装，正面，专业摄影.jpg
_repeat_10_科普主持人，男性，专业形象，亲和微笑，正装，正面，高清.jpg
```

### **6. 不同背景（2-3 张）**

```
_repeat_10_科普主持人，男性，专业形象，微笑，正式着装，正面，演播室背景.jpg
_repeat_10_科普主持人，男性，专业形象，温和，商务正装，正面，纯色背景.jpg
_repeat_10_科普主持人，男性，专业形象，自信，正式西装，正面，户外自然光.jpg
```

---

## 🎯 触发词（Trigger Word）说明

### **什么是触发词？**
触发词是在生成时用来激活 LoRA 的关键词。

### **推荐触发词：**
- `科普主持人`（中文，推荐）
- `science host`（英文）
- `科普男主持人`（更具体）

### **使用方法：**
生成时在提示词中包含触发词：
```
科普主持人，专业形象，微笑，正式着装
```

---

## 📋 完整数据准备清单

### **步骤 1：收集/生成图片**

**选项 A：使用现有照片**
- 选择 20-30 张高质量照片
- 确保人脸清晰、光线均匀
- 分辨率至少 1024x1024

**选项 B：使用 AI 生成**
- 使用 Flux.1 或 Midjourney 生成
- 提示词参考上面的模板
- 确保风格一致

### **步骤 1.5：图片预处理（重要！）**

**✅ 必须统一尺寸：所有图片必须是相同尺寸**

#### **推荐尺寸：1024x1024（1:1 正方形）**

**为什么推荐 1:1？**
- ✅ 训练最稳定（所有图片统一比例）
- ✅ 适合人脸/人物训练（主体居中）
- ✅ 避免变形（不需要裁剪或拉伸）
- ✅ 显存占用适中（1024x1024 是标准尺寸）

#### **其他可选尺寸（如果必须）：**
- `1024x768`（4:3，横屏）
- `768x1024`（3:4，竖屏）
- `1280x1280`（更高分辨率，但训练更慢）

**⚠️ 重要：所有图片必须使用相同的尺寸！**

#### **预处理方法：**

**方法 1：使用 Python 脚本（推荐）**

已提供 `preprocess_training_images.py` 脚本，支持：
- ✅ 自动统一尺寸为 1024x1024
- ✅ 保持宽高比，居中放置
- ✅ **自动裁剪水印**（右下角豆包水印等）

**基本使用：**
```bash
python preprocess_training_images.py \
    --input train_data/host_person_raw \
    --output train_data/host_person
```

**去除右下角水印（豆包水印）：**
```bash
# 裁剪底部 100 像素，右侧 100 像素（根据实际水印大小调整）
python preprocess_training_images.py \
    --input train_data/host_person_raw \
    --output train_data/host_person \
    --crop-bottom 100 \
    --crop-right 100
```

**参数说明：**
- `--input`: 原始图片目录
- `--output`: 输出目录
- `--size`: 目标尺寸（默认 1024 1024）
- `--crop-bottom`: 裁剪底部像素数（去除水印）
- `--crop-right`: 裁剪右侧像素数（去除水印）
- `--bg`: 背景颜色 RGB（默认 255 255 255 白色）

**如何确定裁剪尺寸？**
1. 打开一张有水印的图片
2. 查看右下角水印的宽度和高度
3. 设置 `--crop-bottom` 和 `--crop-right` 参数
4. 例如：水印在右下角 100x50 像素区域，设置 `--crop-bottom 50 --crop-right 100`

**方法 2：使用 ImageMagick（命令行）**

```bash
# 批量处理所有图片为 1024x1024
cd train_data/host_person_raw

for img in *.jpg *.png; do
    convert "$img" \
        -resize "1024x1024^" \
        -gravity center \
        -extent 1024x1024 \
        -background white \
        "../host_person/$img"
done
```

**方法 3：使用在线工具或 Photoshop**
- 批量处理为 1024x1024
- 保持宽高比，居中放置
- 空白区域填充白色或模糊背景

#### **预处理注意事项：**

1. **保持宽高比**
   - ✅ 缩放时保持原始宽高比（避免变形）
   - ✅ 空白区域用白色或模糊背景填充

2. **居中放置**
   - ✅ 人物/人脸居中
   - ✅ 确保主体完整可见

3. **质量设置**
   - ✅ 保存时使用高质量（quality=95）
   - ✅ 避免过度压缩

4. **检查结果**
   - ✅ 所有图片都是 1024x1024
   - ✅ 人物/人脸清晰可见
   - ✅ 没有明显变形

### **步骤 2：重命名文件**

使用上面的提示词模板重命名每张图片：
```bash
# 示例
mv image1.jpg "_repeat_10_科普主持人，男性，专业形象，微笑，正式着装，正面，演播室背景.jpg"
```

### **步骤 3：整理目录结构**

```
train_data/
  host_person/
    _repeat_10_科普主持人，男性，专业形象，微笑，正式着装，正面，演播室背景.jpg
    _repeat_10_科普主持人，男性，专业形象，温和表情，商务正装，正面半身，纯色背景.jpg
    ...
```

### **步骤 4：验证数据**

- ✅ **所有图片都是 1024x1024（必须统一！）**
- ✅ 文件名包含完整的提示词
- ✅ 图片质量清晰，人脸可见
- ✅ 风格统一（都是科普主持人风格）
- ✅ 人物/人脸居中，无变形

---

## 🔧 快速生成脚本（可选）

如果需要批量生成训练图片，可以使用以下脚本：

```python
# generate_training_data.py
from model_manager import ModelManager
from pathlib import Path

manager = ModelManager()

# 提示词列表
prompts = [
    "科普主持人，男性，专业形象，微笑，正式着装，正面，演播室背景",
    "科普主持人，男性，专业形象，温和表情，商务正装，正面半身，纯色背景",
    # ... 添加所有提示词
]

output_dir = Path("train_data/host_person")
output_dir.mkdir(parents=True, exist_ok=True)

for i, prompt in enumerate(prompts):
    print(f"生成第 {i+1}/{len(prompts)} 张: {prompt}")
    
    # 生成图像
    image = manager.generate(
        task="host_face",
        prompt=prompt,
        width=1024,
        height=1024,
        seed=42 + i  # 不同种子，生成不同图片
    )
    
    # 保存（带提示词）
    filename = f"_repeat_10_{prompt}.jpg"
    image.save(output_dir / filename)
    print(f"  ✅ 已保存: {filename}")

print("✅ 所有训练数据生成完成！")
```

---

## ⚠️ 注意事项

### **1. 图片质量要求**
- ✅ 分辨率：至少 1024x1024（推荐 1024x1024 或 1280x1280）
- ✅ 清晰度：人脸清晰，无模糊
- ✅ 光线：均匀，无强烈阴影
- ✅ 背景：简洁，不干扰主体

### **2. 提示词要求**
- ✅ 必须包含触发词（如"科普主持人"）
- ✅ 描述准确（与实际图片匹配）
- ✅ 风格统一（都是专业、正式风格）
- ✅ 避免矛盾描述（如"微笑"和"严肃"不能同时出现）

### **3. 数据多样性**
- ✅ 不同角度（正面、侧面、45度）
- ✅ 不同表情（微笑、严肃、温和）
- ✅ 不同服装（但都是正式风格）
- ✅ 不同背景（但都是专业场景）

### **4. 避免的问题**
- ❌ 不要使用风格差异很大的图片
- ❌ 不要使用模糊、低质量的图片
- ❌ 不要使用提示词不匹配的图片
- ❌ 不要使用过多重复的图片（虽然会重复，但内容要不同）

---

## 📊 数据质量检查清单

在开始训练前，检查：

- [ ] 图片数量：20-30 张
- [ ] 图片分辨率：≥ 1024x1024
- [ ] 图片质量：清晰、无模糊
- [ ] 提示词：每张都有完整提示词
- [ ] 触发词：所有提示词都包含"科普主持人"
- [ ] 风格统一：都是专业、正式风格
- [ ] 角度多样：正面、侧面、45度都有
- [ ] 表情多样：微笑、严肃、温和都有
- [ ] 文件命名：符合 `_repeat_10_提示词.jpg` 格式

---

## 🚀 下一步

数据准备完成后：

1. **使用 Kohya_ss 训练**
   - 参考 `LoRA训练主持人指南.md`
   - 训练 500-1000 步

2. **测试 LoRA**
   - 加载训练好的 LoRA
   - 使用触发词生成测试图像

3. **集成到系统**
   - 在 `model_manager.py` 中配置 `lora_path`
   - 重启 API 服务

---

## 💡 提示

- **如果图片不够 20 张**：可以先用 15 张快速测试，效果可以接受后再补充
- **如果图片超过 30 张**：建议筛选出最优质的 20-30 张，太多可能过拟合
- **如果生成效果不理想**：检查提示词是否准确，图片质量是否足够

