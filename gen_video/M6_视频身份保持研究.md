# 视频身份保持研究 - M6 里程碑

> 创建日期: 2025-12-17
> 更新日期: 2025-12-17 21:28
> 目标: 实现视频生成时的角色身份一致性保持

## 📋 方案选型结论

### ✅ 最终选择：ID-Animator

| 评估维度 | ID-Animator | HunyuanCustom |
|----------|-------------|---------------|
| **稳定性** | ✅ 论文验证，社区广泛使用 | ❌ 新发布，稳定性未知 |
| **可控性** | ✅ 强度可调，策略灵活 | ❌ 整体式，难以调节 |
| **可解释性** | ✅ Face Adapter 机制清晰 | ❌ 端到端黑盒 |
| **可规模化** | ✅ 轻量 5.5GB，3090 可跑 | ❌ 191GB，需 80GB 显存 |

**结论**：~~HunyuanCustom~~ → **ID-Animator**

---

## 🎯 ID-Animator 技术架构

### 核心原理

```
参考图 → Face Encoder → ID Embedding → AnimateDiff → 身份一致视频
         (轻量级)       (注入 T2V)        (成熟稳定)
```

### 关键特性

1. **零样本** - 单张参考图即可，无需微调
2. **轻量级** - Face Adapter 约 77MB，完整 ~5.5GB
3. **兼容性强** - 与 AnimateDiff 无缝集成
4. **可控** - 身份强度可调（推荐 0.5-0.8）

### 模型组件

| 组件 | 大小 | 说明 |
|------|------|------|
| SD 1.5 Base | ~4GB | 基础文生图模型 |
| AnimateDiff Motion | ~1.5GB | 动画模块 |
| Face Adapter | ~77MB | ID-Animator 核心 |
| **总计** | **~5.5GB** | 单张 3090 可运行 |

---

## 📝 集成方案

### 方案 A：直接替换（推荐）

将 ID-Animator 作为视频生成的主要方案，替换或补充 HunyuanVideo。

```python
# 流程
参考图 → ID-Animator → 身份一致视频
         ↓
    PuLID 提取身份嵌入（可复用）
         ↓
    AnimateDiff 生成视频
         ↓
    VideoIdentityAnalyzer 验证
```

### 方案 B：验证 + 修复

保持 HunyuanVideo 生成，ID-Animator 用于验证和帧修复。

```python
# 流程
参考图 → HunyuanVideo → 视频
                ↓
    VideoIdentityAnalyzer 检测漂移
                ↓
    漂移帧 → ID-Animator 修复 → 最终视频
```

**推荐方案 A**：更简洁，效果更可控。

---

## 🔧 实现计划

### 第一阶段：模型下载与测试（1天）

1. 下载 ID-Animator 模型
2. 测试基础功能
3. 验证与现有代码的兼容性

### 第二阶段：集成开发（2天）

1. 创建 `IDAnimatorEngine` 类
2. 集成到 `enhanced_image_generator.py`
3. 添加身份强度自动调节

### 第三阶段：端到端测试（1天）

1. 多场景测试
2. 与 `VideoIdentityAnalyzer` 联动验证
3. 优化参数

---

## 📁 资源链接

### GitHub
- https://github.com/ID-Animator/ID-Animator

### HuggingFace
- https://huggingface.co/spaces/ID-Animator/ID-Animator
- https://huggingface.co/ID-Animator/ID-Animator

### 论文
- ID-Animator: Zero-Shot Identity-Preserving Human Video Generation (arXiv:2404)

---

## 🔄 与现有系统集成

### 复用现有组件

| 现有组件 | 复用方式 |
|----------|----------|
| PuLID Face Encoder | 可复用身份嵌入提取 |
| InsightFace | ID-Animator 也使用 |
| VideoIdentityAnalyzer | 验证生成效果 |
| MemoryManager | 管理模型加载 |

### 新增组件

| 新组件 | 功能 |
|--------|------|
| IDAnimatorEngine | ID-Animator 封装 |
| id_animator_config | 配置管理 |

---

## ⚙️ 配置参数

```yaml
# config.yaml 新增配置
video:
  id_animator:
    enabled: true
    model_path: "models/ID-Animator"
    # 身份保持强度（推荐 0.5-0.8，越高越像参考图但可能牺牲自然度）
    id_strength: 0.7
    # 自动调节策略
    auto_adjust: true
    # 最大尝试次数
    max_retries: 3
```

---

## 📊 预期效果

| 指标 | 当前 (HunyuanVideo) | 目标 (ID-Animator) |
|------|---------------------|---------------------|
| 平均帧相似度 | 未知（待测） | ≥ 0.70 |
| 身份漂移率 | 未知（待测） | ≤ 5% |
| 生成速度 | ~30s/视频 | ~20s/视频 |
| 显存占用 | ~25GB | ~12GB |

---

*下一步：下载 ID-Animator 模型并开始集成*
