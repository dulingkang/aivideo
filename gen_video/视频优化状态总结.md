# 视频优化状态总结

## ✅ 已实现的优化

### 1. 基础参数优化（config.yaml）
- **num_frames**: `120` (从75提高到120，= duration * fps = 5 * 24)
- **fps**: `24` (从15提高到24，标准视频帧率)
- **width/height**: `1280x768` (从1024x576提高，提升人脸清晰度)
- **max_frames**: `384` (从225提高到384，约16秒@24fps)
- **num_inference_steps**: `40` (从60降到40，对运动自然度无影响，但速度更快)

### 2. 运动参数优化（config.yaml）
- **motion_bucket_id**: `1.5` (从2降到1.5，最自然的雾气飘动，避免过度运动和反向拉回)
- **noise_aug_strength**: `0.00025` (从0.0004降到0.00025，最自然的雾气飘动，避免过度运动和抖动)
- **decode_chunk_size**: `8` (从10降到8，SVD-XT最稳定范围，避免补帧抖动和动作反向)

### 3. 视频编码优化（config.yaml）
- **video_crf**: `18` (从20提高到18，提升视频质量)
- **video_preset**: `medium` (平衡编码速度和质量)
- **video_bitrate**: `10000k` (从8000k提高到10000k)
- **upscale.enabled**: `true` (启用Real-ESRGAN超分)

### 4. 场景自适应优化（video_generator.py）

#### 4.1 雾气/云场景检测
代码会自动检测包含以下关键词的场景：
- 英文: `mist`, `fog`, `cloud`, `smoke`, `haze`, `vapor`, `steam`
- 中文: `雾气`, `云雾`, `云`, `烟雾`, `水汽`, `蒸汽`, `薄雾`, `浓雾`

#### 4.2 雾气/云场景参数调整
**当前实现**（可能与用户期望不符）：
- **svd-image-to-video**: 
  - `motion_bucket_id = 3` (提高到3，增强连贯性)
  - `noise_aug_strength = 0.025` (提高到0.025，增强平滑度)
  - `decode_chunk_size = 12` (至少12，增强连贯性)
- **svd-xt**: 
  - `motion_bucket_id = 2` (保持为2，svd-xt最大为2)
  - `noise_aug_strength = 0.0005` (提高到最大值0.0005)
  - `decode_chunk_size = 12` (至少12，增强连贯性)

**用户期望**（根据之前的反馈）：
- **motion_bucket_id**: `1.5` (不超过2)
- **noise_aug_strength**: `0.0001 ~ 0.00025`
- **decode_chunk_size**: `6 ~ 8`

#### 4.3 静态场景处理
- 检测到完全静态场景（如"lying still"）时，使用静态图像动画（Ken Burns效果）
- 避免SVD生成导致的人物微动

## ⚠️ 潜在问题

### 问题1: 雾气场景参数与用户期望不符
**当前代码**在检测到雾气/云场景时，会**强制覆盖**配置中的默认值（`motion_bucket_id=1.5`, `noise_aug_strength=0.00025`），改为更高的值（`motion_bucket_id=3`, `noise_aug_strength=0.025`）。

这可能导致：
- 雾气飘动过大
- 反向拉回效果
- 背景抖动

**建议修复**：
- 对于雾气/云场景，使用**更保守的参数**（符合用户期望）：
  - `motion_bucket_id = 1.5` (不超过2)
  - `noise_aug_strength = 0.00025` (不超过0.0005)
  - `decode_chunk_size = 8` (不超过10)

### 问题2: 默认参数可能被覆盖
代码中有多处逻辑会调整参数，可能导致配置中的优化值被覆盖。

## 📋 优化检查清单

- [x] **基础参数优化**: num_frames, fps, 分辨率已优化
- [x] **运动参数优化**: motion_bucket_id, noise_aug_strength, decode_chunk_size已优化
- [x] **视频编码优化**: CRF, preset, bitrate已优化
- [x] **场景自适应**: 雾气/云场景检测已实现
- [ ] **雾气场景参数**: 需要调整以符合用户期望（当前值可能过高）
- [x] **静态场景处理**: Ken Burns效果已实现
- [x] **人脸清晰度**: 分辨率提升，upscale启用

## 🔧 建议的修复

1. **调整雾气/云场景参数**：
   - 将 `motion_bucket_id` 从 `3` 改为 `1.5`（svd-image-to-video）
   - 将 `noise_aug_strength` 从 `0.025` 改为 `0.00025`（svd-image-to-video）
   - 将 `decode_chunk_size` 从 `12` 改为 `8`（所有模型）

2. **确保配置值不被覆盖**：
   - 只在用户未明确指定参数时才使用场景自适应调整
   - 优先使用配置中的默认值

## 📊 当前配置摘要

```yaml
video:
  num_frames: 120          # ✅ 已优化
  fps: 24                   # ✅ 已优化
  width: 1280               # ✅ 已优化
  height: 768               # ✅ 已优化
  motion_bucket_id: 1.5     # ✅ 已优化（但可能被代码覆盖）
  noise_aug_strength: 0.00025 # ✅ 已优化（但可能被代码覆盖）
  decode_chunk_size: 8      # ✅ 已优化（但可能被代码覆盖）
  num_inference_steps: 40   # ✅ 已优化
  max_frames: 384           # ✅ 已优化

composition:
  video_crf: 18             # ✅ 已优化
  video_preset: medium      # ✅ 已优化
  video_bitrate: 10000k     # ✅ 已优化
  upscale:
    enabled: true           # ✅ 已优化
```

