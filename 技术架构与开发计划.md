# 技术架构与开发计划

## 📋 目录

1. [整体技术架构](#整体技术架构)
2. [小说推文实现现状](#小说推文实现现状)
3. [核心组件详解](#核心组件详解)
4. [开发计划](#开发计划)
5. [技术路线图](#技术路线图)

---

## 整体技术架构

### 系统概览

```
┌─────────────────────────────────────────────────────────────┐
│                    AI视频生成系统                            │
│              (小说推文 / 科普视频 / 短剧)                      │
└─────────────────────────────────────────────────────────────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
    ┌───▼───┐          ┌───▼───┐          ┌───▼───┐
    │ 图像  │          │ 视频  │          │ 音频  │
    │ 生成  │          │ 生成  │          │ 生成  │
    └───┬───┘          └───┬───┘          └───┬───┘
        │                   │                   │
        └───────────────────┼───────────────────┘
                            │
                    ┌───────▼───────┐
                    │  视频合成器    │
                    │ (字幕/BGM/拼接)│
                    └───────┬───────┘
                            │
                    ┌───────▼───────┐
                    │   最终视频     │
                    └───────────────┘
```

### 核心模块

#### 1. 图像生成模块 (`ImageGenerator`)

**位置**: `gen_video/image_generator.py`

**功能**:
- 支持多种图像生成引擎（Flux、SDXL、InstantID、SD3-Turbo）
- 智能引擎选择（Execution Planner v2）
- 角色一致性保证（Character Anchor + IP-Adapter）
- LoRA 风格控制

**引擎矩阵**:

| 引擎 | 用途 | 特点 | 显存需求 |
|------|------|------|----------|
| **FLUX.1** | 叙事/氛围镜头 | 世界观一致性强，支持长prompt | 8-12GB |
| **SDXL** | 过渡人物镜头 | 风格LoRA支持好 | 6-8GB |
| **InstantID** | 情绪/表情镜头 | 人脸锁定精确 | 8-10GB |
| **SD3-Turbo** | 批量生成 | 速度快 | 4-6GB |

**Execution Planner v2** (`model_selector.py`):
- 根据场景特征自动选择引擎
- 三类镜头分流（A/B/C类）
- 人设锚点图引用管理

#### 2. 视频生成模块 (`VideoGenerator`)

**位置**: `gen_video/video_generator.py`

**功能**:
- 图生视频（Image-to-Video）
- 支持多种视频模型
- 显存优化（CPU offload、attention slicing）

**模型矩阵**:

| 模型 | 用途 | 质量 | 速度 | 显存需求 |
|------|------|------|------|----------|
| **HunyuanVideo 1.5** | 高端场景（科普/政府/企业） | ⭐⭐⭐⭐⭐ | 20-30分钟/30步 | 20-30GB |
| **CogVideoX-5B** | 量产场景（短剧/推文/电商） | ⭐⭐⭐⭐ | 2-5分钟/50步 | 12-18GB |
| **Mochi 1** | 产品广告特效 | ⭐⭐⭐⭐⭐ | 待集成 | 待定 |

**当前状态**:
- ✅ HunyuanVideo 1.5 已集成（480p/720p）
- ⏳ CogVideoX-5B 待集成（计划中）
- ⏳ Mochi 1 待集成（计划中）

#### 3. 音频生成模块 (`TTSGenerator`)

**位置**: `gen_video/tts_generator.py`

**功能**:
- 文本转语音（TTS）
- 声音克隆（Zero-shot）
- 多语言支持

**模型**:
- **CosyVoice**: 主要TTS引擎，支持声音克隆
- **ChatTTS**: 备选方案

#### 4. 视频合成模块 (`VideoComposer`)

**位置**: `gen_video/video_composer.py`

**功能**:
- 视频拼接
- 字幕生成和叠加
- 背景音乐（BGM）合成
- 音频同步

---

## 小说推文实现现状

### 工作流程

```
小说文本 / JSON脚本
    ↓
场景解析 (script_parser.py)
    ↓
Execution Planner v2 (model_selector.py)
    ↓
┌─────────────────────────────────────┐
│  图像生成 (ImageGenerator)           │
│  - Flux/SDXL/InstantID 自动选择      │
│  - Character Anchor 引用            │
│  - IP-Adapter 形象一致性             │
└───────────────┬───────────────────────┘
                ↓
        场景图像 (PNG)
                ↓
┌─────────────────────────────────────┐
│  视频生成 (VideoGenerator)          │
│  - HunyuanVideo 1.5 (当前)          │
│  - CogVideoX-5B (计划中)            │
└───────────────┬───────────────────────┘
                ↓
        视频片段 (MP4)
                ↓
┌─────────────────────────────────────┐
│  音频生成 (TTSGenerator)            │
│  - CosyVoice 配音                   │
│  - 声音克隆                         │
└───────────────┬───────────────────────┘
                ↓
        音频文件 (WAV)
                ↓
┌─────────────────────────────────────┐
│  视频合成 (VideoComposer)           │
│  - 视频拼接                         │
│  - 字幕叠加                         │
│  - BGM合成                          │
└───────────────┬───────────────────────┘
                ↓
          最终视频
```

### 核心特性

#### 1. ✅ 三类镜头分流系统

**A类：叙事/氛围镜头**
- **引擎**: FLUX.1
- **禁用**: InstantID / LoRA
- **特点**: 世界观一致性 > 人脸一致性
- **适用**: wide + top_down + lying, 远景, 剪影
- **参考**: 人设锚点图（IP-Adapter）

**B类：过渡人物镜头**
- **引擎**: SDXL
- **特点**: 风格LoRA支持
- **适用**: 中景, 站立, 走路, 回头
- **参考**: 人设锚点图

**C类：情绪/表情镜头**
- **引擎**: InstantID
- **特点**: 人脸锁定精确
- **适用**: 特写, 对话, 表情
- **参考**: 人设锚点图（face_reference）

#### 2. ✅ 人设锚点图系统

**核心规则**: `hanli_anchor.png = hanli_mid.jpg`（直接复制，不生成）

**作用**:
- 整个视频的"DNA"
- 所有场景统一引用
- 确保形象一致性

**实现**:
- 脚本: `generate_character_anchor.py`
- 路径: `gen_video/character_anchors/{character_id}_anchor.png`
- 引用: Execution Planner 自动检测并使用

#### 3. ✅ Execution Planner v2

**功能**:
- 自动分析场景特征（camera.shot, camera.angle, character.pose）
- 智能选择引擎（A/B/C类分流）
- 管理人设锚点图引用
- 优化生成参数（分辨率、步数、IP-Adapter scale）

**决策逻辑**:
```python
# A类检测
is_wide_topdown_lying = (
    camera_shot == "wide" and 
    camera_angle == "top_down" and 
    character_pose in ["lying_motionless", "lying"]
)

# B类检测
is_transition_shot = (
    camera_shot == "medium" and
    character_pose in ["standing", "walking", "turning"]
)

# C类检测
is_emotion_shot = (
    camera_shot in ["close", "medium"] and
    character_pose in ["thinking", "pain", "casting"]
)
```

#### 4. ✅ Prompt 构建系统

**位置**: `gen_video/prompt/builder.py`

**功能**:
- v2 JSON 格式解析
- 语义化 prompt 构建（FLUX专用）
- 物理接触描述（lying pose优化）
- 相机运动语义转换（video → static frame）

**关键优化**:
- **Lying pose**: 使用物理接触描述而非 `NOT sitting`
- **Camera movement**: 单帧生成时转换为 `static`
- **FLUX prompt**: 自然语言句子，支持512+ tokens

#### 5. ✅ 图像质量优化

**针对 wide shot 的优化**:
- 分辨率: 最低 1536x1536
- 推理步数: 至少 40 步
- IP-Adapter scale: 0.9（避免过度融合）

### 当前状态

#### ✅ 已完成

1. **图像生成流水线**
   - ✅ Flux/SDXL/InstantID 多引擎支持
   - ✅ Execution Planner v2 自动选择
   - ✅ Character Anchor 系统
   - ✅ IP-Adapter 集成
   - ✅ 三类镜头分流
   - ✅ Prompt 优化（lying pose, camera movement）

2. **视频生成流水线**
   - ✅ HunyuanVideo 1.5 集成
   - ✅ 显存优化（CPU offload, attention slicing）
   - ✅ 风格配置系统

3. **音频生成流水线**
   - ✅ CosyVoice 集成
   - ✅ 声音克隆支持

4. **视频合成流水线**
   - ✅ 视频拼接
   - ✅ 字幕生成
   - ✅ BGM合成

#### ⏳ 进行中

1. **图像质量优化**
   - ⏳ wide shot 分辨率优化（已实现，待测试）
   - ⏳ IP-Adapter scale 调整（已实现，待测试）

#### 📋 计划中

1. **CogVideoX-5B 集成**
   - 量产产线支持
   - 批量生成优化

2. **Mochi 1 集成**
   - 产品广告特效支持

---

## 核心组件详解

### 1. Execution Planner v2 (`model_selector.py`)

**职责**: 根据场景特征自动选择最适合的生成引擎和参数

**输入**: v2 JSON 场景描述
```json
{
  "camera": {
    "shot": "wide",
    "angle": "top_down"
  },
  "character": {
    "present": true,
    "pose": "lying_motionless"
  }
}
```

**输出**: 引擎决策
```python
{
  "engine": "flux1",
  "mode": "cinematic",
  "use_character_anchor": True,
  "use_semantic_prompt": True,
  "disable_character_lora": True,
  "disable_style_lora": True
}
```

### 2. Prompt Builder (`prompt/builder.py`)

**职责**: 构建高质量的生成提示词

**功能**:
- v2 JSON 字段解析
- 语义化 prompt 构建（FLUX）
- 物理接触描述（lying pose）
- 相机运动转换

**关键方法**:
- `_build_semantic_prompt_for_flux()`: FLUX 专用语义化 prompt
- `_convert_camera_v2_to_string()`: 相机描述转换
- `build()`: 主构建方法

### 3. Image Generator (`image_generator.py`)

**职责**: 图像生成的统一接口

**功能**:
- 多引擎支持（Flux/SDXL/InstantID）
- Character Anchor 引用
- IP-Adapter 集成
- LoRA 管理

**关键方法**:
- `generate_image()`: 主生成方法
- `_generate_image_flux_simple()`: FLUX 生成
- `_generate_image_sdxl()`: SDXL 生成
- `_generate_image_instantid()`: InstantID 生成

### 4. Video Generator (`video_generator.py`)

**职责**: 视频生成的统一接口

**功能**:
- HunyuanVideo 1.5 支持
- 显存优化
- 风格配置

**关键方法**:
- `generate_video()`: 主生成方法
- `_generate_video_hunyuanvideo()`: HunyuanVideo 生成

---

## 开发计划

### 短期计划（1-2周）

#### 1. ✅ 图像质量优化（已完成）

**任务**:
- ✅ 提高 wide shot 分辨率（1536x1536）
- ✅ 提高推理步数（至少40步）
- ✅ 降低 IP-Adapter scale（0.9）

**状态**: ✅ 已完成，待测试验证

#### 2. ⏳ CogVideoX-5B 集成（进行中）

**任务**:
- [ ] 检查模型下载状态
- [ ] 实现模型加载方法
- [ ] 实现视频生成方法
- [ ] 显存优化
- [ ] 测试验证

**时间**: 2-3天

**代码位置**:
- `gen_video/video_generator.py` - 添加 CogVideoX 支持
- `gen_video/config.yaml` - 添加配置

#### 3. ⏳ 双模型路由系统（计划中）

**任务**:
- [ ] 创建模型路由器（`ModelRouter`）
- [ ] 实现自动选择逻辑
- [ ] 场景类型映射配置
- [ ] 用户等级映射配置

**时间**: 1-2天

**路由规则**:
```python
# 高端场景 → HunyuanVideo
if scene_type in ['government', 'enterprise', 'scientific']:
    model = 'hunyuanvideo'
# 量产场景 → CogVideoX
elif scene_type in ['novel', 'drama', 'daily']:
    model = 'cogvideox'
```

### 中期计划（1-3个月）

#### 1. 短剧推文自动机

**任务**:
- [ ] 文本到分镜的 LLM 接口
- [ ] 分镜到场景 JSON 转换
- [ ] 完整工作流集成
- [ ] 批量生成优化

**工作流**:
```
输入文本 → LLM分镜 → 场景JSON → Flux生成图像 → 
InstantID锁脸 → CogVideoX生成视频 → Whisper字幕 → 
视频合成 → 输出
```

#### 2. 角色一致性系统增强

**任务**:
- [ ] InstantID/PuLID 集成优化
- [ ] 角色库管理
- [ ] 多场景角色一致性保证

#### 3. 用户分级系统

**任务**:
- [ ] 用户等级管理
- [ ] 模型访问权限控制
- [ ] 使用量统计和限制
- [ ] 计费系统接口

**用户等级**:
```python
USER_TIERS = {
    'free': {
        'model': 'cogvideox',
        'max_duration': 6,
        'resolution': '720p',
        'daily_limit': 10
    },
    'professional': {
        'model': 'cogvideox',
        'max_duration': 12,
        'resolution': '1080p',
        'daily_limit': 100
    },
    'enterprise': {
        'model': 'hunyuanvideo',
        'max_duration': 30,
        'resolution': '1080p',
        'daily_limit': 1000
    }
}
```

### 长期计划（3-6个月）

#### 1. 平台化

**任务**:
- [ ] 多租户支持
- [ ] API网关
- [ ] 负载均衡
- [ ] 监控和日志系统

#### 2. AI优化

**任务**:
- [ ] 自动风格推荐
- [ ] 智能参数调整
- [ ] 质量评估系统
- [ ] 自动优化建议

#### 3. 商业化功能

**任务**:
- [ ] 用户权限管理
- [ ] 计费系统
- [ ] 使用统计和报表
- [ ] 客户支持系统

---

## 技术路线图

### 2025年Q1（1-3月）

**目标**: 完成量产产线，实现短剧推文自动机

**里程碑**:
1. ✅ 图像生成流水线完善（已完成）
2. ⏳ CogVideoX-5B 集成（进行中）
3. ⏳ 双模型路由系统（计划中）
4. ⏳ 短剧推文自动机 MVP（计划中）

### 2025年Q2（4-6月）

**目标**: 商业化功能完善，用户分级系统

**里程碑**:
1. 用户分级系统
2. 计费系统
3. API完善
4. 前端集成

### 2025年Q3（7-9月）

**目标**: 平台化，多租户支持

**里程碑**:
1. 多租户支持
2. API网关
3. 负载均衡
4. 监控系统

### 2025年Q4（10-12月）

**目标**: AI优化，智能推荐

**里程碑**:
1. 自动风格推荐
2. 智能参数调整
3. 质量评估系统
4. 自动优化建议

---

## 关键技术决策

### 1. 三类镜头分流

**决策**: 根据场景特征自动选择引擎（A/B/C类）

**原因**:
- A类（叙事/氛围）需要世界观一致性 → FLUX
- B类（过渡人物）需要风格一致性 → SDXL + LoRA
- C类（情绪/表情）需要人脸一致性 → InstantID

**优势**:
- ✅ 每个场景使用最适合的引擎
- ✅ 避免"互相打架的生成范式"
- ✅ 形象一致性保证

### 2. 人设锚点图系统

**决策**: 直接复制参考图，不生成

**原因**:
- ✅ 100% 相似度（无失真）
- ✅ 简单可靠（避免生成质量问题）
- ✅ 工业界标准做法

**实现**:
- 所有场景统一引用同一张锚点图
- Execution Planner 自动管理引用

### 3. 双模型产线

**决策**: HunyuanVideo（高端）+ CogVideoX（量产）

**原因**:
- HunyuanVideo: 高质量，适合高端场景
- CogVideoX: 速度快，适合批量生成

**优势**:
- ✅ 成本优化（量产用低成本模型）
- ✅ 质量保证（高端用高质量模型）
- ✅ 灵活切换（根据场景自动选择）

---

## 文件结构

### 核心文件

```
gen_video/
├── image_generator.py          # 图像生成器（多引擎支持）
├── video_generator.py          # 视频生成器（HunyuanVideo）
├── tts_generator.py            # 音频生成器（CosyVoice）
├── video_composer.py           # 视频合成器
├── model_selector.py           # Execution Planner v2
├── prompt/
│   └── builder.py              # Prompt 构建器
├── config.yaml                 # 配置文件
└── main.py                     # 主程序
```

### 工具文件

```
gen_video/
├── generate_character_anchor.py # 人设锚点图生成
├── generate_novel_video.py     # 小说推文生成
└── utils/
    ├── style_validator.py      # 风格验证
    └── model_router.py         # 模型路由器（计划中）
```

### 文档文件

```
gen_video/
├── README_小说推文.md          # 小说推文工作流
├── CHARACTER_ANCHOR_USAGE.md   # 人设锚点图使用说明
├── 完整流水线开发总结.md        # 完整流水线总结
└── 双模型产线开发计划.md        # 双模型产线计划
```

---

## 总结

### 当前状态

✅ **已完成**:
- 图像生成流水线（多引擎支持）
- Execution Planner v2（智能引擎选择）
- Character Anchor 系统（形象一致性）
- 三类镜头分流（A/B/C类）
- Prompt 优化（lying pose, camera movement）
- 视频生成流水线（HunyuanVideo 1.5）
- 音频生成流水线（CosyVoice）
- 视频合成流水线

⏳ **进行中**:
- 图像质量优化（wide shot）
- CogVideoX-5B 集成

📋 **计划中**:
- 双模型路由系统
- 短剧推文自动机
- 用户分级系统
- 商业化功能

### 下一步行动

1. **立即**: 测试图像质量优化效果
2. **本周**: 完成 CogVideoX-5B 集成
3. **下周**: 实现双模型路由系统
4. **本月**: 开发短剧推文自动机 MVP

---

**最后更新**: 2025-01-XX  
**维护者**: 开发团队

